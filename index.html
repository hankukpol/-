<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œêµ­ê²½ì°°í•™ì› ì¡°ì§ ìš´ì˜ ë§¤ë‰´ì–¼ & ì—…ë¬´ ë¶„ì¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f5f5f4;
            /* Warm neutral background */
            color: #1c1917;
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #d6d3d1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a29e;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .tab-active {
            border-bottom: 2px solid #0f172a;
            color: #0f172a;
            font-weight: 700;
        }

        .org-line {
            position: absolute;
            background-color: #cbd5e1;
            z-index: 0;
        }

        /* Reporting Flow Animation */
        .flow-path {
            transition: all 0.5s ease;
        }

        .flow-active {
            background-color: #3b82f6;
            /* Blue for Routine */
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.5);
        }

        .flow-urgent {
            background-color: #ef4444;
            /* Red for TF/Urgent */
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
        }

        /* AI Loading Animation */
        .ai-loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(99, 102, 241, 0.3);
            border-radius: 50%;
            border-top-color: #6366f1;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <!-- Navigation -->
    <nav class="bg-white border-b border-stone-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <span class="text-xl font-bold text-slate-800 cursor-pointer"
                            onclick="loadView('dashboard')">ğŸ›ï¸ í•œêµ­ê²½ì°°í•™ì› ìš´ì˜ë³¸ë¶€</span>
                    </div>
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8" id="nav-container">
                        <!-- Nav items injected by JS -->
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <div id="sync-indicator" class="hidden md:block text-xs text-gray-500"></div>
                    <div id="ai-status" class="hidden md:block text-xs text-indigo-600 font-bold animate-pulse">âœ¨ Gemini
                        3.0</div>
                    <button onclick="openApiSettings()" class="text-stone-400 hover:text-stone-600" title="API ì„¤ì •">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                    <span class="text-sm text-stone-500 bg-stone-100 px-3 py-1 rounded-full">ì´ê´„ ë¶€ì›ì¥ ëª¨ë“œ</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-grow bg-stone-50 py-8 px-4 sm:px-6 lg:px-8 relative">
        <div id="content-area" class="max-w-7xl mx-auto">
            <!-- Content injected by JS -->
        </div>

        <!-- API Key Modal -->
        <div id="api-modal"
            class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
            <div class="relative mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">ğŸ”‘ ì‹œìŠ¤í…œ ì„¤ì •</h3>
                    <div class="mt-2 px-7 py-3">
                        <!-- Gemini API Key -->
                        <div class="mb-4">
                            <p class="text-sm text-gray-500 mb-2 text-left">
                                <strong>AI ê¸°ëŠ¥ (ì„ íƒ)</strong><br>
                                Google Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ë©´ AI ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </p>
                            <input type="password" id="api-key-input" class="w-full p-2 border rounded text-sm mb-2"
                                placeholder="Gemini API Key ì…ë ¥">
                            <a href="https://aistudio.google.com/app/apikey" target="_blank"
                                class="text-xs text-blue-500 hover:underline">API í‚¤ ë°œê¸‰ë°›ê¸° (ë¬´ë£Œ)</a>
                        </div>

                        <!-- Google Sheets Web App URL -->
                        <div class="mb-4 border-t pt-4">
                            <p class="text-sm text-gray-500 mb-2 text-left">
                                <strong>Google Sheets ë™ê¸°í™” (í•„ìˆ˜)</strong><br>
                                ì—¬ëŸ¬ ê¸°ê¸°ì—ì„œ ë°ì´í„°ë¥¼ ê³µìœ í•˜ë ¤ë©´ Web App URLì„ ì…ë ¥í•˜ì„¸ìš”.
                            </p>
                            <input type="text" id="sheets-url-input" class="w-full p-2 border rounded text-sm mb-2"
                                placeholder="https://script.google.com/macros/s/...">
                            <button onclick="testSheetsConnection()"
                                class="text-xs bg-green-100 text-green-700 px-3 py-1 rounded hover:bg-green-200 w-full">
                                ì—°ê²° í…ŒìŠ¤íŠ¸
                            </button>
                            <div id="sheets-test-result" class="text-xs mt-2 hidden"></div>
                        </div>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button onclick="saveSettings()"
                            class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-300">
                            ì €ì¥ ë° ì—°ê²°
                        </button>
                        <button onclick="closeApiSettings()"
                            class="mt-2 px-4 py-2 bg-gray-100 text-gray-700 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-200 focus:outline-none">
                            ë‹«ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-stone-200 mt-auto">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <p class="text-center text-sm text-stone-400">Korea Police Academy Internal Operation System V3.3 Standalone
            </p>
            <button onclick="resetAllData()" class="text-xs text-red-300 hover:text-red-500 underline">ë°ì´í„° ì´ˆê¸°í™”</button>
        </div>
    </footer>

    <script>
        // API Key Management
        let userApiKey = localStorage.getItem('gemini_api_key') || "";

        // Google Sheets Integration
        let sheetsWebAppUrl = localStorage.getItem('sheets_webapp_url') || "https://script.google.com/macros/s/AKfycbyegLIoTBOBzaJeukqv8-cx9lGCdsnHTEBObyk21EQoUfPx01xWT00FmZhUyDOlsEEPBA/exec";
        let syncStatus = { connected: false, syncing: false, lastSync: null };
        const sheetsProxyBase = '/.netlify/functions/sheets-proxy';

        function buildSheetsProxyUrl(action, webAppUrl) {
            const params = new URLSearchParams({
                url: webAppUrl || sheetsWebAppUrl,
                action
            });
            return `${sheetsProxyBase}?${params.toString()}`;
        }

        function openApiSettings() {
            document.getElementById('api-key-input').value = userApiKey;
            document.getElementById('sheets-url-input').value = sheetsWebAppUrl;
            document.getElementById('api-modal').classList.remove('hidden');
        }

        function closeApiSettings() {
            document.getElementById('api-modal').classList.add('hidden');
        }

        function saveSettings() {
            const key = document.getElementById('api-key-input').value.trim();
            const url = document.getElementById('sheets-url-input').value.trim();

            // Save API Key
            if (key) {
                userApiKey = key;
                localStorage.setItem('gemini_api_key', key);
            }

            // Save Sheets URL
            if (url) {
                sheetsWebAppUrl = url;
                localStorage.setItem('sheets_webapp_url', url);
                syncStatus.connected = true;
            }

            if (key || url) {
                alert("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                closeApiSettings();

                // Update UI status
                const status = document.getElementById('ai-status');
                if (status && key) status.classList.remove('hidden');

                // If Sheets URL is set, try to sync
                if (url) {
                    syncFromSheets();
                }
            } else {
                alert("ìµœì†Œí•œ í•˜ë‚˜ì˜ ì„¤ì •ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            }
        }

        async function testSheetsConnection() {
            const url = document.getElementById('sheets-url-input').value.trim();
            const resultDiv = document.getElementById('sheets-test-result');

            if (!url) {
                resultDiv.className = 'text-xs mt-2 text-red-600';
                resultDiv.innerText = 'âŒ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                resultDiv.classList.remove('hidden');
                return;
            }

            resultDiv.className = 'text-xs mt-2 text-blue-600';
            resultDiv.innerText = 'â³ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...';
            resultDiv.classList.remove('hidden');

            try {
                const response = await fetch(buildSheetsProxyUrl('getData', url));
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();

                if (data.error) {
                    resultDiv.className = 'text-xs mt-2 text-red-600';
                    resultDiv.innerText = `âŒ ì˜¤ë¥˜: ${data.error}`;
                } else {
                    resultDiv.className = 'text-xs mt-2 text-green-600';
                    resultDiv.innerText = 'âœ… ì—°ê²° ì„±ê³µ! ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.';
                }
            } catch (error) {
                resultDiv.className = 'text-xs mt-2 text-red-600';
                resultDiv.innerText = `âŒ ì—°ê²° ì‹¤íŒ¨: ${error.message}`;
            }
        }

        // --- Default Data Store ---
        const defaultAppData = {
            roles: [
                {
                    id: 'vice_director',
                    title: 'ì´ê´„ ë¶€ì›ì¥',
                    subtitle: 'COO (Chief Operating Officer)',
                    icon: 'ğŸ‘‘',
                    summary: 'ê·¸ë£¹ ì „ì²´ ì „ëµ ìˆ˜ë¦½, ëŒ€ì™¸ í˜‘ë ¥, ì¸ì‚¬ê¶Œ í–‰ì‚¬. ì‹¤ë¬´ì—ì„œ ë²—ì–´ë‚˜ ì„¤ê³„ì™€ ê°ë…ì— ì§‘ì¤‘.',
                    kpi: ['ë§¤ì¶œ ëª©í‘œ ë‹¬ì„±ë¥ ', 'ì˜ì—…ì´ìµë¥ ', 'ì§ì› ë§Œì¡±ë„(í‡´ì‚¬ìœ¨)', 'ì‹ ê·œ ì œíœ´ ê±´ìˆ˜'],
                    main_duties: [
                        { cat: 'ê²½ì˜ê¸°íš', desc: 'ê²½ìŸì‚¬ ë¶„ì„, ë§ˆì¼€íŒ… ì»¨ì…‰, í•™ì‚¬ì¼ì • ìµœì¢… ìŠ¹ì¸' },
                        { cat: 'ëŒ€ì™¸í˜‘ë ¥', desc: 'ëŒ€í•™êµ/ì™¸ë¶€ì—…ì²´ MOU, ê°•ì‚¬ ì˜ì… ë° ê³„ì•½' },
                        { cat: 'ì¸ì‚¬/ìƒë‹´', desc: 'ì±„ìš©, ì—°ë´‰í˜‘ìƒ, VIP ì•…ì„± ë¯¼ì› í•´ê²°' }
                    ],
                    sub_duties: [
                        { role: 'ì‹¤ì¥', desc: 'ì‹¤ì¥ ë¶€ì¬ ì‹œ í˜„ì¥ ì§€íœ˜ ë° ë¹„ìƒ ìƒí™© ê²°ì •' }
                    ],
                    algorithm: 'ì œ1ì›ë¦¬ ì‚¬ê³  (First Principles): ê´€í–‰ì„ íƒ€íŒŒí•˜ê³  ë³¸ì§ˆ(í•©ê²©)ì— ì§‘ì¤‘í•œ ì‚¬ì—… ì¬ì„¤ê³„.'
                },
                {
                    id: 'head_manager',
                    title: 'ìš´ì˜ ì‹¤ì¥',
                    subtitle: 'Head of Operation',
                    icon: 'ğŸ«¡',
                    summary: 'í˜„ì¥ ìš´ì˜ì˜ ì „ê²°ê¶Œì. ìƒë‹´ ì´ê´„, ë§¤ì¶œ ì‹¤í–‰, ì§ì› ê´€ë¦¬ë¥¼ ì±…ì„ì§€ëŠ” ì•ˆë°© ì‚´ë¦¼ê¾¼.',
                    kpi: ['ì›” ì´ ë§¤ì¶œ', 'ì‹ ê·œ ë“±ë¡ë¥ ', 'ë¯¼ì› í•´ê²° ê±´ìˆ˜', 'ì§ì› ê·¼íƒœ ì¤€ìˆ˜ìœ¨'],
                    main_duties: [
                        { cat: 'ìš´ì˜/ê´€ë¦¬', desc: 'ê·¼ë¬´í‘œ ì‘ì„±, ê·¼íƒœ ê´€ë¦¬, ë¹„í’ˆ êµ¬ë§¤ ìŠ¹ì¸' },
                        { cat: 'ìƒë‹´/ë§¤ì¶œ', desc: 'ì‹ ê·œ OT, ë°˜í¸ì„±, ë¯¸ë‚©/í™˜ë¶ˆ ê´€ë¦¬, ì›ì„œì ‘ìˆ˜ ì§€ë„' },
                        { cat: 'í•™ì‚¬ìš´ì˜', desc: 'ëª¨ì˜ê³ ì‚¬ ì´ê´„(ê¸°íš/ì±„ì ), ì›” íŠ¹ê°• ê²°ì‚°' }
                    ],
                    sub_duties: [
                        { role: 'ë¶€ì›ì¥', desc: 'ë¶€ì›ì¥ ë¶€ì¬ ì‹œ ì „ëµì  ê°€ì´ë“œë¼ì¸ ë‚´ í˜„ìƒ ìœ ì§€' },
                        { role: 'ëŒ€ë¦¬(ë‚¨/ì—¬)', desc: 'ì‹œì„¤ ì—…ì²´ ì»¨íƒ ë° ì¤‘ìš” íšŒê³„ ê²°ì¬ ëŒ€í–‰' }
                    ],
                    algorithm: 'í¬ê·¸ í–‰ë™ ëª¨ë¸ (B=MAP): ìƒë‹´ ì‹œ ë™ê¸°(M)ì™€ ëŠ¥ë ¥(A)ì„ ìê·¹í•˜ê³  íŠ¸ë¦¬ê±°(P)ë¥¼ ë‹¹ê²¨ ë“±ë¡ ìœ ë„.'
                },
                {
                    id: 'manager_facility',
                    title: 'ì‹œì„¤/ê·œìœ¨ ëŒ€ë¦¬(ë‚¨)',
                    subtitle: 'Facility & Field Manager',
                    icon: 'ğŸ› ï¸',
                    summary: 'í•™ì›ì˜ í•˜ë“œì›¨ì–´ì™€ ê·œìœ¨ ì±…ì„ì. ì‹œì„¤ ìœ ì§€ë³´ìˆ˜, ë¬¼ë¥˜, í•™ìƒ í†µì œë¥¼ ë‹´ë‹¹.',
                    kpi: ['ì‹œì„¤ ê³ ì¥ ì²˜ë¦¬ ì‹œê°„', 'ì•ˆì „ì‚¬ê³  0ê±´', 'êµì¬ ë°°ì†¡ ì˜¤ì°¨ìœ¨ 0%'],
                    main_duties: [
                        { cat: 'ì‹œì„¤/ì•ˆì „', desc: 'ê°•ì˜ì‹¤/ë…ì„œì‹¤ ì ê²€, ë„¤íŠ¸ì›Œí¬/ì†Œë°© ì ê²€' },
                        { cat: 'ë¬¼ë¥˜', desc: 'êµì¬ ì…ì¶œê³ , íƒë°° ë°œì†¡, ì¬ê³  ì‹¤ì‚¬' },
                        { cat: 'í•™ì‚¬/ê·œìœ¨', desc: 'íŠ¹ê°• ë‹´ì„, ë©´í•™ ë¶„ìœ„ê¸° ìˆœì°°, ë²Œì  ë¶€ì—¬' }
                    ],
                    sub_duties: [
                        { role: 'ì‹¤ì¥', desc: 'ì‹¤ì¥ ë¶€ì¬ ì‹œ í˜„ì¥ í†µì œ ì§€ì›' },
                        { role: 'ëŒ€ë¦¬(ì—¬)', desc: 'ë¶„ì‹¤ë¬¼ ê´€ë¦¬ ë“± ë¬¼ë¦¬ì  í–‰ì • ì§€ì›' }
                    ],
                    algorithm: 'ë‹¤ì°¨ì›ì  ë¶„ì„ (MDA): ì‹œê°„/ê³µê°„/ì¸ê³¼ ì°¨ì›ì—ì„œ ì‹œì„¤ ë¦¬ìŠ¤í¬ë¥¼ ì˜ˆì¸¡í•˜ê³  ì„ ì œ ëŒ€ì‘.'
                },
                {
                    id: 'manager_admin',
                    title: 'íšŒê³„/í•™ì‚¬ ëŒ€ë¦¬(ì—¬)',
                    subtitle: 'Admin & Accounting Manager',
                    icon: 'ğŸ“Š',
                    summary: 'ê¼¼ê¼¼í•œ ìê¸ˆ ë° ë°ì´í„° ê´€ë¦¬ì. íšŒê³„ ê²°ì‚°, í•©ê²©ì DB, ìˆ˜ì—… ì§€ì› ë‹´ë‹¹.',
                    kpi: ['ì •ì‚° ì˜¤ë¥˜ 0ê±´', 'í•©ê²©ì DB ìµœì‹ í™”ìœ¨', 'ê°•ì‚¬ ë§Œì¡±ë„'],
                    main_duties: [
                        { cat: 'íšŒê³„/ì´ë¬´', desc: 'ì„¸ê¸ˆê³„ì‚°ì„œ, ì‹œì¬ ê´€ë¦¬, ê¸‰ì—¬ ì •ì‚°, ë¹„í’ˆ ì£¼ë¬¸' },
                        { cat: 'í•™ì‚¬ì§€ì›', desc: 'ìˆ˜ì—… ì‹œê°„í‘œ ë°°ì •, ê°•ì‚¬ ì˜ì „, í•©ê²©ì ê´€ë¦¬' },
                        { cat: 'íŠ¹ê°•ì§€ì›', desc: 'íŠ¹ê°• ì ‘ìˆ˜ ì¤€ë¹„, ìë£Œ í¸ì§‘ ì§€ì›' }
                    ],
                    sub_duties: [
                        { role: 'ì‹¤ì¥', desc: 'ê³ ê° ë°ì´í„° ê´€ë¦¬ ë° ë‹¨ìˆœ ë§¤ì¶œ ë³´ê³  ëŒ€í–‰' },
                        { role: 'ì£¼ì„(ì—¬)', desc: 'ë…ì„œì‹¤/ì‚¬ë¬¼í•¨ ì ‘ìˆ˜ ë° ë¬¸ì ë°œì†¡ ëŒ€í–‰' }
                    ],
                    algorithm: 'í†µí•©ì  ì§€í˜œ (IW): ì—„ê²©í•œ ìœ¤ë¦¬ ê¸°ì¤€(Ethics)ìœ¼ë¡œ ìê¸ˆ ê´€ë¦¬ ë° ë°ì´í„° ë¬´ê²°ì„± ìœ ì§€.'
                },
                {
                    id: 'chief_marketing',
                    title: 'ë§ˆì¼€íŒ…/í–‰ì • ì£¼ì„(ì—¬)',
                    subtitle: 'Marketing & Admin Lead',
                    icon: 'ğŸ“¢',
                    summary: 'ë§ˆì¼€íŒ… ê´€ë¦¬ìì´ì í–‰ì • ë©€í‹°í”Œë ˆì´ì–´. ì™¸ì£¼ ê´€ë¦¬ì™€ ì† ë§ì´ ê°€ëŠ” ì ‘ìˆ˜ ì—…ë¬´ ì „ë‹´.',
                    kpi: ['ì˜¨ë¼ì¸ ìœ ì… ìˆ˜', 'ë…ì„œì‹¤/ì‚¬ë¬¼í•¨ ì ‘ìˆ˜ ì •í™•ë„', 'ë¬¸ì ë°œì†¡ ì ì‹œì„±', 'ë¸”ë¡œê·¸/ì¹´í˜ ìƒìœ„ë…¸ì¶œ ê±´ìˆ˜'],
                    main_duties: [
                        { cat: 'ë°”ì´ëŸ´ê´€ë¦¬', desc: 'ê²½ì‹œëª¨/ê²½ê¿ˆì‚¬ ë“± ì£¼ìš” ì»¤ë®¤ë‹ˆí‹° ì—¬ë¡  ëª¨ë‹ˆí„°ë§ ë° ëŒ€ì‘' },
                        { cat: 'ì½˜í…ì¸ ì†ŒìŠ¤', desc: 'í•©ê²©ìƒ ì¸í„°ë·° ë”°ê¸°, ê°•ì˜/ììŠµ í˜„ì¥ ìˆí¼(15ì´ˆ) ì†ŒìŠ¤ ì´¬ì˜' },
                        { cat: 'ì™¸ì£¼í•¸ë“¤ë§', desc: 'ë¸”ë¡œê·¸ ì²´í—˜ë‹¨ ëª¨ì§‘ ê´€ë¦¬, ëŒ€í–‰ì‚¬ í‚¤ì›Œë“œ ë…¸ì¶œ í˜„í™© ì²´í¬' },
                        { cat: 'í–‰ì •ì „ë‹´', desc: 'ë…ì„œì‹¤/ì‚¬ë¬¼í•¨ ì‹ ê·œÂ·ì—°ì¥ ì ‘ìˆ˜, ì „ì²´ ê³µì§€ ë¬¸ì ë°œì†¡' }
                    ],
                    sub_duties: [
                        { role: 'ëŒ€ë¦¬(ì—¬)', desc: 'ë‹¨ìˆœ ìˆ˜ì—… ì§€ì› ë° ë¬¸ì„œ í¸ì§‘ ëŒ€í–‰' },
                        { role: 'ì˜ìƒ/ë””ìì´ë„ˆ', desc: 'ë‹¨ìˆœ ì´ë¯¸ì§€/ì˜ìƒ ì—…ë¡œë“œ ëŒ€í–‰' }
                    ],
                    algorithm: 'ìŠ¤ìº í¼ (SCAMPER): ê¸°ì¡´ ì†ŒìŠ¤ë¥¼ ë³€í˜•(Modify), ìš©ë„ë³€ê²½(Put to other use)í•˜ì—¬ ì½˜í…ì¸  ì¬ìƒì‚°.'
                }
            ],
            principles: [
                { title: 'ì§€íœ˜ ì²´ê³„ ì¼ì›í™”', desc: 'ëª¨ë“  ë³´ê³ ëŠ” [ì§ì› â†’ ì‹¤ì¥ â†’ ë¶€ì›ì¥]. ì§ë³´ ê¸ˆì§€ (ê¸´ê¸‰ ì œì™¸).' },
                { title: 'ì—­í• ì˜ ì´ì›í™”', desc: 'ë¶€ì›ì¥(ì„¤ê³„/ì „ëµ) vs ì‹¤ì¥(ì§‘í–‰/ìš´ì˜).' },
                { title: 'ê²°ê³¼ ì±…ì„ì œ (KPI)', desc: 'ì—´ì‹¬íˆ í–ˆë‹¤(X) â†’ ìˆ˜ì¹˜ë¡œ ë‹¬ì„±í–ˆë‹¤(O).' },
                { title: 'ë§ˆì¼€íŒ… ê³µì¥í™”', desc: 'ì°½ì‘ ê¸ˆì§€. ê¸°íš(ë¶€ì›ì¥)-ê´€ë¦¬(ì£¼ì„)-ì œì‘(ì™¸ì£¼) ì‹œìŠ¤í…œ.' }
            ],
            taskRegistry: [
                { id: 1, category: 'ê²½ì˜ê¸°íš', task: 'ê²½ìŸì‚¬ ë¶„ì„ ë° ì „ëµ ìˆ˜ë¦½', main: 'vice_director', sub: 'head_manager' },
                { id: 2, category: 'ê²½ì˜ê¸°íš', task: 'í•™ì‚¬ì¼ì • ë° ë§ˆì¼€íŒ… ì»¨ì…‰ ìŠ¹ì¸', main: 'vice_director', sub: 'head_manager' },
                { id: 3, category: 'ëŒ€ì™¸í˜‘ë ¥', task: 'ëŒ€í•™êµ/ì™¸ë¶€ì—…ì²´ MOU', main: 'vice_director', sub: 'head_manager' },
                { id: 4, category: 'ì¸ì‚¬/ìƒë‹´', task: 'ì§ì› ì±„ìš© ë° ì—°ë´‰ í˜‘ìƒ', main: 'vice_director', sub: 'head_manager' },
                { id: 5, category: 'ì¸ì‚¬/ìƒë‹´', task: 'VIP ë° ì•…ì„± ë¯¼ì› í•´ê²°', main: 'vice_director', sub: 'head_manager' },

                { id: 6, category: 'ìš´ì˜/ê´€ë¦¬', task: 'ê·¼ë¬´í‘œ ì‘ì„± ë° ê·¼íƒœ ê´€ë¦¬', main: 'head_manager', sub: 'vice_director' },
                { id: 7, category: 'ìš´ì˜/ê´€ë¦¬', task: 'ë¹„í’ˆ êµ¬ë§¤ ìŠ¹ì¸ (50ë§Œì› ë¯¸ë§Œ)', main: 'head_manager', sub: 'vice_director' },
                { id: 8, category: 'ìƒë‹´/ë§¤ì¶œ', task: 'ì‹ ê·œìƒ OT ë° ë°˜í¸ì„±', main: 'head_manager', sub: 'manager_admin' },
                { id: 9, category: 'ìƒë‹´/ë§¤ì¶œ', task: 'ë¯¸ë‚©ì ë° í™˜ë¶ˆ ê´€ë¦¬', main: 'head_manager', sub: 'manager_admin' },
                { id: 10, category: 'í•™ì‚¬ìš´ì˜', task: 'ëª¨ì˜ê³ ì‚¬ ì´ê´„ (ê¸°íš/ì±„ì )', main: 'head_manager', sub: 'manager_admin' },

                { id: 11, category: 'ì‹œì„¤/ì•ˆì „', task: 'ê°•ì˜ì‹¤/ë…ì„œì‹¤ ì‹œì„¤ ì ê²€', main: 'manager_facility', sub: 'head_manager' },
                { id: 12, category: 'ì‹œì„¤/ì•ˆì „', task: 'ë„¤íŠ¸ì›Œí¬(Wi-Fi)/ì†Œë°© ì ê²€', main: 'manager_facility', sub: 'head_manager' },
                { id: 13, category: 'ë¬¼ë¥˜', task: 'êµì¬ ì…ì¶œê³  ë° íƒë°° ë°œì†¡', main: 'manager_facility', sub: 'manager_admin' },
                { id: 14, category: 'í•™ì‚¬/ê·œìœ¨', task: 'íŠ¹ê°• ë‹´ì„ (í˜„ì¥ í†µì œ)', main: 'manager_facility', sub: 'head_manager' },

                { id: 15, category: 'íšŒê³„/ì´ë¬´', task: 'ì„¸ê¸ˆê³„ì‚°ì„œ ë° ì‹œì¬ ê´€ë¦¬', main: 'manager_admin', sub: 'head_manager' },
                { id: 16, category: 'íšŒê³„/ì´ë¬´', task: 'ê°•ì‚¬ë£Œ ë° ì•Œë°” ê¸‰ì—¬ ì •ì‚°', main: 'manager_admin', sub: 'head_manager' },
                { id: 17, category: 'í•™ì‚¬ì§€ì›', task: 'í•©ê²©ì ë°ì´í„°(ì—ë“€ê·¸ë¨) ê´€ë¦¬', main: 'manager_admin', sub: 'head_manager' },
                { id: 18, category: 'í•™ì‚¬ì§€ì›', task: 'ìˆ˜ì—… ì‹œê°„í‘œ ë°°ì • ë° ê°•ì‚¬ ì˜ì „', main: 'manager_admin', sub: 'chief_marketing' },

                { id: 19, category: 'ë§ˆì¼€íŒ…/ë°”ì´ëŸ´', task: 'ê²½ì‹œëª¨/ê²½ê¿ˆì‚¬ ì¼ì¼ ëª¨ë‹ˆí„°ë§ ë° ëŒ“ê¸€ ì‘ì—…', main: 'chief_marketing', sub: 'vice_director' },
                { id: 20, category: 'ë§ˆì¼€íŒ…/ë°”ì´ëŸ´', task: 'ë„¤ì´ë²„ ì§€ì‹iN ìš°ë¦¬ í•™ì› ê´€ë ¨ ë‹µë³€ ë‹¬ê¸°', main: 'chief_marketing', sub: 'vice_director' },
                { id: 21, category: 'ë§ˆì¼€íŒ…/ì½˜í…ì¸ ', task: 'í•©ê²©ìƒ/ì„±ì ìš°ìˆ˜ì ì¸í„°ë·° ë° ìˆ˜ê¸° í™•ë³´', main: 'chief_marketing', sub: 'head_manager' },
                { id: 22, category: 'ë§ˆì¼€íŒ…/ì½˜í…ì¸ ', task: 'ì¸ìŠ¤íƒ€/ìœ íŠœë¸Œìš© ìˆí¼(ê°•ì˜/í˜„ì¥) ì´¬ì˜', main: 'chief_marketing', sub: 'head_manager' },
                { id: 23, category: 'ë§ˆì¼€íŒ…/ì½˜í…ì¸ ', task: 'ì¹´ë“œë‰´ìŠ¤ìš© ê°•ì˜ í•µì‹¬ ìš”ì•½ ìë£Œ ìˆ˜ì§‘', main: 'chief_marketing', sub: 'manager_admin' },
                { id: 24, category: 'ë§ˆì¼€íŒ…/ì„±ê³¼', task: 'ë¸”ë¡œê·¸ í‚¤ì›Œë“œ ìˆœìœ„ ì²´í¬ ë° ë³´ê³ ', main: 'chief_marketing', sub: 'vice_director' },
                { id: 25, category: 'ë§ˆì¼€íŒ…/ì˜¤í”„ë¼ì¸', task: 'ì¸ê·¼ ë…ì„œì‹¤/ìŠ¤í„°ë””ì¹´í˜ ì „ë‹¨ì§€ ë¹„ì¹˜ í™•ì¸', main: 'chief_marketing', sub: 'manager_facility' },
                { id: 26, category: 'ë§ˆì¼€íŒ…/DB', task: 'ì„¤ëª…íšŒ/ìƒë‹´ ë¯¸ë“±ë¡ì DB ë¬¸ì(SMS) ë§ˆì¼€íŒ…', main: 'chief_marketing', sub: 'head_manager' },
                { id: 27, category: 'ë§ˆì¼€íŒ…ê´€ë¦¬', task: 'ì™¸ì£¼ ì—…ì²´ ì†ŒìŠ¤ ì „ë‹¬ ë° ê²€ìˆ˜', main: 'chief_marketing', sub: 'vice_director' },
                { id: 28, category: 'í–‰ì •ì „ë‹´', task: 'ë…ì„œì‹¤/ì‚¬ë¬¼í•¨ ì‹ ê·œÂ·ì—°ì¥ ì ‘ìˆ˜', main: 'chief_marketing', sub: 'manager_admin' },
                { id: 29, category: 'í–‰ì •ì „ë‹´', task: 'ì „ì²´ ê³µì§€ ë¬¸ì ë°œì†¡', main: 'chief_marketing', sub: 'head_manager' },
                { id: 30, category: 'í˜„ì¥ì§€ì›', task: 'ìˆ˜ê°•ì¦ ì œì‘ ë° ì„¤ëª…íšŒ ì¤€ë¹„', main: 'chief_marketing', sub: 'manager_facility' }
            ]
        };

        // --- Active Data (Mutable) ---
        let appData = {};

        // Global state for filtering
        let activeRoleFilter = null;

        // --- Data Persistence Logic ---
        async function initData() {
            // Try to load from Google Sheets first
            if (sheetsWebAppUrl) {
                const synced = await syncFromSheets();
                if (synced) {
                    return; // Successfully loaded from Sheets
                }
            }

            // Fallback to LocalStorage
            const storedData = localStorage.getItem('kpa_ops_manual_v3');
            if (storedData) {
                try {
                    appData = JSON.parse(storedData);
                } catch (e) {
                    console.error("Data load failed, resetting", e);
                    appData = JSON.parse(JSON.stringify(defaultAppData));
                }
            } else {
                appData = JSON.parse(JSON.stringify(defaultAppData));
            }
        }

        async function saveData() {
            // Try to save to Google Sheets
            if (sheetsWebAppUrl) {
                await syncToSheets();
            } else {
                // Fallback to LocalStorage only
                localStorage.setItem('kpa_ops_manual_v3', JSON.stringify(appData));
            }
        }

        function resetAllData() {
            if (confirm("ëª¨ë“  ë³€ê²½ì‚¬í•­(ì´ë¦„ ë³€ê²½, ì—…ë¬´ ì¶”ê°€ ë“±)ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                localStorage.removeItem('kpa_ops_manual_v3');
                location.reload();
            }
        }

        // ============================================
        // Google Sheets ì—°ë™ í•¨ìˆ˜
        // ============================================

        async function syncFromSheets() {
            if (!sheetsWebAppUrl) {
                console.log('Sheets URL not configured, using LocalStorage');
                return false;
            }

            syncStatus.syncing = true;
            updateSyncUI('syncing');

            try {
                const response = await fetch(buildSheetsProxyUrl('getData'));
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();

                if (data.error) {
                    console.error('Sheets sync error:', data.error);
                    syncStatus.connected = false;
                    updateSyncUI('error');
                    return false;
                }

                // If Sheets has data, use it
                if (data.roles && data.roles.length > 0) {
                    appData.roles = data.roles;
                    appData.taskRegistry = data.tasks || [];
                    appData.principles = data.principles || [];

                    // Also save to LocalStorage as cache
                    localStorage.setItem('kpa_ops_manual_v3', JSON.stringify(appData));

                    syncStatus.connected = true;
                    syncStatus.lastSync = new Date();
                    updateSyncUI('success');
                    return true;
                } else {
                    // Sheets is empty, migrate from LocalStorage
                    console.log('Sheets empty, migrating from LocalStorage');
                    await migrateToSheets();
                    return true;
                }
            } catch (error) {
                console.error('Failed to sync from Sheets:', error);
                syncStatus.connected = false;
                syncStatus.syncing = false;
                updateSyncUI('error');
                return false;
            }
        }

        async function syncToSheets() {
            if (!sheetsWebAppUrl) {
                console.log('Sheets URL not configured, saving to LocalStorage only');
                localStorage.setItem('kpa_ops_manual_v3', JSON.stringify(appData));
                return false;
            }

            syncStatus.syncing = true;
            updateSyncUI('syncing');

            try {
                const response = await fetch(buildSheetsProxyUrl('saveData'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(appData)
                });

                let result = {};
                try {
                    result = await response.json();
                } catch (e) {
                    result = {};
                }

                if (!response.ok || result.error) {
                    throw new Error(result.error || `HTTP ${response.status}`);
                }

                // Also save to LocalStorage as cache
                localStorage.setItem('kpa_ops_manual_v3', JSON.stringify(appData));

                syncStatus.connected = true;
                syncStatus.lastSync = new Date();
                syncStatus.syncing = false;
                updateSyncUI('success');
                return true;
            } catch (error) {
                console.error('Failed to sync to Sheets:', error);
                syncStatus.syncing = false;
                updateSyncUI('error');

                // Fallback to LocalStorage
                localStorage.setItem('kpa_ops_manual_v3', JSON.stringify(appData));
                return false;
            }
        }

        async function migrateToSheets() {
            console.log('Migrating LocalStorage data to Sheets...');

            // Load data from LocalStorage first
            const storedData = localStorage.getItem('kpa_ops_manual_v3');
            if (storedData) {
                try {
                    appData = JSON.parse(storedData);
                    console.log('Loaded data from LocalStorage:', appData);
                } catch (e) {
                    console.error('Failed to parse LocalStorage data', e);
                    appData = JSON.parse(JSON.stringify(defaultAppData));
                }
            } else {
                // No LocalStorage data, use default
                appData = JSON.parse(JSON.stringify(defaultAppData));
            }

            // Now sync to Sheets
            const success = await syncToSheets();
            if (success) {
                console.log('Migration successful!');
            }
            return success;
        }

        function updateSyncUI(status) {
            const syncIndicator = document.getElementById('sync-indicator');
            if (!syncIndicator) return;

            if (status === 'syncing') {
                syncIndicator.innerHTML = 'ğŸ”„ ë™ê¸°í™” ì¤‘...';
                syncIndicator.className = 'text-xs text-blue-600 font-bold animate-pulse';
            } else if (status === 'success') {
                syncIndicator.innerHTML = 'âœ… ë™ê¸°í™” ì™„ë£Œ';
                syncIndicator.className = 'text-xs text-green-600 font-bold';
                setTimeout(() => {
                    if (syncStatus.lastSync) {
                        const time = syncStatus.lastSync.toLocaleTimeString('ko-KR');
                        syncIndicator.innerHTML = `â˜ï¸ ${time}`;
                        syncIndicator.className = 'text-xs text-gray-500';
                    }
                }, 2000);
            } else if (status === 'error') {
                syncIndicator.innerHTML = 'âš ï¸ ì˜¤í”„ë¼ì¸';
                syncIndicator.className = 'text-xs text-orange-500 font-bold';
            }
        }

        // --- Gemini API Logic ---
        async function callGeminiAPI(userQuery, systemContext = "") {
            // Check for Key
            if (!userApiKey) {
                openApiSettings();
                return "AI ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ì„¤ì •(âš™ï¸) ë©”ë‰´ì—ì„œ API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.";
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3.0-flash-preview:generateContent?key=${userApiKey}`;

            const manualContext = `
                ë‹¹ì‹ ì€ í•œêµ­ê²½ì°°í•™ì›ì˜ 'AI ìš´ì˜ ì»¨ì„¤í„´íŠ¸'ì…ë‹ˆë‹¤.
                ì•„ë˜ì˜ [ì¡°ì§ ìš´ì˜ ë§¤ë‰´ì–¼]ì„ ì—„ê²©íˆ ì¤€ìˆ˜í•˜ì—¬ ë‹µë³€í•´ì•¼ í•©ë‹ˆë‹¤.
                
                [4ëŒ€ ìš´ì˜ ì›ì¹™]
                1. ì§€íœ˜ ì²´ê³„ ì¼ì›í™”: ì§ì› -> ì‹¤ì¥ -> ë¶€ì›ì¥. ì§ë³´ ê¸ˆì§€(ê¸´ê¸‰ ì œì™¸).
                2. ì—­í•  ì´ì›í™”: ë¶€ì›ì¥(ì „ëµ/ì„¤ê³„) vs ì‹¤ì¥(í˜„ì¥/ìš´ì˜).
                3. ê²°ê³¼ ì±…ì„ì œ: KPI ì¤‘ì‹¬ í‰ê°€.
                4. ë§ˆì¼€íŒ… ê³µì¥í™”: ê¸°íš(ë¶€ì›ì¥)-ê´€ë¦¬(ì£¼ì„)-ì œì‘(ì™¸ì£¼).

                [ì§ë¬´ë³„ í•µì‹¬ R&R]
                - ë¶€ì›ì¥: COO, ì „ëµ, ì¸ì‚¬, ëŒ€ì™¸í˜‘ë ¥. ì‹¤ë¬´ ê¸ˆì§€.
                - ì‹¤ì¥: í˜„ì¥ ì´ê´„, ìƒë‹´/ë§¤ì¶œ/ì§ì›ê´€ë¦¬ ì „ê²°ê¶Œ.
                - ëŒ€ë¦¬(ë‚¨): ì‹œì„¤, ê·œìœ¨, ë¬¼ë¥˜.
                - ëŒ€ë¦¬(ì—¬): íšŒê³„, ë°ì´í„°, í•™ì‚¬ì§€ì›.
                - ì£¼ì„(ì—¬): ë§ˆì¼€íŒ… ê´€ë¦¬(ì°½ì‘X), í–‰ì •/ì ‘ìˆ˜ ì „ë‹´.

                [ë³´ê³ ì˜ ì›ì¹™]
                - 1-3-1 ë²•ì¹™: ê²°ë¡  1ì¤„, ê·¼ê±° 3ê°€ì§€, ì œì•ˆ 1ì¤„.
                - ë‚˜ìœ ë³´ê³ : ë³€ëª…, ê³¼ì • ë‚˜ì—´.
                - ì¢‹ì€ ë³´ê³ : ìˆ«ì, ëŒ€ì•ˆ ì œì‹œ.

                ë‹µë³€ ìŠ¤íƒ€ì¼:
                - ì „ë¬¸ì ì´ê³  ë‹¨í˜¸í•œ 'ì´ê´„ ë¶€ì›ì¥' ë˜ëŠ” 'ê²½ì˜ ì»¨ì„¤í„´íŠ¸'ì˜ ì–´ì¡°ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
                - ë°˜ë“œì‹œ ë§¤ë‰´ì–¼ì˜ ì¡°í•­ì´ë‚˜ ì›ì¹™ì„ ì¸ìš©í•˜ì—¬ ê·¼ê±°ë¥¼ ì œì‹œí•˜ì„¸ìš”.
                - ì‹¤í–‰ ê°€ëŠ¥í•œ êµ¬ì²´ì ì¸ í–‰ë™ ì§€ì¹¨(Action Plan)ì„ 1, 2, 3 ë²ˆí˜¸ë¥¼ ë§¤ê²¨ ì œì•ˆí•˜ì„¸ìš”.
            `;

            const fullPrompt = `${manualContext}\n\n${systemContext}\n\nì‚¬ìš©ì ì§ˆë¬¸: ${userQuery}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: fullPrompt }] }]
                    })
                });

                if (!response.ok) throw new Error('API í˜¸ì¶œ ì‹¤íŒ¨');

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini API Error:", error);
                return "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. API í‚¤ê°€ ì •í™•í•œì§€ í™•ì¸í•´ì£¼ì„¸ìš”.";
            }
        }

        // --- View Logic ---

        async function init() {
            await initData(); // Load data from Sheets or LocalStorage
            renderNav();

            // Check for stored API key
            if (userApiKey) {
                const status = document.getElementById('ai-status');
                if (status) status.classList.remove('hidden');
            }

            // Show sync indicator if Sheets URL is configured
            if (sheetsWebAppUrl) {
                const syncIndicator = document.getElementById('sync-indicator');
                if (syncIndicator) {
                    syncIndicator.classList.remove('hidden');
                    if (syncStatus.connected) {
                        syncIndicator.innerHTML = 'â˜ï¸ ë™ê¸°í™”ë¨';
                        syncIndicator.className = 'text-xs text-green-600';
                    } else {
                        syncIndicator.innerHTML = 'âš ï¸ ì˜¤í”„ë¼ì¸';
                        syncIndicator.className = 'text-xs text-orange-500';
                    }
                }
            }

            loadView('dashboard');
        }

        function renderNav() {
            const navItems = [
                { id: 'dashboard', label: 'ëŒ€ì‹œë³´ë“œ' },
                { id: 'roles', label: 'ì—…ë¬´ ë¶„ì¥' },
                { id: 'task-search', label: 'ğŸ” ì—…ë¬´ ê²€ìƒ‰ & ë°°ì •' }, // New Search Menu
                { id: 'reporting', label: 'ë³´ê³  ì²´ê³„' },
                { id: 'shifts', label: 'ê·¼ë¬´/ì‹œì¦Œ' },
                { id: 'utility', label: 'ğŸ› ï¸ ì‹¤ë¬´ ìœ í‹¸ë¦¬í‹°' },
                { id: 'toolkit', label: 'âœ¨ AI ìŠ¤ë§ˆíŠ¸ íˆ´' },
                { id: 'ai-copilot', label: 'ğŸ¤– AI ìš´ì˜ ì½”íŒŒì¼ëŸ¿' }
            ];

            const container = document.getElementById('nav-container');
            container.innerHTML = navItems.map(item => `
                    <button onclick = "loadView('${item.id}')"
                class="nav-btn border-transparent text-stone-500 hover:border-slate-300 hover:text-slate-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors duration-200"
                id = "nav-${item.id}" >
                    ${item.label}
                </button >
                    `).join('');
        }

        function loadView(viewId) {
            // Update Nav State
            document.querySelectorAll('.nav-btn').forEach(el => {
                el.classList.remove('border-slate-800', 'text-slate-900');
                el.classList.add('border-transparent', 'text-stone-500');
            });
            document.getElementById(`nav-${viewId}`).classList.add('border-slate-800', 'text-slate-900');
            document.getElementById(`nav-${viewId}`).classList.remove('border-transparent', 'text-stone-500');

            const contentArea = document.getElementById('content-area');

            // Render Content
            if (viewId === 'dashboard') renderDashboard(contentArea);
            else if (viewId === 'roles') renderRoles(contentArea);
            else if (viewId === 'task-search') renderTaskSearch(contentArea); // New View
            else if (viewId === 'reporting') renderReporting(contentArea);
            else if (viewId === 'shifts') renderShifts(contentArea);
            else if (viewId === 'toolkit') renderToolkit(contentArea);
            else if (viewId === 'utility') renderUtility(contentArea);
            else if (viewId === 'ai-copilot') renderAICopilot(contentArea);
        }

        // --- Helper: Get Role Name by ID ---
        function getRoleName(id) {
            const role = appData.roles.find(r => r.id === id);
            return role ? role.title : 'ë¯¸ì§€ì •';
        }
        function getRoleBadge(id) {
            const role = appData.roles.find(r => r.id === id);
            // Added onclick for filtering
            return role ? `<span onclick = "filterTasksByRole('${id}')" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-800 hover:bg-indigo-100 cursor-pointer border border-transparent hover:border-indigo-300 transition-colors" title = "í´ë¦­í•˜ì—¬ ${role.title} ì—…ë¬´ë§Œ ë³´ê¸°" > ${role.icon} ${role.title}</span > ` : '<span class="text-stone-400">-</span>';
        }

        // --- Task Search & Add View ---
        function renderTaskSearch(container) {
            container.innerHTML = `
                    <div class="bg-white p-8 rounded-lg shadow-sm border border-stone-200 min-h-[600px]" >
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">ğŸ” ì—…ë¬´ ê²€ìƒ‰ ë° ê´€ë¦¬</h2>
                            <p class="text-stone-500 text-sm mt-1">ë‹´ë‹¹ìë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ ì¸ì›ì˜ ì—…ë¬´(ì •/ë¶€)ë§Œ ëª¨ì•„ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                        <div class="flex gap-2 w-full md:w-auto flex-wrap justify-end">
                            <!-- Filter Display -->
                            <div id="active-filter-display" class="hidden flex items-center bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full text-sm border border-indigo-200">
                                <span id="filter-name" class="font-bold mr-2"></span>
                                <button onclick="clearRoleFilter()" class="hover:text-indigo-900 font-bold">âœ•</button>
                            </div>

                            <input type="text" id="task-search-input" placeholder="ì—…ë¬´ëª… ê²€ìƒ‰ (ì˜ˆ: í™˜ë¶ˆ)" 
                                class="flex-grow md:w-48 p-2 border border-stone-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                onkeyup="filterTasks()">
                            
                            <button onclick="openRoleEditor()" class="bg-stone-600 text-white px-3 py-2 rounded text-sm font-bold hover:bg-stone-700 transition flex items-center whitespace-nowrap">
                                ğŸ·ï¸ ì´ë¦„ ë³€ê²½
                            </button>
                            <button onclick="openTaskForm()" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-indigo-700 transition flex items-center whitespace-nowrap">
                                â• ì‹ ê·œ ì—…ë¬´
                            </button>
                        </div>
                    </div>

                    <!--Role Name Editor Form(Hidden)-- >
                    <div id="edit-role-form" class="hidden mb-8 bg-stone-50 p-6 rounded-lg border border-stone-200 animate-fade-in">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-stone-800 flex items-center"><span class="text-xl mr-2">ğŸ·ï¸</span> ë‹´ë‹¹ì ëª…ì¹­(ì‹¤ëª…) ìˆ˜ì •</h3>
                            <button onclick="closeRoleEditor()" class="text-stone-400 hover:text-stone-600">âœ•</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            ${appData.roles.map(r => `
                                <div class="flex flex-col">
                                    <label class="text-xs font-bold text-stone-500 uppercase mb-1">${r.subtitle}</label>
                                    <div class="flex items-center">
                                        <span class="text-2xl mr-2">${r.icon}</span>
                                        <input type="text" id="role-name-${r.id}" value="${r.title}" class="w-full p-2 border border-stone-300 rounded text-sm focus:ring-2 focus:ring-stone-500">
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="flex justify-end">
                            <button onclick="saveRoleNames()" class="bg-stone-800 text-white px-6 py-2 rounded text-sm font-bold hover:bg-black shadow-sm">ë³€ê²½ì‚¬í•­ ì €ì¥</button>
                        </div>
                    </div>

                    <!--Add / Edit Task Form(Hidden)-- >
                    <div id="add-task-form" class="hidden mb-8 bg-indigo-50 p-6 rounded-lg border border-indigo-100 animate-fade-in">
                        <input type="hidden" id="edit-task-id"> <!-- ID for Edit Mode -->
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-indigo-800 flex items-center" id="form-title"><span class="text-xl mr-2">âœï¸</span> ì‹ ê·œ ì—…ë¬´ ë°°ì •</h3>
                            <span id="form-mode-badge" class="text-xs bg-indigo-200 text-indigo-800 px-2 py-1 rounded hidden">ìˆ˜ì • ëª¨ë“œ</span>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-xs font-bold text-indigo-600 uppercase mb-1">ì¹´í…Œê³ ë¦¬</label>
                                <input type="text" id="new-cat" placeholder="ì˜ˆ: í–‰ì‚¬ì§€ì›" class="w-full p-2 border border-indigo-200 rounded text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                            </div>
                            <div class="lg:col-span-2"> <!-- Task Name takes more space -->
                                <label class="block text-xs font-bold text-indigo-600 uppercase mb-1">ì—…ë¬´ ë‚´ìš©</label>
                                <input type="text" id="new-task" placeholder="ì˜ˆ: ì£¼ë§ ì„¤ëª…íšŒ ì£¼ì°¨ ê´€ë¦¬" class="w-full p-2 border border-indigo-200 rounded text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-indigo-600 uppercase mb-1">ì •(Main) ë‹´ë‹¹</label>
                                <select id="new-main" class="w-full p-2 border border-indigo-200 rounded text-sm bg-white">
                                    ${appData.roles.map(r => `<option value="${r.id}">${r.title}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-indigo-600 uppercase mb-1">ë¶€(Sub) ë‹´ë‹¹</label>
                                <select id="new-sub" class="w-full p-2 border border-indigo-200 rounded text-sm bg-white">
                                    <option value="">(ì„ íƒ ì•ˆí•¨)</option>
                                    ${appData.roles.map(r => `<option value="${r.id}">${r.title}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="flex justify-end gap-2">
                            <button onclick="closeTaskForm()" class="px-4 py-2 text-stone-500 hover:text-stone-700 text-sm font-bold bg-white border border-stone-300 rounded">ì·¨ì†Œ</button>
                            <button onclick="saveTask()" class="bg-indigo-600 text-white px-6 py-2 rounded text-sm font-bold hover:bg-indigo-700 shadow-sm" id="save-btn">ì €ì¥ ë° ë°°ì •</button>
                        </div>
                    </div>

                    <!--Tasks Table-- >
                    <div class="overflow-x-auto border border-stone-200 rounded-lg">
                        <table class="min-w-full divide-y divide-stone-200">
                            <thead class="bg-stone-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">ì¹´í…Œê³ ë¦¬</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">ì—…ë¬´ ë‚´ìš©</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">ì •(Main) ë‹´ë‹¹</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">ë¶€(Sub) ë‹´ë‹¹</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-stone-500 uppercase tracking-wider">ê´€ë¦¬</th>
                                </tr>
                            </thead>
                            <tbody id="task-list-body" class="bg-white divide-y divide-stone-200">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                    <div id="no-result" class="hidden text-center py-10 text-stone-400">
                        ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                </div >
                    `;
            // Initial render with current filter state - wait for DOM
            setTimeout(() => {
                if (activeRoleFilter) {
                    filterTasksByRole(activeRoleFilter);
                } else {
                    renderTaskList(appData.taskRegistry);
                }
            }, 0);
        }

        function renderTaskList(tasks) {
            const tbody = document.getElementById('task-list-body');
            const noResult = document.getElementById('no-result');

            // Null check - if elements don't exist, return early
            if (!tbody || !noResult) {
                console.warn('Task list elements not found in DOM');
                return;
            }

            if (tasks.length === 0) {
                tbody.innerHTML = '';
                noResult.classList.remove('hidden');
                return;
            }

            noResult.classList.add('hidden');
            tbody.innerHTML = tasks.map(t => `
                    <tr class="hover:bg-stone-50 transition-colors" >
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-stone-600">${t.category}</td>
                    <td class="px-6 py-4 text-sm text-stone-800">${t.task}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-900">
                        ${getRoleBadge(t.main)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">
                        ${getRoleBadge(t.sub)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="editTask(${t.id})" class="text-indigo-600 hover:text-indigo-900 mr-3 p-1 rounded hover:bg-indigo-50" title="ìˆ˜ì •">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 00 2 2h11a2 2 0 00 2-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                        </button>
                        <button onclick="deleteTask(${t.id})" class="text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-50" title="ì‚­ì œ">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </td>
                </tr >
                    `).join('');
        }

        // --- Role Filter Logic ---
        function filterTasksByRole(roleId) {
            activeRoleFilter = roleId;
            const roleName = getRoleName(roleId);

            // Update UI to show filter is active
            const filterDisplay = document.getElementById('active-filter-display');
            const filterName = document.getElementById('filter-name');
            const searchInput = document.getElementById('task-search-input');

            if (filterDisplay && filterName) {
                filterDisplay.classList.remove('hidden');
                filterName.innerText = `${roleName} ë‹´ë‹¹ ì—…ë¬´`;
                if (searchInput) searchInput.value = ''; // Clear text search
            }

            // Filter Data
            const filtered = appData.taskRegistry.filter(t => t.main === roleId || t.sub === roleId);
            renderTaskList(filtered);
        }

        function clearRoleFilter() {
            activeRoleFilter = null;
            const filterDisplay = document.getElementById('active-filter-display');
            if (filterDisplay) filterDisplay.classList.add('hidden');

            // Re-run text filter or show all
            filterTasks();
        }

        function filterTasks() {
            const keyword = document.getElementById('task-search-input').value.toLowerCase();

            let filtered = appData.taskRegistry;

            // Apply Role Filter first if active
            if (activeRoleFilter) {
                filtered = filtered.filter(t => t.main === activeRoleFilter || t.sub === activeRoleFilter);
            }

            // Then apply text filter
            if (keyword) {
                filtered = filtered.filter(t =>
                    t.task.toLowerCase().includes(keyword) ||
                    t.category.toLowerCase().includes(keyword) ||
                    getRoleName(t.main).toLowerCase().includes(keyword) ||
                    getRoleName(t.sub).toLowerCase().includes(keyword)
                );
            }

            renderTaskList(filtered);
        }

        // --- Role Name Editor Logic ---
        function openRoleEditor() {
            closeTaskForm(); // Close other form
            document.getElementById('edit-role-form').classList.remove('hidden');
        }

        function closeRoleEditor() {
            document.getElementById('edit-role-form').classList.add('hidden');
        }

        function saveRoleNames() {
            // Update appData.roles based on inputs
            appData.roles.forEach(role => {
                const input = document.getElementById(`role - name - ${role.id} `);
                if (input && input.value) {
                    role.title = input.value;
                }
            });

            saveData(); // Save to LocalStorage
            alert('ë‹´ë‹¹ì ëª…ì¹­ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
            closeRoleEditor();

            // Refresh Views
            renderTaskSearch(document.getElementById('content-area'));
        }

        // --- Task Add/Edit Logic (Existing Updated) ---
        function openTaskForm(mode = 'add', data = null) {
            closeRoleEditor(); // Close other form
            const form = document.getElementById('add-task-form');
            const title = document.getElementById('form-title');
            const btn = document.getElementById('save-btn');
            const badge = document.getElementById('form-mode-badge');
            const idField = document.getElementById('edit-task-id');

            // Reset Fields
            document.getElementById('new-cat').value = '';
            document.getElementById('new-task').value = '';

            // Re-populate dropdowns to ensure latest names
            const mainSelect = document.getElementById('new-main');
            const subSelect = document.getElementById('new-sub');

            const roleOptions = appData.roles.map(r => `<option value = "${r.id}" > ${r.title}</option > `).join('');
            mainSelect.innerHTML = roleOptions;
            subSelect.innerHTML = `<option value = "" > (ì„ íƒ ì•ˆí•¨)</option > ` + roleOptions;

            document.getElementById('new-main').selectedIndex = 0;
            document.getElementById('new-sub').selectedIndex = 0;
            idField.value = '';

            if (mode === 'edit' && data) {
                title.innerHTML = '<span class="text-xl mr-2">âœï¸</span> ì—…ë¬´ ë‚´ìš© ìˆ˜ì •';
                btn.innerText = 'ìˆ˜ì • ì™„ë£Œ';
                btn.className = "bg-green-600 text-white px-6 py-2 rounded text-sm font-bold hover:bg-green-700 shadow-sm";
                badge.classList.remove('hidden');

                document.getElementById('new-cat').value = data.category;
                document.getElementById('new-task').value = data.task;
                document.getElementById('new-main').value = data.main;
                document.getElementById('new-sub').value = data.sub;
                idField.value = data.id;
            } else {
                title.innerHTML = '<span class="text-xl mr-2">âœï¸</span> ì‹ ê·œ ì—…ë¬´ ë°°ì •';
                btn.innerText = 'ì €ì¥ ë° ë°°ì •';
                btn.className = "bg-indigo-600 text-white px-6 py-2 rounded text-sm font-bold hover:bg-indigo-700 shadow-sm";
                badge.classList.add('hidden');
            }

            form.classList.remove('hidden');
            form.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function closeTaskForm() {
            document.getElementById('add-task-form').classList.add('hidden');
        }

        function saveTask() {
            const id = document.getElementById('edit-task-id').value;
            const cat = document.getElementById('new-cat').value;
            const task = document.getElementById('new-task').value;
            const main = document.getElementById('new-main').value;
            const sub = document.getElementById('new-sub').value;

            if (!cat || !task || !main) {
                alert("ì¹´í…Œê³ ë¦¬, ì—…ë¬´ ë‚´ìš©, ì •(Main) ë‹´ë‹¹ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
                return;
            }

            if (id) {
                const index = appData.taskRegistry.findIndex(t => t.id == id);
                if (index !== -1) {
                    appData.taskRegistry[index] = { id: parseInt(id), category: cat, task: task, main: main, sub: sub };
                    alert("ì—…ë¬´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
            } else {
                const newId = appData.taskRegistry.length > 0 ? Math.max(...appData.taskRegistry.map(t => t.id)) + 1 : 1;
                appData.taskRegistry.unshift({ id: newId, category: cat, task: task, main: main, sub: sub });
                alert("ìƒˆë¡œìš´ ì—…ë¬´ê°€ ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }

            saveData(); // Save to LocalStorage
            closeTaskForm();
            filterTasks();
        }

        function editTask(id) {
            const task = appData.taskRegistry.find(t => t.id === id);
            if (task) {
                openTaskForm('edit', task);
            }
        }

        function deleteTask(id) {
            if (confirm("ì •ë§ ì´ ì—…ë¬´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
                appData.taskRegistry = appData.taskRegistry.filter(t => t.id !== id);
                saveData(); // Save to LocalStorage
                filterTasks();
            }
        }

        // --- Dashboard View ---
        function renderDashboard(container) {
            container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 animate-fade-in" >
                    <!--Intro -->
                    <div class="md:col-span-2 bg-white p-8 rounded-lg shadow-sm border border-stone-200">
                        <h1 class="text-3xl font-bold text-slate-800 mb-4">ìš´ì˜ ì´ê´„ ì»¤ë§¨ë“œ ì„¼í„°</h1>
                        <p class="text-stone-600 text-lg leading-relaxed">
                            ë³¸ ì‹œìŠ¤í…œì€ <strong>COO(ìµœê³ ìš´ì˜ì±…ì„ì) ì²´ì œ</strong> í•˜ì— ê·¸ë£¹ ì „ì²´ì˜ íš¨ìœ¨ì ì¸ ìš´ì˜ì„ ì§€ì›í•©ë‹ˆë‹¤.
                            <strong>'ì „ëµ(ë¶€ì›ì¥)'</strong>ê³¼ <strong>'ì‹¤í–‰(ì‹¤ì¥)'</strong>ì„ ë¶„ë¦¬í•˜ê³ , 
                            ëª…í™•í•œ R&Rê³¼ ë°ì´í„° ê¸°ë°˜ì˜ ì˜ì‚¬ê²°ì •ì„ í†µí•´ ì¡°ì§ì˜ ì„±ì¥ì„ ë„ëª¨í•©ë‹ˆë‹¤.
                        </p>
                    </div>

                    <!--Core Principles-- >
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200">
                        <h2 class="text-xl font-bold text-slate-800 mb-4 border-b pb-2">ğŸ“‹ 4ëŒ€ ìš´ì˜ ì›ì¹™</h2>
                        <ul class="space-y-4">
                            ${appData.principles.map(p => `
                                <li class="flex items-start">
                                    <span class="flex-shrink-0 h-6 w-6 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center text-xs font-bold mr-3">âœ“</span>
                                    <div>
                                        <p class="font-bold text-slate-700">${p.title}</p>
                                        <p class="text-stone-500 text-sm">${p.desc}</p>
                                    </div>
                                </li>
                            `).join('')}
                        </ul>
                    </div>

                    <!--Org Chart Visualization-- >
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200 relative overflow-hidden">
                        <h2 class="text-xl font-bold text-slate-800 mb-4 border-b pb-2">ğŸ¢ ì¡°ì§ êµ¬ì¡°ë„</h2>
                        <div class="flex flex-col items-center justify-center space-y-6 pt-4 relative z-10">

                            <!-- CEO -->
                            <div class="w-48 bg-stone-100 border border-stone-300 p-3 rounded text-center">
                                <p class="text-xs text-stone-500 font-bold">ìµœê³  ì˜ì‚¬ê²°ì •</p>
                                <p class="font-bold text-stone-800">ëŒ€í‘œì´ì‚¬ / ì›ì¥</p>
                            </div>

                            <!-- Vice Director -->
                            <div class="w-56 bg-slate-800 text-white p-4 rounded-lg text-center shadow-lg transform scale-105">
                                <p class="text-xs text-slate-300 font-bold mb-1">COO / ì „ëµ ì´ê´„</p>
                                <p class="text-lg font-bold">ì´ê´„ ë¶€ì›ì¥ (ë‚˜)</p>
                            </div>

                            <!-- Head Manager -->
                            <div class="w-56 bg-white border-2 border-slate-600 p-3 rounded-lg text-center shadow-md">
                                <p class="text-xs text-slate-500 font-bold">Operation / í˜„ì¥ ì´ê´„</p>
                                <p class="font-bold text-slate-800">ìš´ì˜ ì‹¤ì¥</p>
                            </div>

                            <!-- Teams -->
                            <div class="grid grid-cols-2 gap-4 w-full">
                                <div class="bg-stone-50 border border-stone-200 p-2 rounded text-center">
                                    <p class="font-bold text-sm">ìš´ì˜ì§€ì›íŒ€</p>
                                    <p class="text-xs text-stone-500">ëŒ€ë¦¬(ë‚¨/ì—¬), ì£¼ì„</p>
                                </div>
                                <div class="bg-red-50 border border-red-200 p-2 rounded text-center">
                                    <p class="font-bold text-sm text-red-700">TF / ê¸°íšíŒ€</p>
                                    <p class="text-xs text-red-500">ë¶€ì›ì¥ ì§ì† (í˜ì‹ )</p>
                                </div>
                            </div>
                        </div>
                        <!-- Connecting Lines would be handled by CSS or SVG but constrained to no SVG, simplified visually by layout spacing -->
                        <div class="absolute top-1/2 left-1/2 w-0.5 h-32 bg-stone-300 -z-0 transform -translate-x-1/2 -translate-y-1/2"></div>
                    </div>
                </div >
                    `;
        }

        // --- Roles View ---
        function renderRoles(container) {
            container.innerHTML = `
                    <div class="mb-6 bg-white p-6 rounded-lg border border-stone-200" >
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">ì§ë¬´ë³„ ìƒì„¸ R&R ë§¤íŠ¸ë¦­ìŠ¤</h2>
                    <p class="text-stone-600">
                        ê° ì§ë¬´ì˜ í•µì‹¬ ì—­í• (Main)ê³¼ ë¶€ì¬ ì‹œ ëŒ€í–‰ ì—­í• (Sub)ì„ ëª…í™•íˆ ì •ì˜í•©ë‹ˆë‹¤.
                        <br><span class="text-sm text-red-500">* ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ ìƒì„¸ ì—…ë¬´ì™€ ì ìš© ì•Œê³ ë¦¬ì¦˜ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
                    </p>
                </div >
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="role-grid">
                        ${appData.roles.map(role => createRoleCard(role)).join('')}
                    </div>
                `;
        }

        function createRoleCard(role) {
            return `
                    <div class="bg-white rounded-lg border border-stone-200 shadow-sm overflow-hidden card-hover transition-all duration-300" >
                    <div class="p-6 cursor-pointer" onclick="toggleRoleDetails('${role.id}')">
                        <div class="flex items-start justify-between">
                            <div class="flex items-center">
                                <div class="text-4xl mr-4">${role.icon}</div>
                                <div>
                                    <h3 class="text-xl font-bold text-slate-800">${role.title}</h3>
                                    <p class="text-sm font-medium text-slate-500 uppercase">${role.subtitle}</p>
                                </div>
                            </div>
                            <button class="text-stone-400 hover:text-slate-600">
                                <span id="icon-${role.id}">â–¼</span>
                            </button>
                        </div>
                        <p class="mt-4 text-stone-600 leading-snug">${role.summary}</p>
                    </div>
                    
                    <!--Expanded Details-- >
                    <div id="details-${role.id}" class="hidden bg-stone-50 border-t border-stone-100 p-6 animate-fade-in">

                        <!-- KPIs -->
                        <div class="mb-4">
                            <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">í•µì‹¬ ì„±ê³¼ ì§€í‘œ (KPI)</h4>
                            <div class="flex flex-wrap gap-2">
                                ${role.kpi.map(k => `<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-medium">${k}</span>`).join('')}
                            </div>
                        </div>

                        <!-- Main Duties -->
                        <div class="mb-4">
                            <h4 class="text-xs font-bold text-slate-800 uppercase tracking-wider mb-2 border-l-4 border-slate-600 pl-2">ì •(Main) ë‹´ë‹¹ ì—…ë¬´</h4>
                            <ul class="space-y-2 text-sm text-stone-700">
                                ${role.main_duties.map(d => `
                                    <li class="flex items-start">
                                        <span class="font-bold mr-2 w-20 flex-shrink-0">[${d.cat}]</span>
                                        <span>${d.desc}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>

                        <!-- Sub Duties -->
                        <div class="mb-4">
                            <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 border-l-4 border-stone-300 pl-2">ë¶€(Sub) ë‹´ë‹¹ ì—…ë¬´ (ë°±ì—…)</h4>
                            <ul class="space-y-2 text-sm text-stone-500">
                                ${role.sub_duties.map(d => `
                                    <li class="flex items-start">
                                        <span class="font-bold mr-2 w-20 flex-shrink-0">ëŒ€í–‰: ${d.role}</span>
                                        <span>${d.desc}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>

                        <!-- Algorithm -->
                        <div class="bg-slate-800 text-white p-3 rounded text-sm mt-4">
                            <strong class="text-yellow-400">âš¡ ì—…ë¬´ ìˆ˜í–‰ ì•Œê³ ë¦¬ì¦˜:</strong><br>
                                ${role.algorithm}
                        </div>
                    </div>
                </div >
                    `;
        }

        function toggleRoleDetails(id) {
            const el = document.getElementById(`details - ${id} `);
            const icon = document.getElementById(`icon - ${id} `);
            if (el.classList.contains('hidden')) {
                el.classList.remove('hidden');
                icon.innerText = 'â–²';
            } else {
                el.classList.add('hidden');
                icon.innerText = 'â–¼';
            }
        }

        // --- Reporting View ---
        function renderReporting(container) {
            container.innerHTML = `
                    <div class="bg-white p-8 rounded-lg shadow-sm border border-stone-200" >
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">ë³´ê³  ë° ì˜ì‚¬ê²°ì • ì²´ê³„ (Two-Track)</h2>
                        <div class="flex space-x-2">
                            <button onclick="setReportMode('routine')" id="btn-routine" class="px-4 py-2 rounded bg-slate-100 text-slate-600 font-bold hover:bg-slate-200 transition">ğŸŸ¢ ì¼ë°˜ ìš´ì˜ (Run)</button>
                            <button onclick="setReportMode('tf')" id="btn-tf" class="px-4 py-2 rounded bg-stone-100 text-stone-400 font-bold hover:bg-red-50 hover:text-red-600 transition">ğŸ”´ ê¸°íš/í˜ì‹  (Change)</button>
                        </div>
                    </div>

                    <div class="relative bg-stone-50 p-8 rounded-xl border border-stone-200 min-h-[400px] flex items-center justify-center">
                        <!-- Dynamic Diagram Container -->
                        <div id="flow-diagram" class="w-full max-w-3xl relative">
                            <!-- Nodes and Lines injected by JS based on mode -->
                        </div>
                    </div>

                    <div id="flow-desc" class="mt-6 p-4 bg-blue-50 border border-blue-100 text-blue-800 rounded-lg text-sm">
                        <!-- Dynamic Description -->
                    </div>
                </div >
                    `;
            setTimeout(() => setReportMode('routine'), 0); // Init
        }

        function setReportMode(mode) {
            const diagram = document.getElementById('flow-diagram');
            const desc = document.getElementById('flow-desc');
            const btnRoutine = document.getElementById('btn-routine');
            const btnTf = document.getElementById('btn-tf');

            // Button Styles
            if (mode === 'routine') {
                btnRoutine.className = "px-4 py-2 rounded bg-blue-600 text-white font-bold shadow-md";
                btnTf.className = "px-4 py-2 rounded bg-stone-100 text-stone-400 font-bold hover:bg-red-50 hover:text-red-600 transition";

                desc.innerHTML = `
                    <strong class="block mb-1" >ğŸŸ¢ Track A: ì¼ë°˜ ìš´ì˜(Maintenance)</strong >
                        ëª¨ë“  ì¼ìƒ ì—…ë¬´(ê·¼íƒœ, ì‹œì„¤, ì •ì‚°, ìƒë‹´)ëŠ” <strong > ë°˜ë“œì‹œ ì‹¤ì¥ì„ ê²½ìœ </strong > í•©ë‹ˆë‹¤.ì‹¤ì¥ì´ 1ì°¨ í•´ê²°(ì „ê²°)í•˜ê³  ì¤‘ìš” ì‚¬í•­ë§Œ ìš”ì•½í•˜ì—¬ ë¶€ì›ì¥ì—ê²Œ ë³´ê³ í•©ë‹ˆë‹¤.
                `;

                diagram.innerHTML = `
                            <div class="flex flex-col items-center space-y-8" >
                        <div class="w-full flex justify-center">
                            <div class="bg-slate-800 text-white px-8 py-3 rounded-lg shadow-lg z-10">ì´ê´„ ë¶€ì›ì¥ (ìµœì¢… ìŠ¹ì¸)</div>
                        </div>
                        <div class="h-12 w-0.5 bg-blue-400"></div> <!--Line -->
                        <div class="w-full flex justify-center">
                            <div class="bg-white border-2 border-blue-500 text-slate-800 px-8 py-3 rounded-lg shadow-md z-10 font-bold">ìš´ì˜ ì‹¤ì¥ (1ì°¨ í•´ê²°/ì·¨í•©)</div>
                        </div>
                        <div class="h-12 w-0.5 bg-blue-400"></div> <!--Line -->
                    <div class="w-full flex justify-center space-x-4">
                        <div class="bg-white border border-stone-300 px-4 py-2 rounded text-stone-600 text-sm">ëŒ€ë¦¬(ë‚¨)</div>
                        <div class="bg-white border border-stone-300 px-4 py-2 rounded text-stone-600 text-sm">ëŒ€ë¦¬(ì—¬)</div>
                        <div class="bg-white border border-stone-300 px-4 py-2 rounded text-stone-600 text-sm">ì£¼ì„(ì—¬)</div>
                    </div>
                    </div >
                    <!--Animation Effect-- >
                    <div class="absolute top-0 bottom-0 left-1/2 w-full transform -translate-x-1/2 pointer-events-none">
                        <div class="absolute bottom-10 left-1/2 w-2 h-2 bg-blue-500 rounded-full animate-ping"></div>
                        <div class="absolute top-1/2 left-1/2 w-2 h-2 bg-blue-500 rounded-full animate-ping" style="animation-delay: 0.5s"></div>
                    </div>
                `;

            } else {
                btnRoutine.className = "px-4 py-2 rounded bg-stone-100 text-stone-400 font-bold hover:bg-blue-50 hover:text-blue-600 transition";
                btnTf.className = "px-4 py-2 rounded bg-red-600 text-white font-bold shadow-md";

                desc.innerHTML = `
                    <strong class="block mb-1" >ğŸ”´ Track B: ê¸°íš / í˜ì‹ (Innovation)</strong >
                        ìƒˆë¡œìš´ í”„ë¡œì íŠ¸(íŠ¹ê°•, ë§ˆì¼€íŒ… ì „ëµ)ëŠ” ì†ë„ë¥¼ ìœ„í•´ <strong > TFíŒ€ì´ ë¶€ì›ì¥ì—ê²Œ ì§ë³´</strong > í•©ë‹ˆë‹¤.ë‹¨, ì‹¤ì¥ì—ê²ŒëŠ” 'ì¼ì •'ì„ ê³µìœ (ì°¸ì¡°)í•˜ì—¬ ì—…ë¬´ ì¶©ëŒì„ ë°©ì§€í•©ë‹ˆë‹¤.
                `;

                diagram.innerHTML = `
                            <div class="flex flex-col items-center relative h-[300px]" >
                        <!--Vice Director-- >
                        <div class="absolute top-0 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-8 py-3 rounded-lg shadow-lg z-20">ì´ê´„ ë¶€ì›ì¥ (ê¸°íš ì´ê´„)</div>
                        
                        <!--Direct Line(Red)-- >
                        <div class="absolute top-10 left-1/2 h-[200px] w-0.5 bg-red-400 transform -translate-x-1/2 z-0"></div>
                        
                        <!--TF Team-- >
                        <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 w-64 bg-red-50 border-2 border-red-500 p-4 rounded-lg text-center z-10 shadow-md">
                            <p class="font-bold text-red-700 mb-1">TFíŒ€ (ê¸°íš/ì „ëµ)</p>
                            <div class="flex justify-center space-x-2 text-xs text-red-600">
                                <span>ëŒ€ë¦¬(ê¸°íš)</span><span>ì£¼ì„(í™ë³´)</span>
                            </div>
                        </div>

                        <!--Manager(Side Observer) -->
                        <div class="absolute top-1/2 right-0 transform translate-x-[-20%] bg-stone-100 border border-stone-300 text-stone-400 px-4 py-2 rounded-lg border-dashed">
                            <span class="text-xs font-bold block">ìš´ì˜ ì‹¤ì¥</span>
                            <span class="text-[10px]">(ì¼ì • ì°¸ì¡° / ê³µìœ )</span>
                        </div>
                        
                        <!--Dotted Line to Manager-- >
                    <div class="absolute top-[60%] left-1/2 w-[30%] border-t-2 border-dashed border-stone-300 transform"></div>
                    </div >
                    `;
            }
        }

        // --- Shifts View ---
        function renderShifts(container) {
            container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8" >
                    <!--Daily Rotation Chart-- >
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">â° 3êµëŒ€ ê·¼ë¬´ ì‹œìŠ¤í…œ</h2>
                        <div class="chart-container">
                            <canvas id="shiftChart"></canvas>
                        </div>
                        <ul class="mt-4 space-y-2 text-sm text-stone-600">
                            <li><strong>ğŸŒ… ìƒˆë²½ì¡° (1ëª…):</strong> 5ì£¼ ê°„ê²© ë¡œí…Œì´ì…˜ (ë¶€ì›ì¥ í¬í•¨). ë¬¸ ê°œë°©, ì•„ì¹¨ ëª¨ì˜ê³ ì‚¬ ì¸ì‡„.</li>
                            <li><strong>â˜€ï¸ ì•„ì¹¨ì¡° (2ëª…):</strong> í–‰ì • ë§ˆê°, í”¼í¬íƒ€ì„ ìƒë‹´.</li>
                            <li><strong>ğŸŒ™ ì˜¤í›„ì¡° (2ëª…):</strong> <span class="text-red-600 font-bold">í¸ì§‘ ìˆ™ë ¨ì í•„ì°¸.</span> ì•¼ê°„ ìˆ˜ì—… ë° ìµì¼ ëª¨ì˜ê³ ì‚¬ í¸ì§‘.</li>
                        </ul>
                    </div>

                    <!--Seasonal TF-- >
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">ğŸš¨ ì‹œì¦Œì œ ë¹„ìƒ ê·¼ë¬´ (TF)</h2>
                        <div class="space-y-4">
                            <div class="bg-red-50 border-l-4 border-red-500 p-4">
                                <h3 class="font-bold text-red-800">ë¬¸ì œí’€ì´ ì‹œì¦Œ (9ì£¼ê°„)</h3>
                                <p class="text-sm text-red-600 mt-1">ì „ ì§ì›ì´ ëª¨ì˜ê³ ì‚¬ í¸ì§‘ ìš”ì›ìœ¼ë¡œ íˆ¬ì…ë©ë‹ˆë‹¤.</p>
                            </div>

                            <div class="grid grid-cols-1 gap-2">
                                <div class="flex items-center justify-between bg-white border border-stone-200 p-2 rounded">
                                    <span class="text-sm font-bold">í˜•ì‚¬ë²•</span>
                                    <span class="text-xs bg-slate-100 px-2 py-1 rounded">ì‹¤ì¥ (ë‚œì´ë„ ìµœìƒ)</span>
                                </div>
                                <div class="flex items-center justify-between bg-white border border-stone-200 p-2 rounded">
                                    <span class="text-sm font-bold">ê²½ì°°í•™</span>
                                    <span class="text-xs bg-slate-100 px-2 py-1 rounded">ëŒ€ë¦¬(ë‚¨) (ë¶„ëŸ‰ ë§ìŒ)</span>
                                </div>
                                <div class="flex items-center justify-between bg-white border border-stone-200 p-2 rounded">
                                    <span class="text-sm font-bold">í—Œë²•</span>
                                    <span class="text-xs bg-slate-100 px-2 py-1 rounded">ëŒ€ë¦¬(ì—¬) (ê¼¼ê¼¼í•¨)</span>
                                </div>
                                <div class="flex items-center justify-between bg-white border border-stone-200 p-2 rounded">
                                    <span class="text-sm font-bold">ë²”ì£„í•™/ê¸°íƒ€</span>
                                    <span class="text-xs bg-slate-100 px-2 py-1 rounded">ì£¼ì„(ì—¬) (ë§ˆì¼€íŒ… ë³‘í–‰)</span>
                                </div>
                                <div class="flex items-center justify-between bg-slate-800 text-white p-2 rounded">
                                    <span class="text-sm font-bold">ìµœì¢… ê²€ìˆ˜ (QC)</span>
                                    <span class="text-xs bg-slate-600 px-2 py-1 rounded">ë¶€ì›ì¥</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div >
                    `;
            setTimeout(initShiftChart, 100);
        }

        function initShiftChart() {
            const canvas = document.getElementById('shiftChart');

            // Null check - if canvas doesn't exist, return early
            if (!canvas) {
                console.warn('Shift chart canvas not found in DOM');
                return;
            }

            const ctx = canvas.getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['ìƒˆë²½ì¡° (07:30)', 'ì•„ì¹¨ì¡° (08:30)', 'ì˜¤í›„ì¡° (13:30)'],
                    datasets: [{
                        data: [1, 2, 2],
                        backgroundColor: ['#f59e0b', '#3b82f6', '#1e293b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        // --- NEW: Utilities View ---
        function renderUtility(container) {
            container.innerHTML = `
                    <div class="bg-white p-8 rounded-lg shadow-sm border border-stone-200" >
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">ğŸ› ï¸ ì‹¤ë¬´ ìœ í‹¸ë¦¬í‹° (Execution Tools)</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-4 gap-6">
                        <!-- 1. Daily Routine Generator -->
                        <div class="bg-stone-50 p-5 rounded-lg border border-stone-200 flex flex-col">
                            <h3 class="font-bold text-base mb-3 text-emerald-700 flex items-center">
                                <span class="text-xl mr-2">âœ…</span> ì¼ì¼ ë£¨í‹´ ì²´í¬ë¦¬ìŠ¤íŠ¸
                            </h3>
                            <div class="space-y-3 flex-grow">
                                <div>
                                    <label class="block text-xs font-bold text-stone-600 uppercase mb-1">ê·¼ë¬´ì¡°</label>
                                    <select id="routine-shift" class="w-full p-2 border border-stone-300 rounded text-xs">
                                        <option value="dawn">ğŸŒ… ìƒˆë²½ì¡° (07:30)</option>
                                        <option value="morning">â˜€ï¸ ì•„ì¹¨ì¡° (08:30)</option>
                                        <option value="afternoon">ğŸŒ™ ì˜¤í›„ì¡° (13:30)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-stone-600 uppercase mb-1">ì§ì±…</label>
                                    <select id="routine-role" class="w-full p-2 border border-stone-300 rounded text-xs">
                                        <option value="head">ì‹¤ì¥</option>
                                        <option value="manager_m">ëŒ€ë¦¬(ë‚¨)</option>
                                        <option value="manager_f">ëŒ€ë¦¬(ì—¬)</option>
                                        <option value="chief">ì£¼ì„(ì—¬)</option>
                                    </select>
                                </div>
                                <button onclick="generateRoutine()" class="w-full bg-emerald-600 text-white py-2 rounded font-bold hover:bg-emerald-700 transition text-xs">ìƒì„±</button>
                            </div>
                            <div id="routine-output" class="mt-3 hidden bg-white border border-stone-200 rounded p-3 text-xs max-h-40 overflow-y-auto"></div>
                        </div>

                        <!-- 2. Goal Tracker -->
                        <div class="bg-stone-50 p-5 rounded-lg border border-stone-200 flex flex-col">
                            <h3 class="font-bold text-base mb-3 text-blue-700 flex items-center">
                                <span class="text-xl mr-2">ğŸ“ˆ</span> ëª©í‘œ ë‹¬ì„± ì‹œë®¬ë ˆì´í„°
                            </h3>
                            <div class="space-y-2 flex-grow">
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-[10px] font-bold text-stone-600 uppercase">ëª©í‘œ(ë§Œì›)</label>
                                        <input type="number" id="goal-total" value="5000" class="w-full p-1.5 border border-stone-300 rounded text-xs">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-stone-600 uppercase">í˜„ì¬(ë§Œì›)</label>
                                        <input type="number" id="goal-current" value="3200" class="w-full p-1.5 border border-stone-300 rounded text-xs">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-[10px] font-bold text-stone-600 uppercase">ë‚¨ì€ì¼ìˆ˜</label>
                                        <input type="number" id="goal-days" value="10" class="w-full p-1.5 border border-stone-300 rounded text-xs">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-stone-600 uppercase">ê°ë‹¨ê°€</label>
                                        <input type="number" id="goal-price" value="50" class="w-full p-1.5 border border-stone-300 rounded text-xs">
                                    </div>
                                </div>
                                <button onclick="calculateGoal()" class="w-full bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700 transition text-xs mt-1">ê³„ì‚°</button>
                            </div>
                            <div id="goal-result" class="mt-3 hidden p-2 bg-blue-50 border border-blue-200 rounded text-center text-xs"></div>
                        </div>

                        <!-- 3. D-Day Scheduler -->
                        <div class="bg-stone-50 p-5 rounded-lg border border-stone-200 flex flex-col">
                            <h3 class="font-bold text-base mb-3 text-rose-700 flex items-center">
                                <span class="text-xl mr-2">ğŸ“…</span> í–‰ì‚¬ ì¤€ë¹„ ì—­ì‚°ê¸°
                            </h3>
                            <div class="space-y-3 flex-grow">
                                <div>
                                    <label class="block text-xs font-bold text-stone-600 uppercase mb-1">í–‰ì‚¬ëª…</label>
                                    <input type="text" id="event-name" placeholder="ì˜ˆ: ì¸ë¨¸ìŠ¤ì¿¨" class="w-full p-2 border border-stone-300 rounded text-xs">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-stone-600 uppercase mb-1">D-Day</label>
                                    <input type="date" id="event-date" class="w-full p-2 border border-stone-300 rounded text-xs">
                                </div>
                                <button onclick="calculateDDay()" class="w-full bg-rose-600 text-white py-2 rounded font-bold hover:bg-rose-700 transition text-xs">ìŠ¤ì¼€ì¤„ ìƒì„±</button>
                            </div>
                            <div id="dday-result" class="mt-3 hidden p-2 bg-white border border-stone-200 rounded text-xs max-h-40 overflow-y-auto"></div>
                        </div>

                        <!-- 4. NEW: Marketing Action Planner -->
                        <div class="bg-stone-50 p-5 rounded-lg border border-stone-200 flex flex-col">
                            <h3 class="font-bold text-base mb-3 text-purple-700 flex items-center">
                                <span class="text-xl mr-2">ğŸ“¢</span> ë§ˆì¼€íŒ… ì‹¤ë¬´ ì²´í¬ë¦¬ìŠ¤íŠ¸
                            </h3>
                            <p class="text-[10px] text-stone-500 mb-3">ë§ˆì¼€íŒ… ë‹´ë‹¹ìì—ê²Œ "ì´ê²ƒë§Œ í•´"ë¼ê³  ì¤„ ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ í•  ì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.</p>
                            <div class="space-y-3 flex-grow">
                                <div>
                                    <label class="block text-xs font-bold text-stone-600 uppercase mb-1">í˜„ì¬ ì‹œì¦Œ</label>
                                    <select id="mkt-season" class="w-full p-2 border border-stone-300 rounded text-xs">
                                        <option value="normal">ğŸŒ± í‰ìˆ˜ê¸° (ë¸Œëœë”©/ê´€ë¦¬)</option>
                                        <option value="recruitment">ğŸ”¥ ëª¨ì§‘ê¸° (ê°œê°•/íŠ¹ê°•)</option>
                                        <option value="exam">ğŸš¨ ì‹œí—˜ì§ì „ (ì‘ì›/ì ì¤‘)</option>
                                    </select>
                                </div>
                                <button onclick="generateMarketingPlan()" class="w-full bg-purple-600 text-white py-2 rounded font-bold hover:bg-purple-700 transition text-xs">ì—…ë¬´ ë¦¬ìŠ¤íŠ¸ ìƒì„±</button>
                            </div>
                            <div id="mkt-result" class="mt-3 hidden bg-white border border-stone-200 rounded p-3 text-xs max-h-40 overflow-y-auto"></div>
                        </div>
                    </div>
                </div >
                    `;
        }

        // ... existing generateRoutine, calculateGoal, calculateDDay functions ...

        function generateRoutine() {
            const shift = document.getElementById('routine-shift').value;
            const role = document.getElementById('routine-role').value;
            const output = document.getElementById('routine-output');

            let tasks = [];

            // Common Shift Tasks
            if (shift === 'dawn') {
                tasks.push({ time: '07:30', task: 'í•™ì› ì „ì²´ ë¬¸ ê°œë°© ë° ì†Œë“± í•´ì œ' });
                tasks.push({ time: '07:35', task: 'ëƒ‰ë‚œë°©ê¸° ê°€ë™ ë° í™˜ê¸°' });
                tasks.push({ time: '07:40', task: 'ì•„ì¹¨ ëª¨ì˜ê³ ì‚¬ ì¸ì‡„ ë° ë¶„ë¥˜ (ì „ë‚  í¸ì§‘ë³¸)' });
                tasks.push({ time: '08:00', task: 'ê°•ì˜ì‹¤ ì…ì‹¤ ë° ì‹œí—˜ì§€ ë°°ë¶€' });
            } else if (shift === 'morning') {
                tasks.push({ time: '08:30', task: 'ë°ìŠ¤í¬ ì¸ìˆ˜ì¸ê³„ ì‚¬í•­ í™•ì¸' });
                tasks.push({ time: '09:00', task: 'ì „ì¼ ë§¤ì¶œ ì§‘ê³„ í™•ì¸ ë° ì‹œì¬ ì ê²€' });
                tasks.push({ time: '10:00', task: 'ì˜¤ì „ ì „í™” ì‘ëŒ€ ë° ë¶€ì¬ì¤‘ ì½œë°±' });
            } else if (shift === 'afternoon') {
                tasks.push({ time: '13:30', task: 'ì˜¤í›„ ë°ìŠ¤í¬ êµëŒ€ ë° íŠ¹ì´ì‚¬í•­ ì²´í¬' });
                tasks.push({ time: '18:00', task: 'ì €ë… ì‹¬í™”ê°•ì˜ì‹¤ ì„¸íŒ… (ë§ˆì´í¬/ë¶„í•„/ë¬¼)' });
                tasks.push({ time: '19:00', task: 'ğŸ”´ [í•„ìˆ˜] ìµì¼ ì•„ì¹¨ ëª¨ì˜ê³ ì‚¬ í¸ì§‘ ë° ê²€ìˆ˜' });
                tasks.push({ time: '21:30', task: 'ì¼ì¼ ë§¤ì¶œ ë§ˆê° ë° ì†Œë“±/ë¬¸ë‹¨ì†' });
            }

            // Role Specific Additions
            if (role === 'head') {
                if (shift === 'morning') tasks.push({ time: '11:00', task: 'ì§ì› ê·¼íƒœ í™•ì¸ ë° ì—…ë¬´ ì§€ì‹œ' });
                tasks.push({ time: 'ìƒì‹œ', task: 'ìƒë‹´ ì´ê´„ ë° ë¯¼ì› 1ì°¨ í•´ê²°' });
            } else if (role === 'manager_m') {
                tasks.push({ time: 'ìƒì‹œ', task: 'ê°•ì˜ì‹¤/ë…ì„œì‹¤ ì‹œì„¤ ìˆœì°° ë° ìˆ˜ë¦¬' });
                if (shift === 'afternoon') tasks.push({ time: '20:00', task: 'êµì¬ íƒë°° ë°œì†¡ ë§ˆê°' });
            } else if (role === 'manager_f') {
                if (shift === 'morning') tasks.push({ time: '14:00', task: 'ì€í–‰ ì—…ë¬´ ë° íšŒê³„ ì •ë¦¬' });
                tasks.push({ time: 'ìƒì‹œ', task: 'í•©ê²©ì ë°ì´í„° ì •ë¦¬ ë° ê°•ì‚¬ ì˜ì „' });
            } else if (role === 'chief') {
                if (shift === 'afternoon') tasks.push({ time: '14:00', task: 'ë§ˆì¼€íŒ… ì™¸ì£¼ ì—…ì²´ ì†ŒìŠ¤ ì „ì†¡' });
                tasks.push({ time: 'ìƒì‹œ', task: 'ë…ì„œì‹¤/ì‚¬ë¬¼í•¨ ì ‘ìˆ˜ ëŒ€ì¥ ê´€ë¦¬' });
            }

            // Sort by time (simple sort)
            tasks.sort((a, b) => a.time.localeCompare(b.time));

            // Render
            output.innerHTML = `<ul class="space-y-2" > ` +
                tasks.map(t => `
                    <li class="flex items-start text-xs text-stone-700" >
                        <input type="checkbox" class="mt-0.5 mr-2">
                            <span><strong class="text-slate-800">[${t.time}]</strong> ${t.task}</span>
                        </li>
                `).join('') + `</ul > `;
            output.classList.remove('hidden');
        }

        function calculateGoal() {
            const goal = parseInt(document.getElementById('goal-total').value);
            const current = parseInt(document.getElementById('goal-current').value);
            const days = parseInt(document.getElementById('goal-days').value);
            const price = parseInt(document.getElementById('goal-price').value);
            const res = document.getElementById('goal-result');

            if (days <= 0) {
                res.innerHTML = "ë‚¨ì€ ì¼ìˆ˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.";
                res.classList.remove('hidden');
                return;
            }

            const remainingAmount = goal - current;
            const dailyAmount = Math.ceil(remainingAmount / days);
            const dailyCount = Math.ceil(dailyAmount / price);

            let messageClass = "text-blue-800";
            let message = "";

            if (remainingAmount <= 0) {
                message = "ğŸ‰ ì´ë¯¸ ëª©í‘œë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤! ì´ˆê³¼ ë‹¬ì„±ì— ë„ì „í•˜ì„¸ìš”!";
                messageClass = "text-green-700 font-bold";
            } else {
                message = `
                    <div class="text-xs text-blue-600 mb-1" > ëª©í‘œê¹Œì§€ <strong class="text-red-600" > ${remainingAmount.toLocaleString()}ë§Œì›</strong > ë‚¨ì•˜ìŠµë‹ˆë‹¤.</div >
                    <div class="text-lg font-bold text-slate-800 mb-1">ì˜¤ëŠ˜ ëª©í‘œ: ${dailyAmount.toLocaleString()} ë§Œì›</div>
                    <div class="bg-white rounded p-1 mt-1 border border-blue-200">
                        ğŸ‘‰ ì˜¤ëŠ˜ <strong class="text-red-600 text-lg">${dailyCount}ëª…</strong>ë§Œ ë“±ë¡ì‹œí‚¤ë©´ ë©ë‹ˆë‹¤!
                    </div>
                `;
            }

            res.innerHTML = message;
            res.className = `mt - 3 p - 3 rounded text - center border ${remainingAmount <= 0 ? 'bg-green-50 border-green-200' : 'bg-blue-50 border-blue-200'} `;
            res.classList.remove('hidden');
        }

        function calculateDDay() {
            const name = document.getElementById('event-name').value;
            const dateVal = document.getElementById('event-date').value;
            const res = document.getElementById('dday-result');

            if (!name || !dateVal) {
                res.innerText = "í–‰ì‚¬ëª…ê³¼ ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                res.classList.remove('hidden');
                return;
            }

            const dday = new Date(dateVal);

            // Helper to subtract days
            const subDays = (d, days) => {
                const newDate = new Date(d);
                newDate.setDate(d.getDate() - days);
                return newDate.toISOString().split('T')[0];
            };

            const schedule = [
                { d: 'D-30', date: subDays(dday, 30), task: 'ê¸°íšì•ˆ í™•ì • ë° TFíŒ€ ë°œì¡±', owner: 'ë¶€ì›ì¥' },
                { d: 'D-21', date: subDays(dday, 21), task: 'í™ˆí˜ì´ì§€ ë°°ë„ˆ ë° ë¸”ë¡œê·¸ í™ë³´ ì‹œì‘', owner: 'ì£¼ì„(ì—¬)' },
                { d: 'D-14', date: subDays(dday, 14), task: 'êµì¬ ì£¼ë¬¸ ë° ë¬¸ì ë°œì†¡(1ì°¨)', owner: 'ì‹¤ì¥/ëŒ€ë¦¬(ë‚¨)' },
                { d: 'D-7', date: subDays(dday, 7), task: 'ì‹œì„¤ ì ê²€ ë° ì‹ ì²­ì ì¤‘ê°„ ì§‘ê³„', owner: 'ì‹¤ì¥' },
                { d: 'D-1', date: subDays(dday, 1), task: 'ìµœì¢… ë¦¬ë§ˆì¸ë“œ ë¬¸ì ë° ê°•ì˜ì‹¤ ì„¸íŒ…', owner: 'ì „ ì§ì›' },
                { d: 'D-Day', date: dateVal, task: `ğŸ‰ ${name} ë‹¹ì¼ ìš´ì˜`, owner: 'ì‹¤ì¥ ì´ê´„' }
            ];

            res.innerHTML = `<h4 class="font-bold text-rose-800 mb-2" > ${name} ì¤€ë¹„ ì¼ì •</h4 > <ul class="space-y-1 text-xs">` +
                schedule.map(s => `
                    <li class="flex justify-between items-center border-b border-stone-100 pb-1">
                        <div>
                            <span class="font-bold text-rose-600 w-10 inline-block">${s.d}</span>
                            <span class="text-stone-500 text-[10px] mr-1">(${s.date})</span>
                            <span class="text-stone-700">${s.task}</span>
                        </div>
                        <span class="text-[10px] bg-stone-100 px-1.5 py-0.5 rounded text-stone-500">${s.owner}</span>
                    </li>
                    `).join('') + `</ul>`;
            res.classList.remove('hidden');
        }

        function generateMarketingPlan() {
            const season = document.getElementById('mkt-season').value;
            const res = document.getElementById('mkt-result');

            let tasks = [];

            if (season === 'normal') {
                tasks = [
                    { type: 'SNS', task: 'í•™ì› ì¼ìƒ(ê¸‰ì‹, ììŠµì‹¤) ì‚¬ì§„ 3ì¥ ì´¬ì˜ í›„ ì™¸ì£¼ ì „ë‹¬' },
                    { type: 'ë°”ì´ëŸ´', task: 'ê²½ì‹œëª¨/ê²½ê¿ˆì‚¬ "ì§€ì—­+ê²½ì°°í•™ì›" í‚¤ì›Œë“œ ê²€ìƒ‰ ë° ì—¬ë¡  ì²´í¬ (ì£¼ 3íšŒ)' },
                    { type: 'ì½˜í…ì¸ ', task: 'í•©ê²©ìƒ/ì¬ì›ìƒ ì¸í„°ë·° 1ëª… ì§„í–‰ (í•©ê²©ìˆ˜ê¸° ì†ŒìŠ¤ í™•ë³´)' },
                    { type: 'DB', task: 'ë¯¸ë“±ë¡ ìƒë‹´ì ì•ˆë¶€ ë¬¸ì ë°œì†¡ (ë¬´ë£Œ íŠ¹ê°• ë¯¸ë¼ íˆ¬ì²™)' }
                ];
            } else if (season === 'recruitment') {
                tasks = [
                    { type: 'SNS', task: 'ê°œê°• D-Day ì¹´ìš´íŠ¸ë‹¤ìš´ ì¹´ë“œë‰´ìŠ¤ ì œì‘ ìš”ì²­ (ë””ìì´ë„ˆì—ê²Œ)' },
                    { type: 'ë°”ì´ëŸ´', task: 'ì£¼ìš” ì»¤ë®¤ë‹ˆí‹° "ìˆ˜ê°•ë£Œ/ì‹œê°„í‘œ" ì§ˆë¬¸ê¸€ì— ìª½ì§€/ëŒ“ê¸€ ì‘ì—…' },
                    { type: 'ë¬¸ì', task: 'ê¸°ì¡´ DB ëŒ€ìƒ "ì¡°ê¸°ë“±ë¡ í• ì¸ ë§ˆê°ì„ë°•" ì „ì²´ ë¬¸ì ë°œì†¡' },
                    { type: 'í˜„ì¥', task: 'ì›ë‚´ ê²Œì‹œíŒ ë° ë°°ë„ˆ "ë§ˆê°ì„ë°•" ë”±ì§€ ë¶€ì°©' }
                ];
            } else if (season === 'exam') {
                tasks = [
                    { type: 'ì½˜í…ì¸ ', task: 'ê°•ì‚¬ë‹˜ "íŒŒì´ë„ ì°ê¸°" ìˆí¼ ì˜ìƒ ì´¬ì˜ (í°ìœ¼ë¡œ 1ë¶„ ì»·)' },
                    { type: 'SNS', task: 'ì‹œí—˜ ì‘ì› ê°„ì‹ ì´ë²¤íŠ¸ ê³µì§€ ì˜¬ë¦¬ê¸°' },
                    { type: 'ë°”ì´ëŸ´', task: 'ì‹œí—˜ ì§í›„ "ê°€ë‹µì•ˆ/í•´ì„¤ê°•ì˜" ìš°ë¦¬ í•™ì›ì´ ì œì¼ ë¹ ë¥´ë‹¤ê³  í™ë³´' },
                    { type: 'DB', task: 'ì‹œí—˜ì¥ ì‘ì› ìº í˜ì¸ ë¬¸ì ë°œì†¡' }
                ];
            }

            res.innerHTML = `<ul class="space-y-2" > ` +
                tasks.map(t => `
                    <li class="flex items-start" >
                        <span class="inline-block px-1.5 py-0.5 rounded bg-purple-100 text-purple-800 font-bold mr-2 text-[10px] w-12 text-center flex-shrink-0">${t.type}</span>
                        <span class="text-stone-700">${t.task}</span>
                    </li >
                    `).join('') + `</ul > `;
            res.classList.remove('hidden');
        }

        // --- Toolkit View (Updated with AI & Feedback) ---
        function renderToolkit(container) {
            container.innerHTML = `
                        <div class="bg-white p-8 rounded-lg shadow-sm border border-stone-200" >
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">ğŸ§  ìŠ¤ë§ˆíŠ¸ ì—…ë¬´ í•´ê²° ì•Œê³ ë¦¬ì¦˜</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6 mb-8">
                        <!-- Fogg Model Input -->
                        <div class="bg-stone-50 p-6 rounded-lg border border-stone-200 flex flex-col h-full">
                            <h3 class="font-bold text-lg mb-4 text-indigo-700">í¬ê·¸ í–‰ë™ ëª¨ë¸ (ë“±ë¡ ìœ ë„)</h3>
                            <p class="text-sm text-stone-500 mb-4">í•™ìƒ ë“±ë¡ ìœ ë„ ë¬¸ìë‚˜ ìƒë‹´ ë©˜íŠ¸ê°€ ë§‰í ë•Œ ì‚¬ìš©í•˜ì„¸ìš”.</p>
                            <div class="space-y-3 flex-grow">
                                <div>
                                    <label class="block text-xs font-bold text-stone-600 uppercase">íƒ€ê²Ÿ ìƒí™© (Target)</label>
                                    <input type="text" id="fogg-target" placeholder="ì˜ˆ: ì„¤ëª…íšŒ ì°¸ì„ í›„ ë¯¸ë“±ë¡ í•™ìƒ" class="w-full p-2 border border-stone-300 rounded text-sm">
                                </div>
                                <button onclick="solveFoggWithAI()" class="w-full bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-700 transition flex justify-center items-center">
                                    <span id="fogg-loading" class="ai-loading hidden mr-2"></span>
                                    <span>âœ¨ AI ë¬¸ì ìƒì„±</span>
                                </button>
                            </div>
                            <div id="fogg-result" class="mt-4 text-sm font-medium text-indigo-800 hidden bg-indigo-50 p-4 rounded border border-indigo-100 leading-relaxed whitespace-pre-wrap"></div>
                        </div>

                        <!-- 5 Whys Input -->
                        <div class="bg-stone-50 p-6 rounded-lg border border-stone-200 flex flex-col h-full">
                            <h3 class="font-bold text-lg mb-4 text-teal-700">5 Whys (ê·¼ë³¸ ì›ì¸ ë¶„ì„)</h3>
                            <p class="text-sm text-stone-500 mb-4">ë°˜ë³µë˜ëŠ” ë¬¸ì œì˜ ì§„ì§œ ì›ì¸ê³¼ í•´ê²°ì±…ì„ ë¶„ì„í•©ë‹ˆë‹¤.</p>
                            <div class="space-y-3 flex-grow">
                                <div>
                                    <label class="block text-xs font-bold text-stone-600 uppercase">ë°œìƒí•œ ë¬¸ì œ</label>
                                    <input type="text" id="why-problem" placeholder="ì˜ˆ: ë§¤ì£¼ ì›”ìš”ì¼ ì§€ê°ìƒ í­ì¦" class="w-full p-2 border border-stone-300 rounded text-sm">
                                </div>
                                <button onclick="solveWhyWithAI()" class="w-full bg-teal-600 text-white py-2 rounded font-bold hover:bg-teal-700 transition flex justify-center items-center">
                                    <span id="why-loading" class="ai-loading hidden mr-2"></span>
                                    <span>âœ¨ AI ì‹¬ì¸µ ë¶„ì„</span>
                                </button>
                            </div>
                            <div id="why-result" class="mt-4 text-sm text-teal-800 hidden bg-teal-50 p-4 rounded border border-teal-100 leading-relaxed whitespace-pre-wrap"></div>
                        </div>

                        <!-- Counseling Script Generator -->
                        <div class="bg-rose-50 p-6 rounded-lg border border-rose-200 flex flex-col h-full">
                            <h3 class="font-bold text-lg mb-4 text-rose-700">ğŸ›¡ï¸ ìƒë‹´ ë°©ì–´ ìŠ¤í¬ë¦½íŠ¸</h3>
                            <p class="text-sm text-stone-500 mb-4">í™˜ë¶ˆ, ì»´í”Œë ˆì¸ ë“± ê¹Œë‹¤ë¡œìš´ ìƒí™©ì˜ ëŒ€í™” ëŒ€ë³¸ì„ ìƒì„±í•©ë‹ˆë‹¤.</p>
                            <div class="space-y-3 flex-grow">
                                <div>
                                    <label class="block text-xs font-bold text-stone-600 uppercase">ë¯¼ì› ë‚´ìš©</label>
                                    <input type="text" id="script-target" placeholder="ì˜ˆ: ì „ì•¡ í™˜ë¶ˆ ìš”êµ¬í•˜ë©° ê³ ì„±" class="w-full p-2 border border-stone-300 rounded text-sm">
                                </div>
                                <button onclick="generateScriptWithAI()" class="w-full bg-rose-600 text-white py-2 rounded font-bold hover:bg-rose-700 transition flex justify-center items-center">
                                    <span id="script-loading" class="ai-loading hidden mr-2"></span>
                                    <span>âœ¨ AI ëŒ€ë³¸ ìƒì„±</span>
                                </button>
                            </div>
                            <div id="script-result" class="mt-4 text-sm font-medium text-rose-800 hidden bg-rose-50 p-4 rounded border border-rose-100 leading-relaxed whitespace-pre-wrap"></div>
                        </div>

                        <!-- NEW: Staff Feedback Coach -->
                        <div class="bg-amber-50 p-6 rounded-lg border border-amber-200 flex flex-col h-full">
                            <h3 class="font-bold text-lg mb-4 text-amber-700">ğŸ’Œ ì§ì› í”¼ë“œë°± ì½”ì¹­</h3>
                            <p class="text-sm text-stone-500 mb-4">ì‹¤ì¥ë‹˜ì´ ì§ì›ì—ê²Œ ì§€ì í•˜ê±°ë‚˜ ì¹­ì°¬í•  ë•Œ ì“¸ ë©˜íŠ¸ë¥¼ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.</p>
                            <div class="space-y-3 flex-grow">
                                <div>
                                    <label class="block text-xs font-bold text-stone-600 uppercase">ìƒí™© ë° ëŒ€ìƒ</label>
                                    <input type="text" id="feedback-target" placeholder="ì˜ˆ: ê¹€ëŒ€ë¦¬ 3ì¼ ì—°ì† ì§€ê°" class="w-full p-2 border border-stone-300 rounded text-sm">
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="generateFeedbackWithAI('scold')" class="flex-1 bg-amber-600 text-white py-2 rounded font-bold hover:bg-amber-700 transition text-xs">ë¶€ë“œëŸ¬ìš´ ì§€ì </button>
                                    <button onclick="generateFeedbackWithAI('praise')" class="flex-1 bg-emerald-600 text-white py-2 rounded font-bold hover:bg-emerald-700 transition text-xs">í™•ì‹¤í•œ ì¹­ì°¬</button>
                                </div>
                                <div id="feedback-loading" class="hidden text-center"><div class="ai-loading"></div></div>
                            </div>
                            <div id="feedback-result" class="mt-4 text-sm font-medium text-amber-900 hidden bg-amber-100 p-4 rounded border border-amber-200 leading-relaxed whitespace-pre-wrap"></div>
                        </div>
                    </div>

                    <!--1 - 3 - 1 Report Generator-- >
                    <div class="bg-slate-50 p-6 rounded-lg border border-slate-200">
                        <h3 class="font-bold text-lg mb-4 text-slate-800">ğŸ“ 1-3-1 ë³´ê³ ì„œ ìƒì„±ê¸°</h3>
                        <p class="text-sm text-stone-500 mb-4">ì‹¤ì¥ì—ê²Œ ë°›ì€ ë‚ ê²ƒì˜ ë³´ê³  ë‚´ìš©ì„ ì…ë ¥í•˜ë©´, ëŒ€í‘œë‹˜ê»˜ ë³´ê³ í•  ìˆ˜ ìˆëŠ” ê¹”ë”í•œ '1-3-1 í¬ë§·'ìœ¼ë¡œ ë³€í™˜í•´ì¤ë‹ˆë‹¤.</p>

                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-bold text-stone-600 uppercase">ì›ë¬¸ ë‚´ìš© (Raw Data)</label>
                                <textarea id="report-raw" rows="3" placeholder="ì˜ˆ: ì˜¤ëŠ˜ ë¹„ì™€ì„œ ìƒë‹´ 2ëª…ë°–ì— ì•ˆ ì™”ì–´ìš”. ê·¼ë° ì „í™” ë¬¸ì˜ëŠ” ì¢€ ìˆì—ˆê³ ..." class="w-full p-2 border border-stone-300 rounded text-sm"></textarea>
                            </div>
                            <button onclick="generateReportWithAI()" class="w-full bg-slate-700 text-white py-2 rounded font-bold hover:bg-slate-800 transition flex justify-center items-center">
                                <span id="report-loading" class="ai-loading hidden mr-2"></span>
                                <span>âœ¨ ë³´ê³ ì„œ ìë™ ìƒì„±</span>
                            </button>
                        </div>
                        <div id="report-result" class="mt-4 text-sm font-medium text-slate-800 hidden bg-white p-4 rounded border border-slate-200 leading-relaxed whitespace-pre-wrap"></div>
                    </div>
                </div >
                    `;
        }

        async function generateReportWithAI() {
            const raw = document.getElementById('report-raw').value;
            const res = document.getElementById('report-result');
            const loading = document.getElementById('report-loading');

            if (!raw) {
                res.innerText = "ë³´ê³  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                res.classList.remove('hidden');
                return;
            }

            loading.classList.remove('hidden');
            res.classList.add('hidden');

            const prompt = `
                ì›ë¬¸: ${raw}
                ìš”ì²­: ìœ„ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ëŒ€í‘œë‹˜ê»˜ ë³´ê³ í•  '1-3-1 ë³´ê³ ì„œ'ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.
                    í˜•ì‹:
                1. ê²°ë¡ (1ì¤„): ì „ì²´ ìš”ì•½(ê¸ì • / ë¶€ì • íŒë‹¨ í¬í•¨)
                2. ê·¼ê±°(3ê°€ì§€): ìˆ˜ì¹˜ë‚˜ íŒ©íŠ¸ ìœ„ì£¼ë¡œ 3ê°€ì§€ í¬ì¸íŠ¸
                3. ì œì•ˆ(1ì¤„): í–¥í›„ ê³„íšì´ë‚˜ ìŠ¹ì¸ ìš”ì²­ ì‚¬í•­
                ì–´ì¡°: ì •ì¤‘í•˜ê³  ëª…í™•í•œ ê²½ì˜ì§„ ë³´ê³  í†¤.
            `;

            const aiResponse = await callGeminiAPI(prompt);

            loading.classList.add('hidden');
            res.innerHTML = aiResponse.replace(/\n/g, '<br>');
            res.classList.remove('hidden');
        }

        async function solveFoggWithAI() {
            const target = document.getElementById('fogg-target').value;
            const res = document.getElementById('fogg-result');
            const loading = document.getElementById('fogg-loading');

            if (!target) {
                res.innerText = "ìƒí™©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                res.classList.remove('hidden');
                return;
            }

            loading.classList.remove('hidden');
            res.classList.add('hidden');

            const prompt = `
                ìƒí™©: ${target}
                ìš”ì²­: í¬ê·¸ í–‰ë™ ëª¨ë¸(Fogg Behavior Model, B = MAP)ì„ ì ìš©í•˜ì—¬ ì´ í•™ìƒë“¤ì´ ì¦‰ì‹œ ë“±ë¡í•˜ë„ë¡ ìœ ë„í•˜ëŠ” ë¬¸ì ë©”ì‹œì§€(SMS) ë‚´ìš© 3ê°€ì§€ ë²„ì „ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.
                1. Motivation ê°•ì¡°í˜•(ê³µí¬ / ê¸°íšŒ)
                2. Ability ê°•ì¡°í˜•(í• ì¸ / í˜œíƒ)
                3. Prompt ê°•ì¡°í˜•(ë§ˆê°ì„ë°•)
                ê° ë¬¸êµ¬ëŠ” í•œêµ­ê²½ì°°í•™ì› ì‹¤ì¥ì´ ë³´ë‚´ëŠ” ê²ƒì²˜ëŸ¼ ì •ì¤‘í•˜ë©´ì„œë„ ê°•ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.
            `;

            const aiResponse = await callGeminiAPI(prompt);

            loading.classList.add('hidden');
            res.innerHTML = aiResponse.replace(/\n/g, '<br>');
            res.classList.remove('hidden');
        }

        async function solveWhyWithAI() {
            const problem = document.getElementById('why-problem').value;
            const res = document.getElementById('why-result');
            const loading = document.getElementById('why-loading');

            if (!problem) {
                res.innerText = "ë¬¸ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                res.classList.remove('hidden');
                return;
            }

            loading.classList.remove('hidden');
            res.classList.add('hidden');

            const prompt = `
                ë¬¸ì œ: ${problem}
                ìš”ì²­: '5 Whys' ê¸°ë²•ì„ ì‚¬ìš©í•˜ì—¬ ì´ ë¬¸ì œì˜ ê·¼ë³¸ ì›ì¸ì„ íŒŒê³ ë“œëŠ” 5ë‹¨ê³„ ì§ˆë¬¸ê³¼ ë‹µë³€ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‘ì„±í•˜ê³ , ìµœì¢…ì ìœ¼ë¡œ ê·¼ë³¸ì ì¸ í•´ê²°ì±…(Root Cause Solution)ì„ ì œì‹œí•´ì£¼ì„¸ìš”.í•™ì› ìš´ì˜ì˜ ê´€ì ì—ì„œ ë¶„ì„í•´ì£¼ì„¸ìš”.
            `;

            const aiResponse = await callGeminiAPI(prompt);

            loading.classList.add('hidden');
            res.innerHTML = aiResponse.replace(/\n/g, '<br>');
            res.classList.remove('hidden');
        }

        async function generateScriptWithAI() {
            const target = document.getElementById('script-target').value;
            const res = document.getElementById('script-result');
            const loading = document.getElementById('script-loading');

            if (!target) {
                res.innerText = "ìƒí™©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                res.classList.remove('hidden');
                return;
            }

            loading.classList.remove('hidden');
            res.classList.add('hidden');

            const prompt = `
                ìƒí™©: ${target}
                ì—­í• : í•œêµ­ê²½ì°°í•™ì› ìš´ì˜ ì‹¤ì¥(10ë…„ì°¨ ë² í…Œë‘, ì •ì¤‘í•˜ì§€ë§Œ ë‹¨í˜¸í•¨)
                ìš”ì²­: ìœ„ ìƒí™©ì—ì„œ í•™ìƒ / í•™ë¶€ëª¨ë¥¼ ì‘ëŒ€í•  ìˆ˜ ìˆëŠ” 'ëŒ€í™” ìŠ¤í¬ë¦½íŠ¸'ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.
                    ë‹¨ê³„:
                1. ê³µê° ë° ê²½ì²­(ìƒëŒ€ë°© í™” ê°€ë¼ì•‰íˆê¸°)
                2. ê·œì • ì„¤ëª…(ê°ê´€ì  ì‚¬ì‹¤ ì „ë‹¬)
                3. ëŒ€ì•ˆ ì œì‹œ(ìš°ë¦¬ê°€ í•´ì¤„ ìˆ˜ ìˆëŠ” ìµœì„ )
                4. ë§ˆë¬´ë¦¬(ì¬ë°œ ë°©ì§€ ì•½ì†)
                ë§íˆ¬: ë¹„ì¦ˆë‹ˆìŠ¤ ë§¤ë„ˆë¥¼ ê°–ì¶”ë˜, íœ˜ë‘˜ë¦¬ì§€ ì•ŠëŠ” ì „ë¬¸ì ì¸ í†¤.
            `;

            const aiResponse = await callGeminiAPI(prompt);

            loading.classList.add('hidden');
            res.innerHTML = aiResponse.replace(/\n/g, '<br>');
            res.classList.remove('hidden');
        }

        async function generateFeedbackWithAI(type) {
            const target = document.getElementById('feedback-target').value;
            const res = document.getElementById('feedback-result');
            const loading = document.getElementById('feedback-loading');

            if (!target) {
                res.innerText = "ìƒí™©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                res.classList.remove('hidden');
                return;
            }

            loading.classList.remove('hidden');
            res.classList.add('hidden');

            let promptType = type === 'scold' ? 'ë¶€ë“œëŸ¬ìš°ë©´ì„œë„ ë‹¨í˜¸í•˜ê²Œ í–‰ë™ êµì •ì„ ìš”êµ¬í•˜ëŠ” í”¼ë“œë°±(ìƒŒë“œìœ„ì¹˜ í™”ë²•)' : 'êµ¬ì²´ì ì¸ ì‚¬ì‹¤ì„ ë“¤ì–´ ë™ê¸°ë¶€ì—¬ë¥¼ ê·¹ëŒ€í™”í•˜ëŠ” ì¹­ì°¬ í”¼ë“œë°±';
            const prompt = `
                ìƒí™©: ${target}
                ì—­í• : Fì„±í–¥ì˜ ìš´ì˜ ì‹¤ì¥ì´ ë¶€í•˜ ì§ì›ì—ê²Œ ë§í•¨.
                    ìš”ì²­: ${promptType} ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.
                        ëª©í‘œ: ê°ì • ìƒí•˜ì§€ ì•Šê²Œ í•˜ë©´ì„œ í–‰ë™ ë³€í™”ë¥¼ ì´ëŒì–´ë‚´ê±°ë‚˜ ì‚¬ê¸°ë¥¼ ë†’ì´ëŠ” ê²ƒ.
            `;

            const aiResponse = await callGeminiAPI(prompt);

            loading.classList.add('hidden');
            res.innerHTML = aiResponse.replace(/\n/g, '<br>');
            res.classList.remove('hidden');
        }

        // --- AI Copilot View (New) ---
        function renderAICopilot(container) {
            container.innerHTML = `
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200 h-[600px] flex flex-col" >
                    <div class="flex items-center justify-between border-b pb-4 mb-4">
                        <div class="flex items-center">
                            <div class="bg-indigo-600 text-white p-2 rounded-lg mr-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-slate-800">AI ìš´ì˜ ì»¨ì„¤í„´íŠ¸</h2>
                                <p class="text-xs text-stone-500">Gemini 3.0 Flash Powered Â· Manual Grounded</p>
                            </div>
                        </div>
                    </div>

                    <div id="chat-messages" class="flex-grow overflow-y-auto space-y-4 mb-4 p-4 bg-stone-50 rounded-lg border border-stone-100">
                        <div class="flex items-start">
                            <div class="bg-indigo-100 text-indigo-800 p-3 rounded-lg rounded-tl-none max-w-[80%] text-sm">
                                ì•ˆë…•í•˜ì„¸ìš”, ë¶€ì›ì¥ë‹˜. <strong>í•œêµ­ê²½ì°°í•™ì› AI ìš´ì˜ íŒŒíŠ¸ë„ˆ</strong>ì…ë‹ˆë‹¤.<br>
                                ì¡°ì§ ìš´ì˜ ë§¤ë‰´ì–¼ì— ê¸°ë°˜í•˜ì—¬ ìƒí™©ë³„ ëŒ€ì²˜ë²•, ë³´ê³  ë¼ì¸, ë§ˆì¼€íŒ… ë¬¸êµ¬ ë“±ì„ ì¡°ì–¸í•´ ë“œë¦½ë‹ˆë‹¤.<br>
                                ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <input type="text" id="chat-input" 
                            class="flex-grow p-3 border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            placeholder="ì˜ˆ: 'í•™ìƒì´ í™˜ë¶ˆ ê·œì •ì— ë¶ˆë§Œì„ í’ˆê³  ì†Œë¦¬ë¥¼ ì§€ë¦…ë‹ˆë‹¤. ëˆ„ê°€ ì²˜ë¦¬í•´ì•¼ í•˜ë‚˜ìš”?'"
                            onkeypress="if(event.key === 'Enter') sendChatMessage()">
                        <button onclick="sendChatMessage()" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-indigo-700 transition flex items-center">
                            ì „ì†¡
                        </button>
                    </div>
                </div>
                `;
        }

        async function sendChatMessage() {
            const inputEl = document.getElementById('chat-input');
            const msgContainer = document.getElementById('chat-messages');
            const userMsg = inputEl.value.trim();

            if (!userMsg) return;

            // User Message Bubble
            const userBubble = document.createElement('div');
            userBubble.className = "flex items-center justify-end";
            userBubble.innerHTML = `<div class="bg-slate-800 text-white p-3 rounded-lg rounded-tr-none max-w-[80%] text-sm" > ${userMsg}</div > `;
            msgContainer.appendChild(userBubble);

            inputEl.value = '';
            msgContainer.scrollTop = msgContainer.scrollHeight;

            // AI Loading Bubble
            const loadingBubble = document.createElement('div');
            loadingBubble.className = "flex items-start ai-response-loading";
            loadingBubble.innerHTML = `<div class="bg-white border border-stone-200 p-3 rounded-lg rounded-tl-none" > <div class="ai-loading"></div></div > `;
            msgContainer.appendChild(loadingBubble);
            msgContainer.scrollTop = msgContainer.scrollHeight;

            // API Call
            const aiText = await callGeminiAPI(userMsg);

            // Replace Loading with Response
            msgContainer.removeChild(loadingBubble);
            const aiBubble = document.createElement('div');
            aiBubble.className = "flex items-start";
            aiBubble.innerHTML = `<div class="bg-indigo-50 border border-indigo-100 text-slate-800 p-4 rounded-lg rounded-tl-none max-w-[90%] text-sm leading-relaxed shadow-sm" > ${aiText.replace(/\n/g, '<br>')}</div >`;
            msgContainer.appendChild(aiBubble);
            msgContainer.scrollTop = msgContainer.scrollHeight;
        }

        // Initialize App
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>

</html>
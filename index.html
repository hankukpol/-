<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>?úÍµ≠Í≤ΩÏ∞∞?ôÏõê Ï°∞ÏßÅ ?¥ÏòÅ Îß§Îâ¥??& ?ÖÎ¨¥ Î∂ÑÏû•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f5f5f4;
            /* Warm neutral background */
            color: #1c1917;
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #d6d3d1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a29e;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .tab-active {
            border-bottom: 2px solid #0f172a;
            color: #0f172a;
            font-weight: 700;
        }

        .org-line {
            position: absolute;
            background-color: #cbd5e1;
            z-index: 0;
        }

        /* Reporting Flow Animation */
        .flow-path {
            transition: all 0.5s ease;
        }

        .flow-active {
            background-color: #3b82f6;
            /* Blue for Routine */
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.5);
        }

        .flow-urgent {
            background-color: #ef4444;
            /* Red for TF/Urgent */
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
        }

        /* AI Loading Animation */
        .ai-loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(99, 102, 241, 0.3);
            border-radius: 50%;
            border-top-color: #6366f1;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <!-- Navigation -->
    <nav class="bg-white border-b border-stone-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <span class="text-xl font-bold text-slate-800 cursor-pointer"
                            onclick="loadView('dashboard')">?èõÔ∏??úÍµ≠Í≤ΩÏ∞∞?ôÏõê ?¥ÏòÅÎ≥∏Î?</span>
                    </div>
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8" id="nav-container">
                        <!-- Nav items injected by JS -->
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <div id="sync-indicator" class="hidden md:block text-xs text-gray-500"></div>
                    <div id="ai-status" class="hidden md:block text-xs text-indigo-600 font-bold animate-pulse">??Gemini
                        3.0</div>
                    <button onclick="openApiSettings()" class="text-stone-400 hover:text-stone-600" title="API ?§Ï†ï">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                    <span class="text-sm text-stone-500 bg-stone-100 px-3 py-1 rounded-full">Ï¥ùÍ¥Ñ Î∂Ä?êÏû• Î™®Îìú</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-grow bg-stone-50 py-8 px-4 sm:px-6 lg:px-8 relative">
        <div id="content-area" class="max-w-7xl mx-auto">
            <!-- Content injected by JS -->
        </div>

        <!-- API Key Modal -->
        <div id="api-modal"
            class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
            <div class="relative mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">?îë ?úÏä§???§Ï†ï</h3>
                    <div class="mt-2 px-7 py-3">
                        <!-- Gemini API Key -->
                        <div class="mb-4">
                            <p class="text-sm text-gray-500 mb-2 text-left">
                                <strong>AI Í∏∞Îä• (?†ÌÉù)</strong><br>
                                Google Gemini API ?§Î? ?ÖÎ†•?òÎ©¥ AI Í∏∞Îä•???¨Ïö©?????àÏäµ?àÎã§.
                            </p>
                            <input type="password" id="api-key-input" class="w-full p-2 border rounded text-sm mb-2"
                                placeholder="Gemini API Key ?ÖÎ†•">
                            <a href="https://aistudio.google.com/app/apikey" target="_blank"
                                class="text-xs text-blue-500 hover:underline">API ??Î∞úÍ∏âÎ∞õÍ∏∞ (Î¨¥Î£å)</a>
                        </div>

                        <!-- Google Sheets Web App URL -->
                        <div class="mb-4 border-t pt-4">
                            <p class="text-sm text-gray-500 mb-2 text-left">
                                <strong>Google Sheets ?ôÍ∏∞??(?ÑÏàò)</strong><br>
                                ?¨Îü¨ Í∏∞Í∏∞?êÏÑú ?∞Ïù¥?∞Î? Í≥µÏú†?òÎ†§Î©?Web App URL???ÖÎ†•?òÏÑ∏??
                            </p>
                            <input type="text" id="sheets-url-input" class="w-full p-2 border rounded text-sm mb-2"
                                placeholder="https://script.google.com/macros/s/...">
                            <button onclick="testSheetsConnection()"
                                class="text-xs bg-green-100 text-green-700 px-3 py-1 rounded hover:bg-green-200 w-full">
                                ?∞Í≤∞ ?åÏä§??
                            </button>
                            <div id="sheets-test-result" class="text-xs mt-2 hidden"></div>
                        </div>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button onclick="saveSettings()"
                            class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-300">
                            ?Ä??Î∞??∞Í≤∞
                        </button>
                        <button onclick="closeApiSettings()"
                            class="mt-2 px-4 py-2 bg-gray-100 text-gray-700 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-200 focus:outline-none">
                            ?´Í∏∞
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-stone-200 mt-auto">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <p class="text-center text-sm text-stone-400">Korea Police Academy Internal Operation System V3.3 Standalone
            </p>
            <button onclick="resetAllData()" class="text-xs text-red-300 hover:text-red-500 underline">?∞Ïù¥??Ï¥àÍ∏∞??/button>
        </div>
    </footer>

    <script>
        // API Key Management
        let userApiKey = localStorage.getItem('gemini_api_key') || "";

        // Google Sheets Integration
        let sheetsWebAppUrl = localStorage.getItem('sheets_webapp_url') || "https://script.google.com/macros/s/AKfycbyegLIoTBOBzaJeukqv8-cx9lGCdsnHTEBObyk21EQoUfPx01xWT00FmZhUyDOlsEEPBA/exec";
        let syncStatus = { connected: false, syncing: false, lastSync: null };
        const sheetsProxyBase = '/.netlify/functions/sheets-proxy';

        function buildSheetsProxyUrl(action, webAppUrl) {
            const params = new URLSearchParams({
                url: webAppUrl || sheetsWebAppUrl,
                action
            });
            return `${sheetsProxyBase}?${params.toString()}`;
        }

        function openApiSettings() {
            document.getElementById('api-key-input').value = userApiKey;
            document.getElementById('sheets-url-input').value = sheetsWebAppUrl;
            document.getElementById('api-modal').classList.remove('hidden');
        }

        function closeApiSettings() {
            document.getElementById('api-modal').classList.add('hidden');
        }

        function saveSettings() {
            const key = document.getElementById('api-key-input').value.trim();
            const url = document.getElementById('sheets-url-input').value.trim();

            // Save API Key
            if (key) {
                userApiKey = key;
                localStorage.setItem('gemini_api_key', key);
            }

            // Save Sheets URL
            if (url) {
                sheetsWebAppUrl = url;
                localStorage.setItem('sheets_webapp_url', url);
                syncStatus.connected = true;
            }

            if (key || url) {
                alert("?§Ï†ï???Ä?•Îêò?àÏäµ?àÎã§.");
                closeApiSettings();

                // Update UI status
                const status = document.getElementById('ai-status');
                if (status && key) status.classList.remove('hidden');

                // If Sheets URL is set, try to sync
                if (url) {
                    syncFromSheets();
                }
            } else {
                alert("ÏµúÏÜå???òÎÇò???§Ï†ï???ÖÎ†•?¥Ï£º?∏Ïöî.");
            }
        }

        async function testSheetsConnection() {
            const url = document.getElementById('sheets-url-input').value.trim();
            const resultDiv = document.getElementById('sheets-test-result');

            if (!url) {
                resultDiv.className = 'text-xs mt-2 text-red-600';
                resultDiv.innerText = '??URL???ÖÎ†•?¥Ï£º?∏Ïöî.';
                resultDiv.classList.remove('hidden');
                return;
            }

            resultDiv.className = 'text-xs mt-2 text-blue-600';
            resultDiv.innerText = '???∞Í≤∞ ?åÏä§??Ï§?..';
            resultDiv.classList.remove('hidden');

            try {
                const response = await fetch(buildSheetsProxyUrl('getData', url));
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();

                if (data.error) {
                    resultDiv.className = 'text-xs mt-2 text-red-600';
                    resultDiv.innerText = `???§Î•ò: ${data.error}`;
                } else {
                    resultDiv.className = 'text-xs mt-2 text-green-600';
                    resultDiv.innerText = '???∞Í≤∞ ?±Í≥µ! ?Ä??Î≤ÑÌäº???åÎü¨Ï£ºÏÑ∏??';
                }
            } catch (error) {
                resultDiv.className = 'text-xs mt-2 text-red-600';
                resultDiv.innerText = `???∞Í≤∞ ?§Ìå®: ${error.message}`;
            }
        }

        // --- Default Data Store ---
        const defaultAppData = {
            roles: [
                {
                    id: 'vice_director',
                    title: 'Ï¥ùÍ¥Ñ Î∂Ä?êÏû•',
                    subtitle: 'COO (Chief Operating Officer)',
                    icon: '?ëë',
                    summary: 'Í∑∏Î£π ?ÑÏ≤¥ ?ÑÎûµ ?òÎ¶Ω, ?Ä???ëÎ†•, ?∏ÏÇ¨Í∂??âÏÇ¨. ?§Î¨¥?êÏÑú Î≤óÏñ¥???§Í≥Ñ?Ä Í∞êÎèÖ??ÏßëÏ§ë.',
                    kpi: ['Îß§Ï∂ú Î™©Ìëú ?¨ÏÑ±Î•?, '?ÅÏóÖ?¥ÏùµÎ•?, 'ÏßÅÏõê ÎßåÏ°±???¥ÏÇ¨??', '?†Í∑ú ?úÌú¥ Í±¥Ïàò'],
                    main_duties: [
                        { cat: 'Í≤ΩÏòÅÍ∏∞Ìöç', desc: 'Í≤ΩÏüÅ??Î∂ÑÏÑù, ÎßàÏ???Ïª®ÏÖâ, ?ôÏÇ¨?ºÏ†ï ÏµúÏ¢Ö ?πÏù∏' },
                        { cat: '?Ä?∏Ìòë??, desc: '?Ä?ôÍµê/?∏Î??ÖÏ≤¥ MOU, Í∞ïÏÇ¨ ?ÅÏûÖ Î∞?Í≥ÑÏïΩ' },
                        { cat: '?∏ÏÇ¨/?ÅÎã¥', desc: 'Ï±ÑÏö©, ?∞Î¥â?ëÏÉÅ, VIP ?ÖÏÑ± ÎØºÏõê ?¥Í≤∞' }
                    ],
                    sub_duties: [
                        { role: '?§Ïû•', desc: '?§Ïû• Î∂Ä?????ÑÏû• ÏßÄ??Î∞?ÎπÑÏÉÅ ?ÅÌô© Í≤∞Ï†ï' }
                    ],
                    algorithm: '???êÎ¶¨ ?¨Í≥† (First Principles): Í¥Ä?âÏùÑ ?Ä?åÌïòÍ≥?Î≥∏Ïßà(?©Í≤©)??ÏßëÏ§ë???¨ÏóÖ ?¨ÏÑ§Í≥?'
                },
                {
                    id: 'head_manager',
                    title: '?¥ÏòÅ ?§Ïû•',
                    subtitle: 'Head of Operation',
                    icon: '?´°',
                    summary: '?ÑÏû• ?¥ÏòÅ???ÑÍ≤∞Í∂åÏûê. ?ÅÎã¥ Ï¥ùÍ¥Ñ, Îß§Ï∂ú ?§Ìñâ, ÏßÅÏõê Í¥ÄÎ¶¨Î? Ï±ÖÏûÑÏßÄ???àÎ∞© ?¥Î¶ºÍæ?',
                    kpi: ['??Ï¥?Îß§Ï∂ú', '?†Í∑ú ?±Î°ùÎ•?, 'ÎØºÏõê ?¥Í≤∞ Í±¥Ïàò', 'ÏßÅÏõê Í∑ºÌÉú Ï§Ä?òÏú®'],
                    main_duties: [
                        { cat: '?¥ÏòÅ/Í¥ÄÎ¶?, desc: 'Í∑ºÎ¨¥???ëÏÑ±, Í∑ºÌÉú Í¥ÄÎ¶? ÎπÑÌíà Íµ¨Îß§ ?πÏù∏' },
                        { cat: '?ÅÎã¥/Îß§Ï∂ú', desc: '?†Í∑ú OT, Î∞òÌé∏?? ÎØ∏ÎÇ©/?òÎ∂à Í¥ÄÎ¶? ?êÏÑú?ëÏàò ÏßÄ?? },
                        { cat: '?ôÏÇ¨?¥ÏòÅ', desc: 'Î™®ÏùòÍ≥†ÏÇ¨ Ï¥ùÍ¥Ñ(Í∏∞Ìöç/Ï±ÑÏ†ê), ???πÍ∞ï Í≤∞ÏÇ∞' }
                    ],
                    sub_duties: [
                        { role: 'Î∂Ä?êÏû•', desc: 'Î∂Ä?êÏû• Î∂Ä?????ÑÎûµ??Í∞Ä?¥Îìú?ºÏù∏ ???ÑÏÉÅ ?†Ï?' },
                        { role: '?ÄÎ¶?????', desc: '?úÏÑ§ ?ÖÏ≤¥ Ïª®ÌÉù Î∞?Ï§ëÏöî ?åÍ≥Ñ Í≤∞Ïû¨ ?Ä?? }
                    ],
                    algorithm: '?¨Í∑∏ ?âÎèô Î™®Îç∏ (B=MAP): ?ÅÎã¥ ???ôÍ∏∞(M)?Ä ?•Î†•(A)???êÍ∑π?òÍ≥† ?∏Î¶¨Í±?P)Î•??πÍ≤® ?±Î°ù ?†ÎèÑ.'
                },
                {
                    id: 'manager_facility',
                    title: '?úÏÑ§/Í∑úÏú® ?ÄÎ¶???',
                    subtitle: 'Facility & Field Manager',
                    icon: '?õ†Ô∏?,
                    summary: '?ôÏõê???òÎìú?®Ïñ¥?Ä Í∑úÏú® Ï±ÖÏûÑ?? ?úÏÑ§ ?†Ï?Î≥¥Ïàò, Î¨ºÎ•ò, ?ôÏÉù ?µÏ†úÎ•??¥Îãπ.',
                    kpi: ['?úÏÑ§ Í≥†Ïû• Ï≤òÎ¶¨ ?úÍ∞Ñ', '?àÏ†Ñ?¨Í≥† 0Í±?, 'ÍµêÏû¨ Î∞∞ÏÜ° ?§Ï∞®??0%'],
                    main_duties: [
                        { cat: '?úÏÑ§/?àÏ†Ñ', desc: 'Í∞ïÏùò???ÖÏÑú???êÍ?, ?§Ìä∏?åÌÅ¨/?åÎ∞© ?êÍ?' },
                        { cat: 'Î¨ºÎ•ò', desc: 'ÍµêÏû¨ ?ÖÏ∂úÍ≥? ?ùÎ∞∞ Î∞úÏÜ°, ?¨Í≥† ?§ÏÇ¨' },
                        { cat: '?ôÏÇ¨/Í∑úÏú®', desc: '?πÍ∞ï ?¥ÏûÑ, Î©¥Ìïô Î∂ÑÏúÑÍ∏??úÏ∞∞, Î≤åÏ†ê Î∂Ä?? }
                    ],
                    sub_duties: [
                        { role: '?§Ïû•', desc: '?§Ïû• Î∂Ä?????ÑÏû• ?µÏ†ú ÏßÄ?? },
                        { role: '?ÄÎ¶???', desc: 'Î∂ÑÏã§Î¨?Í¥ÄÎ¶???Î¨ºÎ¶¨???âÏ†ï ÏßÄ?? }
                    ],
                    algorithm: '?§Ï∞®?êÏ†Å Î∂ÑÏÑù (MDA): ?úÍ∞Ñ/Í≥µÍ∞Ñ/?∏Í≥º Ï∞®Ïõê?êÏÑú ?úÏÑ§ Î¶¨Ïä§?¨Î? ?àÏ∏°?òÍ≥† ?†Ï†ú ?Ä??'
                },
                {
                    id: 'manager_admin',
                    title: '?åÍ≥Ñ/?ôÏÇ¨ ?ÄÎ¶???',
                    subtitle: 'Admin & Accounting Manager',
                    icon: '?ìä',
                    summary: 'ÍººÍºº???êÍ∏à Î∞??∞Ïù¥??Í¥ÄÎ¶¨Ïûê. ?åÍ≥Ñ Í≤∞ÏÇ∞, ?©Í≤©??DB, ?òÏóÖ ÏßÄ???¥Îãπ.',
                    kpi: ['?ïÏÇ∞ ?§Î•ò 0Í±?, '?©Í≤©??DB ÏµúÏã†?îÏú®', 'Í∞ïÏÇ¨ ÎßåÏ°±??],
                    main_duties: [
                        { cat: '?åÍ≥Ñ/Ï¥ùÎ¨¥', desc: '?∏Í∏àÍ≥ÑÏÇ∞?? ?úÏû¨ Í¥ÄÎ¶? Í∏âÏó¨ ?ïÏÇ∞, ÎπÑÌíà Ï£ºÎ¨∏' },
                        { cat: '?ôÏÇ¨ÏßÄ??, desc: '?òÏóÖ ?úÍ∞Ñ??Î∞∞Ï†ï, Í∞ïÏÇ¨ ?òÏ†Ñ, ?©Í≤©??Í¥ÄÎ¶? },
                        { cat: '?πÍ∞ïÏßÄ??, desc: '?πÍ∞ï ?ëÏàò Ï§ÄÎπ? ?êÎ£å ?∏Ïßë ÏßÄ?? }
                    ],
                    sub_duties: [
                        { role: '?§Ïû•', desc: 'Í≥†Í∞ù ?∞Ïù¥??Í¥ÄÎ¶?Î∞??®Ïàú Îß§Ï∂ú Î≥¥Í≥† ?Ä?? },
                        { role: 'Ï£ºÏûÑ(??', desc: '?ÖÏÑú???¨Î¨º???ëÏàò Î∞?Î¨∏Ïûê Î∞úÏÜ° ?Ä?? }
                    ],
                    algorithm: '?µÌï©??ÏßÄ??(IW): ?ÑÍ≤©???§Î¶¨ Í∏∞Ï?(Ethics)?ºÎ°ú ?êÍ∏à Í¥ÄÎ¶?Î∞??∞Ïù¥??Î¨¥Í≤∞???†Ï?.'
                },
                {
                    id: 'chief_marketing',
                    title: 'ÎßàÏ????âÏ†ï Ï£ºÏûÑ(??',
                    subtitle: 'Marketing & Admin Lead',
                    icon: '?ì¢',
                    summary: 'ÎßàÏ???Í¥ÄÎ¶¨Ïûê?¥Ïûê ?âÏ†ï Î©Ä?∞Ìîå?àÏù¥?? ?∏Ï£º Í¥ÄÎ¶¨Ï? ??ÎßéÏù¥ Í∞Ä???ëÏàò ?ÖÎ¨¥ ?ÑÎã¥.',
                    kpi: ['?®Îùº???†ÏûÖ ??, '?ÖÏÑú???¨Î¨º???ëÏàò ?ïÌôï??, 'Î¨∏Ïûê Î∞úÏÜ° ?ÅÏãú??, 'Î∏îÎ°úÍ∑?Ïπ¥Ìéò ?ÅÏúÑ?∏Ï∂ú Í±¥Ïàò'],
                    main_duties: [
                        { cat: 'Î∞îÏù¥?¥Í?Î¶?, desc: 'Í≤ΩÏãúÎ™?Í≤ΩÍøà????Ï£ºÏöî Ïª§Î??àÌã∞ ?¨Î°† Î™®Îãà?∞ÎßÅ Î∞??Ä?? },
                        { cat: 'ÏΩòÌÖêÏ∏†ÏÜå??, desc: '?©Í≤©???∏ÌÑ∞Î∑??∞Í∏∞, Í∞ïÏùò/?êÏäµ ?ÑÏû• ?èÌèº(15Ï¥? ?åÏä§ Ï¥¨ÏòÅ' },
                        { cat: '?∏Ï£º?∏Îì§Îß?, desc: 'Î∏îÎ°úÍ∑?Ï≤¥Ìóò??Î™®Ïßë Í¥ÄÎ¶? ?Ä?âÏÇ¨ ?§Ïõå???∏Ï∂ú ?ÑÌô© Ï≤¥ÌÅ¨' },
                        { cat: '?âÏ†ï?ÑÎã¥', desc: '?ÖÏÑú???¨Î¨º???†Í∑ú¬∑?∞Ïû• ?ëÏàò, ?ÑÏ≤¥ Í≥µÏ? Î¨∏Ïûê Î∞úÏÜ°' }
                    ],
                    sub_duties: [
                        { role: '?ÄÎ¶???', desc: '?®Ïàú ?òÏóÖ ÏßÄ??Î∞?Î¨∏ÏÑú ?∏Ïßë ?Ä?? },
                        { role: '?ÅÏÉÅ/?îÏûê?¥ÎÑà', desc: '?®Ïàú ?¥Î?ÏßÄ/?ÅÏÉÅ ?ÖÎ°ú???Ä?? }
                    ],
                    algorithm: '?§Ï∫†??(SCAMPER): Í∏∞Ï°¥ ?åÏä§Î•?Î≥Ä??Modify), ?©ÎèÑÎ≥ÄÍ≤?Put to other use)?òÏó¨ ÏΩòÌÖêÏ∏??¨ÏÉù??'
                }
            ],
            principles: [
                { title: 'ÏßÄ??Ï≤¥Í≥Ñ ?ºÏõê??, desc: 'Î™®Îì† Î≥¥Í≥†??[ÏßÅÏõê ???§Ïû• ??Î∂Ä?êÏû•]. ÏßÅÎ≥¥ Í∏àÏ? (Í∏¥Í∏â ?úÏô∏).' },
                { title: '??ï†???¥Ïõê??, desc: 'Î∂Ä?êÏû•(?§Í≥Ñ/?ÑÎûµ) vs ?§Ïû•(ÏßëÌñâ/?¥ÏòÅ).' },
                { title: 'Í≤∞Í≥º Ï±ÖÏûÑ??(KPI)', desc: '?¥Ïã¨???àÎã§(X) ???òÏπòÎ°??¨ÏÑ±?àÎã§(O).' },
                { title: 'ÎßàÏ???Í≥µÏû•??, desc: 'Ï∞ΩÏûë Í∏àÏ?. Í∏∞Ìöç(Î∂Ä?êÏû•)-Í¥ÄÎ¶?Ï£ºÏûÑ)-?úÏûë(?∏Ï£º) ?úÏä§??' }
            ],
            taskRegistry: [
                { id: 1, category: 'Í≤ΩÏòÅÍ∏∞Ìöç', task: 'Í≤ΩÏüÅ??Î∂ÑÏÑù Î∞??ÑÎûµ ?òÎ¶Ω', main: 'vice_director', sub: 'head_manager' },
                { id: 2, category: 'Í≤ΩÏòÅÍ∏∞Ìöç', task: '?ôÏÇ¨?ºÏ†ï Î∞?ÎßàÏ???Ïª®ÏÖâ ?πÏù∏', main: 'vice_director', sub: 'head_manager' },
                { id: 3, category: '?Ä?∏Ìòë??, task: '?Ä?ôÍµê/?∏Î??ÖÏ≤¥ MOU', main: 'vice_director', sub: 'head_manager' },
                { id: 4, category: '?∏ÏÇ¨/?ÅÎã¥', task: 'ÏßÅÏõê Ï±ÑÏö© Î∞??∞Î¥â ?ëÏÉÅ', main: 'vice_director', sub: 'head_manager' },
                { id: 5, category: '?∏ÏÇ¨/?ÅÎã¥', task: 'VIP Î∞??ÖÏÑ± ÎØºÏõê ?¥Í≤∞', main: 'vice_director', sub: 'head_manager' },

                { id: 6, category: '?¥ÏòÅ/Í¥ÄÎ¶?, task: 'Í∑ºÎ¨¥???ëÏÑ± Î∞?Í∑ºÌÉú Í¥ÄÎ¶?, main: 'head_manager', sub: 'vice_director' },
                { id: 7, category: '?¥ÏòÅ/Í¥ÄÎ¶?, task: 'ÎπÑÌíà Íµ¨Îß§ ?πÏù∏ (50ÎßåÏõê ÎØ∏Îßå)', main: 'head_manager', sub: 'vice_director' },
                { id: 8, category: '?ÅÎã¥/Îß§Ï∂ú', task: '?†Í∑ú??OT Î∞?Î∞òÌé∏??, main: 'head_manager', sub: 'manager_admin' },
                { id: 9, category: '?ÅÎã¥/Îß§Ï∂ú', task: 'ÎØ∏ÎÇ©??Î∞??òÎ∂à Í¥ÄÎ¶?, main: 'head_manager', sub: 'manager_admin' },
                { id: 10, category: '?ôÏÇ¨?¥ÏòÅ', task: 'Î™®ÏùòÍ≥†ÏÇ¨ Ï¥ùÍ¥Ñ (Í∏∞Ìöç/Ï±ÑÏ†ê)', main: 'head_manager', sub: 'manager_admin' },

                { id: 11, category: '?úÏÑ§/?àÏ†Ñ', task: 'Í∞ïÏùò???ÖÏÑú???úÏÑ§ ?êÍ?', main: 'manager_facility', sub: 'head_manager' },
                { id: 12, category: '?úÏÑ§/?àÏ†Ñ', task: '?§Ìä∏?åÌÅ¨(Wi-Fi)/?åÎ∞© ?êÍ?', main: 'manager_facility', sub: 'head_manager' },
                { id: 13, category: 'Î¨ºÎ•ò', task: 'ÍµêÏû¨ ?ÖÏ∂úÍ≥?Î∞??ùÎ∞∞ Î∞úÏÜ°', main: 'manager_facility', sub: 'manager_admin' },
                { id: 14, category: '?ôÏÇ¨/Í∑úÏú®', task: '?πÍ∞ï ?¥ÏûÑ (?ÑÏû• ?µÏ†ú)', main: 'manager_facility', sub: 'head_manager' },

                { id: 15, category: '?åÍ≥Ñ/Ï¥ùÎ¨¥', task: '?∏Í∏àÍ≥ÑÏÇ∞??Î∞??úÏû¨ Í¥ÄÎ¶?, main: 'manager_admin', sub: 'head_manager' },
                { id: 16, category: '?åÍ≥Ñ/Ï¥ùÎ¨¥', task: 'Í∞ïÏÇ¨Î£?Î∞??åÎ∞î Í∏âÏó¨ ?ïÏÇ∞', main: 'manager_admin', sub: 'head_manager' },
                { id: 17, category: '?ôÏÇ¨ÏßÄ??, task: '?©Í≤©???∞Ïù¥???êÎ?Í∑∏Îû®) Í¥ÄÎ¶?, main: 'manager_admin', sub: 'head_manager' },
                { id: 18, category: '?ôÏÇ¨ÏßÄ??, task: '?òÏóÖ ?úÍ∞Ñ??Î∞∞Ï†ï Î∞?Í∞ïÏÇ¨ ?òÏ†Ñ', main: 'manager_admin', sub: 'chief_marketing' },

                { id: 19, category: 'ÎßàÏ???Î∞îÏù¥??, task: 'Í≤ΩÏãúÎ™?Í≤ΩÍøà???ºÏùº Î™®Îãà?∞ÎßÅ Î∞??ìÍ? ?ëÏóÖ', main: 'chief_marketing', sub: 'vice_director' },
                { id: 20, category: 'ÎßàÏ???Î∞îÏù¥??, task: '?§Ïù¥Î≤?ÏßÄ?ùiN ?∞Î¶¨ ?ôÏõê Í¥Ä???µÎ? ?¨Í∏∞', main: 'chief_marketing', sub: 'vice_director' },
                { id: 21, category: 'ÎßàÏ???ÏΩòÌÖêÏ∏?, task: '?©Í≤©???±Ï†Å?∞Ïàò???∏ÌÑ∞Î∑?Î∞??òÍ∏∞ ?ïÎ≥¥', main: 'chief_marketing', sub: 'head_manager' },
                { id: 22, category: 'ÎßàÏ???ÏΩòÌÖêÏ∏?, task: '?∏Ïä§?Ä/?†ÌäúÎ∏åÏö© ?èÌèº(Í∞ïÏùò/?ÑÏû•) Ï¥¨ÏòÅ', main: 'chief_marketing', sub: 'head_manager' },
                { id: 23, category: 'ÎßàÏ???ÏΩòÌÖêÏ∏?, task: 'Ïπ¥Îìú?¥Ïä§??Í∞ïÏùò ?µÏã¨ ?îÏïΩ ?êÎ£å ?òÏßë', main: 'chief_marketing', sub: 'manager_admin' },
                { id: 24, category: 'ÎßàÏ????±Í≥º', task: 'Î∏îÎ°úÍ∑??§Ïõå???úÏúÑ Ï≤¥ÌÅ¨ Î∞?Î≥¥Í≥†', main: 'chief_marketing', sub: 'vice_director' },
                { id: 25, category: 'ÎßàÏ????§ÌîÑ?ºÏù∏', task: '?∏Í∑º ?ÖÏÑú???§ÌÑ∞?îÏπ¥???ÑÎã®ÏßÄ ÎπÑÏπò ?ïÏù∏', main: 'chief_marketing', sub: 'manager_facility' },
                { id: 26, category: 'ÎßàÏ???DB', task: '?§Î™Ö???ÅÎã¥ ÎØ∏Îì±Î°ùÏûê DB Î¨∏Ïûê(SMS) ÎßàÏ???, main: 'chief_marketing', sub: 'head_manager' },
                { id: 27, category: 'ÎßàÏ??ÖÍ?Î¶?, task: '?∏Ï£º ?ÖÏ≤¥ ?åÏä§ ?ÑÎã¨ Î∞?Í≤Ä??, main: 'chief_marketing', sub: 'vice_director' },
                { id: 28, category: '?âÏ†ï?ÑÎã¥', task: '?ÖÏÑú???¨Î¨º???†Í∑ú¬∑?∞Ïû• ?ëÏàò', main: 'chief_marketing', sub: 'manager_admin' },
                { id: 29, category: '?âÏ†ï?ÑÎã¥', task: '?ÑÏ≤¥ Í≥µÏ? Î¨∏Ïûê Î∞úÏÜ°', main: 'chief_marketing', sub: 'head_manager' },
                { id: 30, category: '?ÑÏû•ÏßÄ??, task: '?òÍ∞ïÏ¶??úÏûë Î∞??§Î™Ö??Ï§ÄÎπ?, main: 'chief_marketing', sub: 'manager_facility' }
            ]
        };

        // --- Active Data (Mutable) ---
        let appData = {
            roles: [],
            taskRegistry: [],
            principles: []
        };

        // Global state for filtering
        let activeRoleFilter = null;

        // --- Data Persistence Logic ---
        async function initData() {
            // Try to load from Google Sheets first
            if (sheetsWebAppUrl) {
                const synced = await syncFromSheets();
                if (synced) {
                    return; // Successfully loaded from Sheets
                }
            }

            // Fallback to LocalStorage
            const storedData = localStorage.getItem('kpa_ops_manual_v3');
            if (storedData) {
                try {
                    appData = JSON.parse(storedData);
                } catch (e) {
                    console.error("Data load failed, resetting", e);
                    appData = JSON.parse(JSON.stringify(defaultAppData));
                }
            } else {
                appData = JSON.parse(JSON.stringify(defaultAppData));
            }
        }

        async function saveData() {
            // Try to save to Google Sheets
            if (sheetsWebAppUrl) {
                await syncToSheets();
            } else {
                // Fallback to LocalStorage only
                localStorage.setItem('kpa_ops_manual_v3', JSON.stringify(appData));
            }
        }

        function resetAllData() {
            if (confirm("Î™®Îì† Î≥ÄÍ≤ΩÏÇ¨???¥Î¶Ñ Î≥ÄÍ≤? ?ÖÎ¨¥ Ï∂îÍ? ????Ï¥àÍ∏∞?îÌïò?úÍ≤†?µÎãàÍπ?")) {
                localStorage.removeItem('kpa_ops_manual_v3');
                location.reload();
            }
        }

        // ============================================
        // Google Sheets ?∞Îèô ?®Ïàò
        // ============================================

        async function syncFromSheets() {
            if (!sheetsWebAppUrl) {
                console.log('Sheets URL not configured, using LocalStorage');
                return false;
            }

            syncStatus.syncing = true;
            updateSyncUI('syncing');

            try {
                const response = await fetch(buildSheetsProxyUrl('getData'));
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();

                if (data.error) {
                    console.error('Sheets sync error:', data.error);
                    syncStatus.connected = false;
                    updateSyncUI('error');
                    return false;
                }

                // If Sheets has data, use it
                if (data.roles && data.roles.length > 0) {
                    appData.roles = data.roles;
                    appData.taskRegistry = data.tasks || [];
                    appData.principles = data.principles || [];

                    // Also save to LocalStorage as cache
                    localStorage.setItem('kpa_ops_manual_v3', JSON.stringify(appData));

                    syncStatus.connected = true;
                    syncStatus.lastSync = new Date();
                    updateSyncUI('success');
                    return true;
                } else {
                    // Sheets is empty, migrate from LocalStorage
                    console.log('Sheets empty, migrating from LocalStorage');
                    await migrateToSheets();
                    return true;
                }
            } catch (error) {
                console.error('Failed to sync from Sheets:', error);
                syncStatus.connected = false;
                syncStatus.syncing = false;
                updateSyncUI('error');
                return false;
            }
        }

        async function syncToSheets() {
            if (!sheetsWebAppUrl) {
                console.log('Sheets URL not configured, saving to LocalStorage only');
                localStorage.setItem('kpa_ops_manual_v3', JSON.stringify(appData));
                return false;
            }

            syncStatus.syncing = true;
            updateSyncUI('syncing');

            try {
                const response = await fetch(buildSheetsProxyUrl('saveData'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(appData)
                });

                let result = {};
                try {
                    result = await response.json();
                } catch (e) {
                    result = {};
                }

                if (!response.ok || result.error) {
                    throw new Error(result.error || `HTTP ${response.status}`);
                }

                // Also save to LocalStorage as cache
                localStorage.setItem('kpa_ops_manual_v3', JSON.stringify(appData));

                syncStatus.connected = true;
                syncStatus.lastSync = new Date();
                syncStatus.syncing = false;
                updateSyncUI('success');
                return true;
            } catch (error) {
                console.error('Failed to sync to Sheets:', error);
                syncStatus.syncing = false;
                updateSyncUI('error');

                // Fallback to LocalStorage
                localStorage.setItem('kpa_ops_manual_v3', JSON.stringify(appData));
                return false;
            }
        }

        async function migrateToSheets() {
            console.log('Migrating LocalStorage data to Sheets...');

            // Load data from LocalStorage first
            const storedData = localStorage.getItem('kpa_ops_manual_v3');
            if (storedData) {
                try {
                    appData = JSON.parse(storedData);
                    console.log('Loaded data from LocalStorage:', appData);
                } catch (e) {
                    console.error('Failed to parse LocalStorage data', e);
                    appData = JSON.parse(JSON.stringify(defaultAppData));
                }
            } else {
                // No LocalStorage data, use default
                appData = JSON.parse(JSON.stringify(defaultAppData));
            }

            // Now sync to Sheets
            const success = await syncToSheets();
            if (success) {
                console.log('Migration successful!');
            }
            return success;
        }

        function updateSyncUI(status) {
            const syncIndicator = document.getElementById('sync-indicator');
            if (!syncIndicator) return;

            if (status === 'syncing') {
                syncIndicator.innerHTML = '?îÑ ?ôÍ∏∞??Ï§?..';
                syncIndicator.className = 'text-xs text-blue-600 font-bold animate-pulse';
            } else if (status === 'success') {
                syncIndicator.innerHTML = '???ôÍ∏∞???ÑÎ£å';
                syncIndicator.className = 'text-xs text-green-600 font-bold';
                setTimeout(() => {
                    if (syncStatus.lastSync) {
                        const time = syncStatus.lastSync.toLocaleTimeString('ko-KR');
                        syncIndicator.innerHTML = `?ÅÔ∏è ${time}`;
                        syncIndicator.className = 'text-xs text-gray-500';
                    }
                }, 2000);
            } else if (status === 'error') {
                syncIndicator.innerHTML = '?†Ô∏è ?§ÌîÑ?ºÏù∏';
                syncIndicator.className = 'text-xs text-orange-500 font-bold';
            }
        }

        // --- Gemini API Logic ---
        async function callGeminiAPI(userQuery, systemContext = "") {
            // Check for Key
            if (!userApiKey) {
                openApiSettings();
                return "AI Í∏∞Îä•???¨Ïö©?òÎ†§Î©??§Ï†ï(?ôÔ∏è) Î©îÎâ¥?êÏÑú API ?§Î? Î®ºÏ? ?ÖÎ†•?¥Ï£º?∏Ïöî.";
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3.0-flash-preview:generateContent?key=${userApiKey}`;

            const manualContext = `
                ?πÏã†?Ä ?úÍµ≠Í≤ΩÏ∞∞?ôÏõê??'AI ?¥ÏòÅ Ïª®ÏÑ§?¥Ìä∏'?ÖÎãà??
                ?ÑÎûò??[Ï°∞ÏßÅ ?¥ÏòÅ Îß§Îâ¥?????ÑÍ≤©??Ï§Ä?òÌïò???µÎ??¥Ïïº ?©Îãà??
                
                [4?Ä ?¥ÏòÅ ?êÏπô]
                1. ÏßÄ??Ï≤¥Í≥Ñ ?ºÏõê?? ÏßÅÏõê -> ?§Ïû• -> Î∂Ä?êÏû•. ÏßÅÎ≥¥ Í∏àÏ?(Í∏¥Í∏â ?úÏô∏).
                2. ??ï† ?¥Ïõê?? Î∂Ä?êÏû•(?ÑÎûµ/?§Í≥Ñ) vs ?§Ïû•(?ÑÏû•/?¥ÏòÅ).
                3. Í≤∞Í≥º Ï±ÖÏûÑ?? KPI Ï§ëÏã¨ ?âÍ?.
                4. ÎßàÏ???Í≥µÏû•?? Í∏∞Ìöç(Î∂Ä?êÏû•)-Í¥ÄÎ¶?Ï£ºÏûÑ)-?úÏûë(?∏Ï£º).

                [ÏßÅÎ¨¥Î≥??µÏã¨ R&R]
                - Î∂Ä?êÏû•: COO, ?ÑÎûµ, ?∏ÏÇ¨, ?Ä?∏Ìòë?? ?§Î¨¥ Í∏àÏ?.
                - ?§Ïû•: ?ÑÏû• Ï¥ùÍ¥Ñ, ?ÅÎã¥/Îß§Ï∂ú/ÏßÅÏõêÍ¥ÄÎ¶??ÑÍ≤∞Í∂?
                - ?ÄÎ¶???: ?úÏÑ§, Í∑úÏú®, Î¨ºÎ•ò.
                - ?ÄÎ¶???: ?åÍ≥Ñ, ?∞Ïù¥?? ?ôÏÇ¨ÏßÄ??
                - Ï£ºÏûÑ(??: ÎßàÏ???Í¥ÄÎ¶?Ï∞ΩÏûëX), ?âÏ†ï/?ëÏàò ?ÑÎã¥.

                [Î≥¥Í≥†???êÏπô]
                - 1-3-1 Î≤ïÏπô: Í≤∞Î°† 1Ï§? Í∑ºÍ±∞ 3Í∞ÄÏßÄ, ?úÏïà 1Ï§?
                - ?òÏÅú Î≥¥Í≥†: Î≥ÄÎ™? Í≥ºÏ†ï ?òÏó¥.
                - Ï¢ãÏ? Î≥¥Í≥†: ?´Ïûê, ?Ä???úÏãú.

                ?µÎ? ?§Ì???
                - ?ÑÎ¨∏?ÅÏù¥Í≥??®Ìò∏??'Ï¥ùÍ¥Ñ Î∂Ä?êÏû•' ?êÎäî 'Í≤ΩÏòÅ Ïª®ÏÑ§?¥Ìä∏'???¥Ï°∞Î•??¨Ïö©?òÏÑ∏??
                - Î∞òÎìú??Îß§Îâ¥?ºÏùò Ï°∞Ìï≠?¥ÎÇò ?êÏπô???∏Ïö©?òÏó¨ Í∑ºÍ±∞Î•??úÏãú?òÏÑ∏??
                - ?§Ìñâ Í∞Ä?•Ìïú Íµ¨Ï≤¥?ÅÏù∏ ?âÎèô ÏßÄÏπ?Action Plan)??1, 2, 3 Î≤àÌò∏Î•?Îß§Í≤® ?úÏïà?òÏÑ∏??
            `;

            const fullPrompt = `${manualContext}\n\n${systemContext}\n\n?¨Ïö©??ÏßàÎ¨∏: ${userQuery}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: fullPrompt }] }]
                    })
                });

                if (!response.ok) throw new Error('API ?∏Ï∂ú ?§Ìå®');

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini API Error:", error);
                return "?§Î•òÍ∞Ä Î∞úÏÉù?àÏäµ?àÎã§. API ?§Í? ?ïÌôï?úÏ? ?ïÏù∏?¥Ï£º?∏Ïöî.";
            }
        }

        // --- View Logic ---

        async function init() {
            await initData(); // Load data from Sheets or LocalStorage
            renderNav();

            // Check for stored API key
            if (userApiKey) {
                const status = document.getElementById('ai-status');
                if (status) status.classList.remove('hidden');
            }

            // Show sync indicator if Sheets URL is configured
            if (sheetsWebAppUrl) {
                const syncIndicator = document.getElementById('sync-indicator');
                if (syncIndicator) {
                    syncIndicator.classList.remove('hidden');
                    if (syncStatus.connected) {
                        syncIndicator.innerHTML = '?ÅÔ∏è ?ôÍ∏∞?îÎê®';
                        syncIndicator.className = 'text-xs text-green-600';
                    } else {
                        syncIndicator.innerHTML = '?†Ô∏è ?§ÌîÑ?ºÏù∏';
                        syncIndicator.className = 'text-xs text-orange-500';
                    }
                }
            }

            loadView('dashboard');
        }

        function renderNav() {
            const navItems = [
                { id: 'dashboard', label: '?Ä?úÎ≥¥?? },
                { id: 'roles', label: '?ÖÎ¨¥ Î∂ÑÏû•' },
                { id: 'task-search', label: '?îç ?ÖÎ¨¥ Í≤Ä??& Î∞∞Ï†ï' }, // New Search Menu
                { id: 'reporting', label: 'Î≥¥Í≥† Ï≤¥Í≥Ñ' },
                { id: 'shifts', label: 'Í∑ºÎ¨¥/?úÏ¶å' },
                { id: 'utility', label: '?õ†Ô∏??§Î¨¥ ?†Ìã∏Î¶¨Ìã∞' },
                { id: 'toolkit', label: '??AI ?§Îßà???? },
                { id: 'ai-copilot', label: '?§ñ AI ?¥ÏòÅ ÏΩîÌåå?ºÎüø' }
            ];

            const container = document.getElementById('nav-container');
            container.innerHTML = navItems.map(item => `
                    <button onclick = "loadView('${item.id}')"
                class="nav-btn border-transparent text-stone-500 hover:border-slate-300 hover:text-slate-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors duration-200"
                id = "nav-${item.id}" >
                    ${item.label}
                </button >
                    `).join('');
        }

        function loadView(viewId) {
            // Update Nav State
            document.querySelectorAll('.nav-btn').forEach(el => {
                el.classList.remove('border-slate-800', 'text-slate-900');
                el.classList.add('border-transparent', 'text-stone-500');
            });
            document.getElementById(`nav-${viewId}`).classList.add('border-slate-800', 'text-slate-900');
            document.getElementById(`nav-${viewId}`).classList.remove('border-transparent', 'text-stone-500');

            const contentArea = document.getElementById('content-area');

            // Render Content
            if (viewId === 'dashboard') renderDashboard(contentArea);
            else if (viewId === 'roles') renderRoles(contentArea);
            else if (viewId === 'task-search') renderTaskSearch(contentArea); // New View
            else if (viewId === 'reporting') renderReporting(contentArea);
            else if (viewId === 'shifts') renderShifts(contentArea);
            else if (viewId === 'toolkit') renderToolkit(contentArea);
            else if (viewId === 'utility') renderUtility(contentArea);
            else if (viewId === 'ai-copilot') renderAICopilot(contentArea);
        }

        // --- Helper: Get Role Name by ID ---
        function getRoleName(id) {
            const role = appData.roles.find(r => r.id === id);
            return role ? role.title : 'ÎØ∏Ï???;
        }
        function getRoleBadge(id) {
            const role = appData.roles.find(r => r.id === id);
            // Added onclick for filtering
            return role ? `<span onclick="filterTasksByRole('${id}')" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-800 hover:bg-indigo-100 cursor-pointer border border-transparent hover:border-indigo-300 transition-colors" title="?¥Î¶≠?òÏó¨ ${role.title} ?ÖÎ¨¥Îß?Î≥¥Í∏∞">${role.icon} ${role.title}</span>` : '<span class="text-stone-400">-</span>';
        }

        // --- Task Search & Add View ---
        function renderTaskSearch(container) {
            container.innerHTML = `
                    <div class="bg-white p-8 rounded-lg shadow-sm border border-stone-200 min-h-[600px]" >
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">?îç ?ÖÎ¨¥ Í≤Ä??Î∞?Í¥ÄÎ¶?/h2>
                            <p class="text-stone-500 text-sm mt-1">?¥Îãπ?êÎ? ?¥Î¶≠?òÎ©¥ ?¥Îãπ ?∏Ïõê???ÖÎ¨¥(??Î∂Ä)Îß?Î™®ÏïÑÎ≥????àÏäµ?àÎã§.</p>
                        </div>
                        <div class="flex gap-2 w-full md:w-auto flex-wrap justify-end">
                            <!-- Filter Display -->
                            <div id="active-filter-display" class="hidden flex items-center bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full text-sm border border-indigo-200">
                                <span id="filter-name" class="font-bold mr-2"></span>
                                <button onclick="clearRoleFilter()" class="hover:text-indigo-900 font-bold">??/button>
                            </div>

                            <input type="text" id="task-search-input" placeholder="?ÖÎ¨¥Î™?Í≤Ä??(?? ?òÎ∂à)" 
                                class="flex-grow md:w-48 p-2 border border-stone-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                onkeyup="filterTasks()">
                            
                            <button onclick="openRoleEditor()" class="bg-stone-600 text-white px-3 py-2 rounded text-sm font-bold hover:bg-stone-700 transition flex items-center whitespace-nowrap">
                                ?è∑Ô∏??¥Î¶Ñ Î≥ÄÍ≤?
                            </button>
                            <button onclick="openTaskForm()" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-indigo-700 transition flex items-center whitespace-nowrap">
                                ???†Í∑ú ?ÖÎ¨¥
                            </button>
                        </div>
                    </div>

                    <!--Role Name Editor Form(Hidden)-- >
                    <div id="edit-role-form" class="hidden mb-8 bg-stone-50 p-6 rounded-lg border border-stone-200 animate-fade-in">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-stone-800 flex items-center"><span class="text-xl mr-2">?è∑Ô∏?/span> ?¥Îãπ??Î™ÖÏπ≠(?§Î™Ö) ?òÏ†ï</h3>
                            <button onclick="closeRoleEditor()" class="text-stone-400 hover:text-stone-600">??/button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            ${appData.roles.map(r => `
                                <div class="flex flex-col">
                                    <label class="text-xs font-bold text-stone-500 uppercase mb-1">${r.subtitle}</label>
                                    <div class="flex items-center">
                                        <span class="text-2xl mr-2">${r.icon}</span>
                                        <input type="text" id="role-name-${r.id}" value="${r.title}" class="w-full p-2 border border-stone-300 rounded text-sm focus:ring-2 focus:ring-stone-500">
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="flex justify-end">
                            <button onclick="saveRoleNames()" class="bg-stone-800 text-white px-6 py-2 rounded text-sm font-bold hover:bg-black shadow-sm">Î≥ÄÍ≤ΩÏÇ¨???Ä??/button>
                        </div>
                    </div>

                    <!--Add / Edit Task Form(Hidden)-- >
                    <div id="add-task-form" class="hidden mb-8 bg-indigo-50 p-6 rounded-lg border border-indigo-100 animate-fade-in">
                        <input type="hidden" id="edit-task-id"> <!-- ID for Edit Mode -->
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-indigo-800 flex items-center" id="form-title"><span class="text-xl mr-2">?çÔ∏è</span> ?†Í∑ú ?ÖÎ¨¥ Î∞∞Ï†ï</h3>
                            <span id="form-mode-badge" class="text-xs bg-indigo-200 text-indigo-800 px-2 py-1 rounded hidden">?òÏ†ï Î™®Îìú</span>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-xs font-bold text-indigo-600 uppercase mb-1">Ïπ¥ÌÖåÍ≥†Î¶¨</label>
                                <input type="text" id="new-cat" placeholder="?? ?âÏÇ¨ÏßÄ?? class="w-full p-2 border border-indigo-200 rounded text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                            </div>
                            <div class="lg:col-span-2"> <!-- Task Name takes more space -->
                                <label class="block text-xs font-bold text-indigo-600 uppercase mb-1">?ÖÎ¨¥ ?¥Ïö©</label>
                                <input type="text" id="new-task" placeholder="?? Ï£ºÎßê ?§Î™Ö??Ï£ºÏ∞® Í¥ÄÎ¶? class="w-full p-2 border border-indigo-200 rounded text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-indigo-600 uppercase mb-1">??Main) ?¥Îãπ</label>
                                <select id="new-main" class="w-full p-2 border border-indigo-200 rounded text-sm bg-white">
                                    ${appData.roles.map(r => `<option value="${r.id}">${r.title}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-indigo-600 uppercase mb-1">Î∂Ä(Sub) ?¥Îãπ</label>
                                <select id="new-sub" class="w-full p-2 border border-indigo-200 rounded text-sm bg-white">
                                    <option value="">(?†ÌÉù ?àÌï®)</option>
                                    ${appData.roles.map(r => `<option value="${r.id}">${r.title}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="flex justify-end gap-2">
                            <button onclick="closeTaskForm()" class="px-4 py-2 text-stone-500 hover:text-stone-700 text-sm font-bold bg-white border border-stone-300 rounded">Ï∑®ÏÜå</button>
                            <button onclick="saveTask()" class="bg-indigo-600 text-white px-6 py-2 rounded text-sm font-bold hover:bg-indigo-700 shadow-sm" id="save-btn">?Ä??Î∞?Î∞∞Ï†ï</button>
                        </div>
                    </div>

                    <!--Tasks Table-- >
                    <div class="overflow-x-auto border border-stone-200 rounded-lg">
                        <table class="min-w-full divide-y divide-stone-200">
                            <thead class="bg-stone-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">Ïπ¥ÌÖåÍ≥†Î¶¨</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">?ÖÎ¨¥ ?¥Ïö©</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">??Main) ?¥Îãπ</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">Î∂Ä(Sub) ?¥Îãπ</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-stone-500 uppercase tracking-wider">Í¥ÄÎ¶?/th>
                                </tr>
                            </thead>
                            <tbody id="task-list-body" class="bg-white divide-y divide-stone-200">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                    <div id="no-result" class="hidden text-center py-10 text-stone-400">
                        Í≤Ä??Í≤∞Í≥ºÍ∞Ä ?ÜÏäµ?àÎã§.
                    </div>
                </div>
                    `;
            // Initial render with current filter state - wait for DOM to be fully rendered
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    if (activeRoleFilter) {
                        filterTasksByRole(activeRoleFilter);
                    } else {
                        renderTaskList(appData.taskRegistry);
                    }
                });
            });
        }

        function renderTaskList(tasks) {
            const tbody = document.getElementById('task-list-body');
            const noResult = document.getElementById('no-result');

            // Null check - if elements don't exist, return early
            if (!tbody || !noResult) {
                console.warn('Task list elements not found in DOM');
                return;
            }

            if (tasks.length === 0) {
                tbody.innerHTML = '';
                noResult.classList.remove('hidden');
                return;
            }

            noResult.classList.add('hidden');
            tbody.innerHTML = tasks.map(t => `
                    <tr class="hover:bg-stone-50 transition-colors" >
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-stone-600">${t.category}</td>
                    <td class="px-6 py-4 text-sm text-stone-800">${t.task}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-900">
                        ${getRoleBadge(t.main)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">
                        ${getRoleBadge(t.sub)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="editTask(${t.id})" class="text-indigo-600 hover:text-indigo-900 mr-3 p-1 rounded hover:bg-indigo-50" title="?òÏ†ï">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 00 2 2h11a2 2 0 00 2-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                        </button>
                        <button onclick="deleteTask(${t.id})" class="text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-50" title="??†ú">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </td>
                </tr >
                    `).join('');
        }

        // --- Role Filter Logic ---
        function filterTasksByRole(roleId) {
            activeRoleFilter = roleId;
            const roleName = getRoleName(roleId);

            // Update UI to show filter is active
            const filterDisplay = document.getElementById('active-filter-display');
            const filterName = document.getElementById('filter-name');
            const searchInput = document.getElementById('task-search-input');

            if (filterDisplay && filterName) {
                filterDisplay.classList.remove('hidden');
                filterName.innerText = `${roleName} ?¥Îãπ ?ÖÎ¨¥`;
                if (searchInput) searchInput.value = ''; // Clear text search
            }

            // Filter Data
            const filtered = appData.taskRegistry.filter(t => t.main === roleId || t.sub === roleId);
            renderTaskList(filtered);
        }

        function clearRoleFilter() {
            activeRoleFilter = null;
            const filterDisplay = document.getElementById('active-filter-display');
            if (filterDisplay) filterDisplay.classList.add('hidden');

            // Re-run text filter or show all
            filterTasks();
        }

        function filterTasks() {
            const keyword = document.getElementById('task-search-input').value.toLowerCase();

            let filtered = appData.taskRegistry;

            // Apply Role Filter first if active
            if (activeRoleFilter) {
                filtered = filtered.filter(t => t.main === activeRoleFilter || t.sub === activeRoleFilter);
            }

            // Then apply text filter
            if (keyword) {
                filtered = filtered.filter(t =>
                    t.task.toLowerCase().includes(keyword) ||
                    t.category.toLowerCase().includes(keyword) ||
                    getRoleName(t.main).toLowerCase().includes(keyword) ||
                    getRoleName(t.sub).toLowerCase().includes(keyword)
                );
            }

            renderTaskList(filtered);
        }

        // --- Role Name Editor Logic ---
        function openRoleEditor() {
            closeTaskForm(); // Close other form
            document.getElementById('edit-role-form').classList.remove('hidden');
        }

        function closeRoleEditor() {
            const form = document.getElementById('edit-role-form');
            if (form) {
                form.classList.add('hidden');
            }
        }

        function saveRoleNames() {
            // Update appData.roles based on inputs
            appData.roles.forEach(role => {
                const input = document.getElementById(`role - name - ${role.id} `);
                if (input && input.value) {
                    role.title = input.value;
                }
            });

            saveData(); // Save to LocalStorage
            alert('?¥Îãπ??Î™ÖÏπ≠??Î≥ÄÍ≤ΩÎêò?àÏäµ?àÎã§.');
            closeRoleEditor();

            // Refresh Views
            renderTaskSearch(document.getElementById('content-area'));
        }

        // --- Task Add/Edit Logic (Existing Updated) ---
        function openTaskForm(mode = 'add', data = null) {
            closeRoleEditor(); // Close other form
            const form = document.getElementById('add-task-form');
            const title = document.getElementById('form-title');
            const btn = document.getElementById('save-btn');
            const badge = document.getElementById('form-mode-badge');
            const idField = document.getElementById('edit-task-id');

            // Null check - if form elements don't exist
            if (!form || !title || !btn || !badge || !idField) {
                console.error('Task form elements not found');
                alert('?ëÏãù??Ï∞æÏùÑ ???ÜÏäµ?àÎã§. "?ÖÎ¨¥ Í≤Ä??Î∞?Í¥ÄÎ¶? Î©îÎâ¥Î°??¥Îèô?¥Ï£º?∏Ïöî.');
                return;
            }

            // Reset Fields
            const catEl = document.getElementById('new-cat');
            const taskEl = document.getElementById('new-task');
            const mainSelect = document.getElementById('new-main');
            const subSelect = document.getElementById('new-sub');

            if (!catEl || !taskEl || !mainSelect || !subSelect) {
                console.error('Task input elements not found');
                alert('?ëÏãù??Ï∞æÏùÑ ???ÜÏäµ?àÎã§. "?ÖÎ¨¥ Í≤Ä??Î∞?Í¥ÄÎ¶? Î©îÎâ¥Î°??¥Îèô?¥Ï£º?∏Ïöî.');
                return;
            }

            catEl.value = '';
            taskEl.value = '';

            // Re-populate dropdowns to ensure latest names
            const roleOptions = appData.roles.map(r => `<option value="${r.id}">${r.title}</option>`).join('');
            mainSelect.innerHTML = roleOptions;
            subSelect.innerHTML = `<option value="">(?†ÌÉù ?àÌï®)</option>` + roleOptions;

            mainSelect.selectedIndex = 0;
            subSelect.selectedIndex = 0;
            idField.value = '';

            if (mode === 'edit' && data) {
                title.innerHTML = '<span class="text-xl mr-2">?èÔ∏è</span> ?ÖÎ¨¥ ?¥Ïö© ?òÏ†ï';
                btn.innerText = '?òÏ†ï ?ÑÎ£å';
                btn.className = "bg-green-600 text-white px-6 py-2 rounded text-sm font-bold hover:bg-green-700 shadow-sm";
                badge.classList.remove('hidden');

                catEl.value = data.category;
                taskEl.value = data.task;
                mainSelect.value = data.main;
                subSelect.value = data.sub;
                idField.value = data.id;
            } else {
                title.innerHTML = '<span class="text-xl mr-2">?çÔ∏è</span> ?†Í∑ú ?ÖÎ¨¥ Î∞∞Ï†ï';
                btn.innerText = '?Ä??Î∞?Î∞∞Ï†ï';
                btn.className = "bg-indigo-600 text-white px-6 py-2 rounded text-sm font-bold hover:bg-indigo-700 shadow-sm";
                badge.classList.add('hidden');
            }

            form.classList.remove('hidden');
            form.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function closeTaskForm() {
            document.getElementById('add-task-form').classList.add('hidden');
        }

        function saveTask() {
            const idEl = document.getElementById('edit-task-id');
            const catEl = document.getElementById('new-cat');
            const taskEl = document.getElementById('new-task');
            const mainEl = document.getElementById('new-main');
            const subEl = document.getElementById('new-sub');

            // Null check
            if (!idEl || !catEl || !taskEl || !mainEl || !subEl) {
                console.error('Task form elements not found');
                alert('?ëÏãù??Ï∞æÏùÑ ???ÜÏäµ?àÎã§. ?òÏù¥ÏßÄÎ•??àÎ°úÍ≥†Ïπ®?¥Ï£º?∏Ïöî.');
                return;
            }

            const id = idEl.value;
            const cat = catEl.value;
            const task = taskEl.value;
            const main = mainEl.value;
            const sub = subEl.value;

            if (!cat || !task || !main) {
                alert("Ïπ¥ÌÖåÍ≥†Î¶¨, ?ÖÎ¨¥ ?¥Ïö©, ??Main) ?¥Îãπ?Ä ?ÑÏàò?ÖÎãà??");
                return;
            }

            if (id) {
                const index = appData.taskRegistry.findIndex(t => t.id == id);
                if (index !== -1) {
                    appData.taskRegistry[index] = { id: parseInt(id), category: cat, task: task, main: main, sub: sub };
                    alert("?ÖÎ¨¥Í∞Ä ?òÏ†ï?òÏóà?µÎãà??");
                }
            } else {
                const newId = appData.taskRegistry.length > 0 ? Math.max(...appData.taskRegistry.map(t => t.id)) + 1 : 1;
                appData.taskRegistry.unshift({ id: newId, category: cat, task: task, main: main, sub: sub });
                alert("?àÎ°ú???ÖÎ¨¥Í∞Ä Î∞∞Ï†ï?òÏóà?µÎãà??");
            }

            saveData(); // Save to LocalStorage
            closeTaskForm();
            filterTasks();
        }

        function editTask(id) {
            const task = appData.taskRegistry.find(t => t.id === id);
            if (task) {
                openTaskForm('edit', task);
            }
        }

        function deleteTask(id) {
            if (confirm("?ïÎßê ???ÖÎ¨¥Î•???†ú?òÏãúÍ≤†Ïäµ?àÍπå?\n??†ú???∞Ïù¥?∞Îäî Î≥µÍµ¨?????ÜÏäµ?àÎã§.")) {
                appData.taskRegistry = appData.taskRegistry.filter(t => t.id !== id);
                saveData(); // Save to LocalStorage
                filterTasks();
            }
        }

        // --- Dashboard View ---
        function renderDashboard(container) {
            container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 animate-fade-in" >
                    <!--Intro -->
                    <div class="md:col-span-2 bg-white p-8 rounded-lg shadow-sm border border-stone-200">
                        <h1 class="text-3xl font-bold text-slate-800 mb-4">?¥ÏòÅ Ï¥ùÍ¥Ñ Ïª§Îß®???ºÌÑ∞</h1>
                        <p class="text-stone-600 text-lg leading-relaxed">
                            Î≥??úÏä§?úÏ? <strong>COO(ÏµúÍ≥†?¥ÏòÅÏ±ÖÏûÑ?? Ï≤¥Ï†ú</strong> ?òÏóê Í∑∏Î£π ?ÑÏ≤¥???®Ïú®?ÅÏù∏ ?¥ÏòÅ??ÏßÄ?êÌï©?àÎã§.
                            <strong>'?ÑÎûµ(Î∂Ä?êÏû•)'</strong>Í≥?<strong>'?§Ìñâ(?§Ïû•)'</strong>??Î∂ÑÎ¶¨?òÍ≥†, 
                            Î™ÖÌôï??R&RÍ≥??∞Ïù¥??Í∏∞Î∞ò???òÏÇ¨Í≤∞Ï†ï???µÌï¥ Ï°∞ÏßÅ???±Ïû•???ÑÎ™®?©Îãà??
                        </p>
                    </div>

                    <!--Core Principles-- >
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200">
                        <h2 class="text-xl font-bold text-slate-800 mb-4 border-b pb-2">?ìã 4?Ä ?¥ÏòÅ ?êÏπô</h2>
                        <ul class="space-y-4">
                            ${appData.principles.map(p => `
                                <li class="flex items-start">
                                    <span class="flex-shrink-0 h-6 w-6 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center text-xs font-bold mr-3">??/span>
                                    <div>
                                        <p class="font-bold text-slate-700">${p.title}</p>
                                        <p class="text-stone-500 text-sm">${p.desc}</p>
                                    </div>
                                </li>
                            `).join('')}
                        </ul>
                    </div>

                    <!--Org Chart Visualization-- >
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200 relative overflow-hidden">
                        <h2 class="text-xl font-bold text-slate-800 mb-4 border-b pb-2">?è¢ Ï°∞ÏßÅ Íµ¨Ï°∞??/h2>
                        <div class="flex flex-col items-center justify-center space-y-6 pt-4 relative z-10">

                            <!-- CEO -->
                            <div class="w-48 bg-stone-100 border border-stone-300 p-3 rounded text-center">
                                <p class="text-xs text-stone-500 font-bold">ÏµúÍ≥† ?òÏÇ¨Í≤∞Ï†ï</p>
                                <p class="font-bold text-stone-800">?Ä?úÏù¥??/ ?êÏû•</p>
                            </div>

                            <!-- Vice Director -->
                            <div class="w-56 bg-slate-800 text-white p-4 rounded-lg text-center shadow-lg transform scale-105">
                                <p class="text-xs text-slate-300 font-bold mb-1">COO / ?ÑÎûµ Ï¥ùÍ¥Ñ</p>
                                <p class="text-lg font-bold">Ï¥ùÍ¥Ñ Î∂Ä?êÏû• (??</p>
                            </div>

                            <!-- Head Manager -->
                            <div class="w-56 bg-white border-2 border-slate-600 p-3 rounded-lg text-center shadow-md">
                                <p class="text-xs text-slate-500 font-bold">Operation / ?ÑÏû• Ï¥ùÍ¥Ñ</p>
                                <p class="font-bold text-slate-800">?¥ÏòÅ ?§Ïû•</p>
                            </div>

                            <!-- Teams -->
                            <div class="grid grid-cols-2 gap-4 w-full">
                                <div class="bg-stone-50 border border-stone-200 p-2 rounded text-center">
                                    <p class="font-bold text-sm">?¥ÏòÅÏßÄ?êÌ?</p>
                                    <p class="text-xs text-stone-500">?ÄÎ¶?????, Ï£ºÏûÑ</p>
                                </div>
                                <div class="bg-red-50 border border-red-200 p-2 rounded text-center">
                                    <p class="font-bold text-sm text-red-700">TF / Í∏∞Ìöç?Ä</p>
                                    <p class="text-xs text-red-500">Î∂Ä?êÏû• ÏßÅÏÜç (?ÅÏã†)</p>
                                </div>
                            </div>
                        </div>
                        <!-- Connecting Lines would be handled by CSS or SVG but constrained to no SVG, simplified visually by layout spacing -->
                        <div class="absolute top-1/2 left-1/2 w-0.5 h-32 bg-stone-300 -z-0 transform -translate-x-1/2 -translate-y-1/2"></div>
                    </div>
                </div>
                    `;
        }

        // --- Roles View ---
        function renderRoles(container) {
            container.innerHTML = `
                    <div class="mb-6 bg-white p-6 rounded-lg border border-stone-200" >
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">ÏßÅÎ¨¥Î≥??ÅÏÑ∏ R&R Îß§Ìä∏Î¶?ä§</h2>
                    <p class="text-stone-600">
                        Í∞?ÏßÅÎ¨¥???µÏã¨ ??ï†(Main)Í≥?Î∂Ä?????Ä????ï†(Sub)??Î™ÖÌôï???ïÏùò?©Îãà??
                        <br><span class="text-sm text-red-500">* Ïπ¥ÎìúÎ•??¥Î¶≠?òÎ©¥ ?ÅÏÑ∏ ?ÖÎ¨¥?Ä ?ÅÏö© ?åÍ≥†Î¶¨Ï¶ò??Î≥????àÏäµ?àÎã§.</span>
                    </p>
                </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="role-grid">
                        ${appData.roles.map(role => createRoleCard(role)).join('')}
                    </div>
                `;
        }

        function createRoleCard(role) {
            return `
                    <div class="bg-white rounded-lg border border-stone-200 shadow-sm overflow-hidden card-hover transition-all duration-300" >
                    <div class="p-6 cursor-pointer" onclick="toggleRoleDetails('${role.id}')">
                        <div class="flex items-start justify-between">
                            <div class="flex items-center">
                                <div class="text-4xl mr-4">${role.icon}</div>
                                <div>
                                    <h3 class="text-xl font-bold text-slate-800">${role.title}</h3>
                                    <p class="text-sm font-medium text-slate-500 uppercase">${role.subtitle}</p>
                                </div>
                            </div>
                            <button class="text-stone-400 hover:text-slate-600">
                                <span id="icon-${role.id}">??/span>
                            </button>
                        </div>
                        <p class="mt-4 text-stone-600 leading-snug">${role.summary}</p>
                    </div>
                    
                    <!--Expanded Details-- >
                    <div id="details-${role.id}" class="hidden bg-stone-50 border-t border-stone-100 p-6 animate-fade-in">

                        <!-- KPIs -->
                        <div class="mb-4">
                            <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">?µÏã¨ ?±Í≥º ÏßÄ??(KPI)</h4>
                            <div class="flex flex-wrap gap-2">
                                ${role.kpi.map(k => `<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-medium">${k}</span>`).join('')}
                            </div>
                        </div>

                        <!-- Main Duties -->
                        <div class="mb-4">
                            <h4 class="text-xs font-bold text-slate-800 uppercase tracking-wider mb-2 border-l-4 border-slate-600 pl-2">??Main) ?¥Îãπ ?ÖÎ¨¥</h4>
                            <ul class="space-y-2 text-sm text-stone-700">
                                ${role.main_duties.map(d => `
                                    <li class="flex items-start">
                                        <span class="font-bold mr-2 w-20 flex-shrink-0">[${d.cat}]</span>
                                        <span>${d.desc}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>

                        <!-- Sub Duties -->
                        <div class="mb-4">
                            <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 border-l-4 border-stone-300 pl-2">Î∂Ä(Sub) ?¥Îãπ ?ÖÎ¨¥ (Î∞±ÏóÖ)</h4>
                            <ul class="space-y-2 text-sm text-stone-500">
                                ${role.sub_duties.map(d => `
                                    <li class="flex items-start">
                                        <span class="font-bold mr-2 w-20 flex-shrink-0">?Ä?? ${d.role}</span>
                                        <span>${d.desc}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>

                        <!-- Algorithm -->
                        <div class="bg-slate-800 text-white p-3 rounded text-sm mt-4">
                            <strong class="text-yellow-400">???ÖÎ¨¥ ?òÌñâ ?åÍ≥†Î¶¨Ï¶ò:</strong><br>
                                ${role.algorithm}
                        </div>
                    </div>
                </div>
                    `;
        }

        function toggleRoleDetails(id) {
            const el = document.getElementById(`details-${id}`);
            const icon = document.getElementById(`icon-${id}`);

            // Null check
            if (!el || !icon) {
                console.warn(`Role details elements not found for id: ${id}`);
                return;
            }

            if (el.classList.contains('hidden')) {
                el.classList.remove('hidden');
                icon.innerText = '??;
            } else {
                el.classList.add('hidden');
                icon.innerText = '??;
            }
        }

        // --- Reporting View ---
        function renderReporting(container) {
            container.innerHTML = `
                    <div class="bg-white p-8 rounded-lg shadow-sm border border-stone-200" >
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">Î≥¥Í≥† Î∞??òÏÇ¨Í≤∞Ï†ï Ï≤¥Í≥Ñ (Two-Track)</h2>
                        <div class="flex space-x-2">
                            <button onclick="setReportMode('routine')" id="btn-routine" class="px-4 py-2 rounded bg-slate-100 text-slate-600 font-bold hover:bg-slate-200 transition">?ü¢ ?ºÎ∞ò ?¥ÏòÅ (Run)</button>
                            <button onclick="setReportMode('tf')" id="btn-tf" class="px-4 py-2 rounded bg-stone-100 text-stone-400 font-bold hover:bg-red-50 hover:text-red-600 transition">?î¥ Í∏∞Ìöç/?ÅÏã† (Change)</button>
                        </div>
                    </div>

                    <div class="relative bg-stone-50 p-8 rounded-xl border border-stone-200 min-h-[400px] flex items-center justify-center">
                        <!-- Dynamic Diagram Container -->
                        <div id="flow-diagram" class="w-full max-w-3xl relative">
                            <!-- Nodes and Lines injected by JS based on mode -->
                        </div>
                    </div>

                    <div id="flow-desc" class="mt-6 p-4 bg-blue-50 border border-blue-100 text-blue-800 rounded-lg text-sm">
                        <!-- Dynamic Description -->
                    </div>
                </div>
                    `;
            setTimeout(() => setReportMode('routine'), 0); // Init
        }

        function setReportMode(mode) {
            const diagram = document.getElementById('flow-diagram');
            const desc = document.getElementById('flow-desc');
            const btnRoutine = document.getElementById('btn-routine');
            const btnTf = document.getElementById('btn-tf');

            // Button Styles
            if (mode === 'routine') {
                btnRoutine.className = "px-4 py-2 rounded bg-blue-600 text-white font-bold shadow-md";
                btnTf.className = "px-4 py-2 rounded bg-stone-100 text-stone-400 font-bold hover:bg-red-50 hover:text-red-600 transition";

                desc.innerHTML = `
                    <strong class="block mb-1" >?ü¢ Track A: ?ºÎ∞ò ?¥ÏòÅ(Maintenance)</strong >
                        Î™®Îì† ?ºÏÉÅ ?ÖÎ¨¥(Í∑ºÌÉú, ?úÏÑ§, ?ïÏÇ∞, ?ÅÎã¥)??<strong > Î∞òÎìú???§Ïû•??Í≤ΩÏú†</strong > ?©Îãà???§Ïû•??1Ï∞??¥Í≤∞(?ÑÍ≤∞)?òÍ≥† Ï§ëÏöî ?¨Ìï≠Îß??îÏïΩ?òÏó¨ Î∂Ä?êÏû•?êÍ≤å Î≥¥Í≥†?©Îãà??
                `;

                diagram.innerHTML = `
                            <div class="flex flex-col items-center space-y-8" >
                        <div class="w-full flex justify-center">
                            <div class="bg-slate-800 text-white px-8 py-3 rounded-lg shadow-lg z-10">Ï¥ùÍ¥Ñ Î∂Ä?êÏû• (ÏµúÏ¢Ö ?πÏù∏)</div>
                        </div>
                        <div class="h-12 w-0.5 bg-blue-400"></div> <!--Line -->
                        <div class="w-full flex justify-center">
                            <div class="bg-white border-2 border-blue-500 text-slate-800 px-8 py-3 rounded-lg shadow-md z-10 font-bold">?¥ÏòÅ ?§Ïû• (1Ï∞??¥Í≤∞/Ï∑®Ìï©)</div>
                        </div>
                        <div class="h-12 w-0.5 bg-blue-400"></div> <!--Line -->
                    <div class="w-full flex justify-center space-x-4">
                        <div class="bg-white border border-stone-300 px-4 py-2 rounded text-stone-600 text-sm">?ÄÎ¶???</div>
                        <div class="bg-white border border-stone-300 px-4 py-2 rounded text-stone-600 text-sm">?ÄÎ¶???</div>
                        <div class="bg-white border border-stone-300 px-4 py-2 rounded text-stone-600 text-sm">Ï£ºÏûÑ(??</div>
                    </div>
                    </div>
                    <!--Animation Effect-- >
                    <div class="absolute top-0 bottom-0 left-1/2 w-full transform -translate-x-1/2 pointer-events-none">
                        <div class="absolute bottom-10 left-1/2 w-2 h-2 bg-blue-500 rounded-full animate-ping"></div>
                        <div class="absolute top-1/2 left-1/2 w-2 h-2 bg-blue-500 rounded-full animate-ping" style="animation-delay: 0.5s"></div>
                    </div>
                `;

            } else {
                btnRoutine.className = "px-4 py-2 rounded bg-stone-100 text-stone-400 font-bold hover:bg-blue-50 hover:text-blue-600 transition";
                btnTf.className = "px-4 py-2 rounded bg-red-600 text-white font-bold shadow-md";

                desc.innerHTML = `
                    <strong class="block mb-1" >?î¥ Track B: Í∏∞Ìöç / ?ÅÏã†(Innovation)</strong >
                        ?àÎ°ú???ÑÎ°ú?ùÌä∏(?πÍ∞ï, ÎßàÏ????ÑÎûµ)???çÎèÑÎ•??ÑÌï¥ <strong > TF?Ä??Î∂Ä?êÏû•?êÍ≤å ÏßÅÎ≥¥</strong > ?©Îãà???? ?§Ïû•?êÍ≤å??'?ºÏ†ï'??Í≥µÏú†(Ï∞∏Ï°∞)?òÏó¨ ?ÖÎ¨¥ Ï∂©Îèå??Î∞©Ï??©Îãà??
                `;

                diagram.innerHTML = `
                            <div class="flex flex-col items-center relative h-[300px]" >
                        <!--Vice Director-- >
                        <div class="absolute top-0 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-8 py-3 rounded-lg shadow-lg z-20">Ï¥ùÍ¥Ñ Î∂Ä?êÏû• (Í∏∞Ìöç Ï¥ùÍ¥Ñ)</div>
                        
                        <!--Direct Line(Red)-- >
                        <div class="absolute top-10 left-1/2 h-[200px] w-0.5 bg-red-400 transform -translate-x-1/2 z-0"></div>
                        
                        <!--TF Team-- >
                        <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 w-64 bg-red-50 border-2 border-red-500 p-4 rounded-lg text-center z-10 shadow-md">
                            <p class="font-bold text-red-700 mb-1">TF?Ä (Í∏∞Ìöç/?ÑÎûµ)</p>
                            <div class="flex justify-center space-x-2 text-xs text-red-600">
                                <span>?ÄÎ¶?Í∏∞Ìöç)</span><span>Ï£ºÏûÑ(?çÎ≥¥)</span>
                            </div>
                        </div>

                        <!--Manager(Side Observer) -->
                        <div class="absolute top-1/2 right-0 transform translate-x-[-20%] bg-stone-100 border border-stone-300 text-stone-400 px-4 py-2 rounded-lg border-dashed">
                            <span class="text-xs font-bold block">?¥ÏòÅ ?§Ïû•</span>
                            <span class="text-[10px]">(?ºÏ†ï Ï∞∏Ï°∞ / Í≥µÏú†)</span>
                        </div>
                        
                        <!--Dotted Line to Manager-- >
                    <div class="absolute top-[60%] left-1/2 w-[30%] border-t-2 border-dashed border-stone-300 transform"></div>
                    </div>
                    `;
            }
        }

        // --- Shifts View ---
        function renderShifts(container) {
            container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8" >
                    <!--Daily Rotation Chart-- >
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">??3ÍµêÎ? Í∑ºÎ¨¥ ?úÏä§??/h2>
                        <div class="chart-container">
                            <canvas id="shiftChart"></canvas>
                        </div>
                        <ul class="mt-4 space-y-2 text-sm text-stone-600">
                            <li><strong>?åÖ ?àÎ≤ΩÏ°?(1Î™?:</strong> 5Ï£?Í∞ÑÍ≤© Î°úÌÖå?¥ÏÖò (Î∂Ä?êÏû• ?¨Ìï®). Î¨?Í∞úÎ∞©, ?ÑÏπ® Î™®ÏùòÍ≥†ÏÇ¨ ?∏ÏáÑ.</li>
                            <li><strong>?ÄÔ∏??ÑÏπ®Ï°?(2Î™?:</strong> ?âÏ†ï ÎßàÍ∞ê, ?ºÌÅ¨?Ä???ÅÎã¥.</li>
                            <li><strong>?åô ?§ÌõÑÏ°?(2Î™?:</strong> <span class="text-red-600 font-bold">?∏Ïßë ?ôÎ†®???ÑÏ∞∏.</span> ?ºÍ∞Ñ ?òÏóÖ Î∞??µÏùº Î™®ÏùòÍ≥†ÏÇ¨ ?∏Ïßë.</li>
                        </ul>
                    </div>

                    <!--Seasonal TF-- >
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">?ö® ?úÏ¶å??ÎπÑÏÉÅ Í∑ºÎ¨¥ (TF)</h2>
                        <div class="space-y-4">
                            <div class="bg-red-50 border-l-4 border-red-500 p-4">
                                <h3 class="font-bold text-red-800">Î¨∏Ï†ú?Ä???úÏ¶å (9Ï£ºÍ∞Ñ)</h3>
                                <p class="text-sm text-red-600 mt-1">??ÏßÅÏõê??Î™®ÏùòÍ≥†ÏÇ¨ ?∏Ïßë ?îÏõê?ºÎ°ú ?¨ÏûÖ?©Îãà??</p>
                            </div>

                            <div class="grid grid-cols-1 gap-2">
                                <div class="flex items-center justify-between bg-white border border-stone-200 p-2 rounded">
                                    <span class="text-sm font-bold">?ïÏÇ¨Î≤?/span>
                                    <span class="text-xs bg-slate-100 px-2 py-1 rounded">?§Ïû• (?úÏù¥??ÏµúÏÉÅ)</span>
                                </div>
                                <div class="flex items-center justify-between bg-white border border-stone-200 p-2 rounded">
                                    <span class="text-sm font-bold">Í≤ΩÏ∞∞??/span>
                                    <span class="text-xs bg-slate-100 px-2 py-1 rounded">?ÄÎ¶??? (Î∂ÑÎüâ ÎßéÏùå)</span>
                                </div>
                                <div class="flex items-center justify-between bg-white border border-stone-200 p-2 rounded">
                                    <span class="text-sm font-bold">?åÎ≤ï</span>
                                    <span class="text-xs bg-slate-100 px-2 py-1 rounded">?ÄÎ¶??? (ÍººÍºº??</span>
                                </div>
                                <div class="flex items-center justify-between bg-white border border-stone-200 p-2 rounded">
                                    <span class="text-sm font-bold">Î≤îÏ£Ñ??Í∏∞Ì?</span>
                                    <span class="text-xs bg-slate-100 px-2 py-1 rounded">Ï£ºÏûÑ(?? (ÎßàÏ???Î≥ëÌñâ)</span>
                                </div>
                                <div class="flex items-center justify-between bg-slate-800 text-white p-2 rounded">
                                    <span class="text-sm font-bold">ÏµúÏ¢Ö Í≤Ä??(QC)</span>
                                    <span class="text-xs bg-slate-600 px-2 py-1 rounded">Î∂Ä?êÏû•</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                    `;
            setTimeout(initShiftChart, 100);
        }

        function initShiftChart() {
            const canvas = document.getElementById('shiftChart');

            // Null check - if canvas doesn't exist, return early
            if (!canvas) {
                console.warn('Shift chart canvas not found in DOM');
                return;
            }

            const ctx = canvas.getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['?àÎ≤ΩÏ°?(07:30)', '?ÑÏπ®Ï°?(08:30)', '?§ÌõÑÏ°?(13:30)'],
                    datasets: [{
                        data: [1, 2, 2],
                        backgroundColor: ['#f59e0b', '#3b82f6', '#1e293b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        // --- NEW: Utilities View ---
        function renderUtility(container) {
            container.innerHTML = `
                    <div class="bg-white p-8 rounded-lg shadow-sm border border-stone-200" >
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">?õ†Ô∏??§Î¨¥ ?†Ìã∏Î¶¨Ìã∞ (Execution Tools)</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-4 gap-6">
                        <!-- 1. Daily Routine Generator -->
                        <div class="bg-stone-50 p-5 rounded-lg border border-stone-200 flex flex-col">
                            <h3 class="font-bold text-base mb-3 text-emerald-700 flex items-center">
                                <span class="text-xl mr-2">??/span> ?ºÏùº Î£®Ìã¥ Ï≤¥ÌÅ¨Î¶¨Ïä§??
                            </h3>
                            <div class="space-y-3 flex-grow">
                                <div>
                                    <label class="block text-xs font-bold text-stone-600 uppercase mb-1">Í∑ºÎ¨¥Ï°?/label>
                                    <select id="routine-shift" class="w-full p-2 border border-stone-300 rounded text-xs">
                                        <option value="dawn">?åÖ ?àÎ≤ΩÏ°?(07:30)</option>
                                        <option value="morning">?ÄÔ∏??ÑÏπ®Ï°?(08:30)</option>
                                        <option value="afternoon">?åô ?§ÌõÑÏ°?(13:30)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-stone-600 uppercase mb-1">ÏßÅÏ±Ö</label>
                                    <select id="routine-role" class="w-full p-2 border border-stone-300 rounded text-xs">
                                        <option value="head">?§Ïû•</option>
                                        <option value="manager_m">?ÄÎ¶???</option>
                                        <option value="manager_f">?ÄÎ¶???</option>
                                        <option value="chief">Ï£ºÏûÑ(??</option>
                                    </select>
                                </div>
                                <button onclick="generateRoutine()" class="w-full bg-emerald-600 text-white py-2 rounded font-bold hover:bg-emerald-700 transition text-xs">?ùÏÑ±</button>
                            </div>
                            <div id="routine-output" class="mt-3 hidden bg-white border border-stone-200 rounded p-3 text-xs max-h-40 overflow-y-auto"></div>
                        </div>

                        <!-- 2. Goal Tracker -->
                        <div class="bg-stone-50 p-5 rounded-lg border border-stone-200 flex flex-col">
                            <h3 class="font-bold text-base mb-3 text-blue-700 flex items-center">
                                <span class="text-xl mr-2">?ìà</span> Î™©Ìëú ?¨ÏÑ± ?úÎ??àÏù¥??
                            </h3>
                            <div class="space-y-2 flex-grow">
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-[10px] font-bold text-stone-600 uppercase">Î™©Ìëú(ÎßåÏõê)</label>
                                        <input type="number" id="goal-total" value="5000" class="w-full p-1.5 border border-stone-300 rounded text-xs">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-stone-600 uppercase">?ÑÏû¨(ÎßåÏõê)</label>
                                        <input type="number" id="goal-current" value="3200" class="w-full p-1.5 border border-stone-300 rounded text-xs">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-[10px] font-bold text-stone-600 uppercase">?®Ï??ºÏàò</label>
                                        <input type="number" id="goal-days" value="10" class="w-full p-1.5 border border-stone-300 rounded text-xs">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-bold text-stone-600 uppercase">Í∞ùÎã®Í∞Ä</label>
                                        <input type="number" id="goal-price" value="50" class="w-full p-1.5 border border-stone-300 rounded text-xs">
                                    </div>
                                </div>
                                <button onclick="calculateGoal()" class="w-full bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700 transition text-xs mt-1">Í≥ÑÏÇ∞</button>
                            </div>
                            <div id="goal-result" class="mt-3 hidden p-2 bg-blue-50 border border-blue-200 rounded text-center text-xs"></div>
                        </div>

                        <!-- 3. D-Day Scheduler -->
                        <div class="bg-stone-50 p-5 rounded-lg border border-stone-200 flex flex-col">
                            <h3 class="font-bold text-base mb-3 text-rose-700 flex items-center">
                                <span class="text-xl mr-2">?ìÖ</span> ?âÏÇ¨ Ï§ÄÎπ???Ç∞Í∏?
                            </h3>
                            <div class="space-y-3 flex-grow">
                                <div>
                                    <label class="block text-xs font-bold text-stone-600 uppercase mb-1">?âÏÇ¨Î™?/label>
                                    <input type="text" id="event-name" placeholder="?? ?∏Î®∏?§Ïø®" class="w-full p-2 border border-stone-300 rounded text-xs">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-stone-600 uppercase mb-1">D-Day</label>
                                    <input type="date" id="event-date" class="w-full p-2 border border-stone-300 rounded text-xs">
                                </div>
                                <button onclick="calculateDDay()" class="w-full bg-rose-600 text-white py-2 rounded font-bold hover:bg-rose-700 transition text-xs">?§Ï?Ï§??ùÏÑ±</button>
                            </div>
                            <div id="dday-result" class="mt-3 hidden p-2 bg-white border border-stone-200 rounded text-xs max-h-40 overflow-y-auto"></div>
                        </div>

                        <!-- 4. NEW: Marketing Action Planner -->
                        <div class="bg-stone-50 p-5 rounded-lg border border-stone-200 flex flex-col">
                            <h3 class="font-bold text-base mb-3 text-purple-700 flex items-center">
                                <span class="text-xl mr-2">?ì¢</span> ÎßàÏ????§Î¨¥ Ï≤¥ÌÅ¨Î¶¨Ïä§??
                            </h3>
                            <p class="text-[10px] text-stone-500 mb-3">ÎßàÏ????¥Îãπ?êÏóêÍ≤?"?¥Í≤ÉÎß????ºÍ≥† Ï§????àÎäî Íµ¨Ï≤¥?ÅÏù∏ ???ºÏùÑ ?ùÏÑ±?©Îãà??</p>
                            <div class="space-y-3 flex-grow">
                                <div>
                                    <label class="block text-xs font-bold text-stone-600 uppercase mb-1">?ÑÏû¨ ?úÏ¶å</label>
                                    <select id="mkt-season" class="w-full p-2 border border-stone-300 rounded text-xs">
                                        <option value="normal">?å± ?âÏàòÍ∏?(Î∏åÎûú??Í¥ÄÎ¶?</option>
                                        <option value="recruitment">?î• Î™®ÏßëÍ∏?(Í∞úÍ∞ï/?πÍ∞ï)</option>
                                        <option value="exam">?ö® ?úÌóòÏßÅÏ†Ñ (?ëÏõê/?ÅÏ§ë)</option>
                                    </select>
                                </div>
                                <button onclick="generateMarketingPlan()" class="w-full bg-purple-600 text-white py-2 rounded font-bold hover:bg-purple-700 transition text-xs">?ÖÎ¨¥ Î¶¨Ïä§???ùÏÑ±</button>
                            </div>
                            <div id="mkt-result" class="mt-3 hidden bg-white border border-stone-200 rounded p-3 text-xs max-h-40 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>
                    `;
        }

        // ... existing generateRoutine, calculateGoal, calculateDDay functions ...

        function generateRoutine() {
            const shift = document.getElementById('routine-shift').value;
            const role = document.getElementById('routine-role').value;
            const output = document.getElementById('routine-output');

            let tasks = [];

            // Common Shift Tasks
            if (shift === 'dawn') {
                tasks.push({ time: '07:30', task: '?ôÏõê ?ÑÏ≤¥ Î¨?Í∞úÎ∞© Î∞??åÎì± ?¥Ï†ú' });
                tasks.push({ time: '07:35', task: '?âÎÇúÎ∞©Í∏∞ Í∞Ä??Î∞??òÍ∏∞' });
                tasks.push({ time: '07:40', task: '?ÑÏπ® Î™®ÏùòÍ≥†ÏÇ¨ ?∏ÏáÑ Î∞?Î∂ÑÎ•ò (?ÑÎÇ† ?∏ÏßëÎ≥?' });
                tasks.push({ time: '08:00', task: 'Í∞ïÏùò???ÖÏã§ Î∞??úÌóòÏßÄ Î∞∞Î?' });
            } else if (shift === 'morning') {
                tasks.push({ time: '08:30', task: '?∞Ïä§???∏Ïàò?∏Í≥Ñ ?¨Ìï≠ ?ïÏù∏' });
                tasks.push({ time: '09:00', task: '?ÑÏùº Îß§Ï∂ú ÏßëÍ≥Ñ ?ïÏù∏ Î∞??úÏû¨ ?êÍ?' });
                tasks.push({ time: '10:00', task: '?§Ï†Ñ ?ÑÌôî ?ëÎ? Î∞?Î∂Ä?¨Ï§ë ÏΩúÎ∞±' });
            } else if (shift === 'afternoon') {
                tasks.push({ time: '13:30', task: '?§ÌõÑ ?∞Ïä§??ÍµêÎ? Î∞??πÏù¥?¨Ìï≠ Ï≤¥ÌÅ¨' });
                tasks.push({ time: '18:00', task: '?Ä???¨ÌôîÍ∞ïÏùò???∏ÌåÖ (ÎßàÏù¥??Î∂ÑÌïÑ/Î¨?' });
                tasks.push({ time: '19:00', task: '?î¥ [?ÑÏàò] ?µÏùº ?ÑÏπ® Î™®ÏùòÍ≥†ÏÇ¨ ?∏Ïßë Î∞?Í≤Ä?? });
                tasks.push({ time: '21:30', task: '?ºÏùº Îß§Ï∂ú ÎßàÍ∞ê Î∞??åÎì±/Î¨∏Îã®?? });
            }

            // Role Specific Additions
            if (role === 'head') {
                if (shift === 'morning') tasks.push({ time: '11:00', task: 'ÏßÅÏõê Í∑ºÌÉú ?ïÏù∏ Î∞??ÖÎ¨¥ ÏßÄ?? });
                tasks.push({ time: '?ÅÏãú', task: '?ÅÎã¥ Ï¥ùÍ¥Ñ Î∞?ÎØºÏõê 1Ï∞??¥Í≤∞' });
            } else if (role === 'manager_m') {
                tasks.push({ time: '?ÅÏãú', task: 'Í∞ïÏùò???ÖÏÑú???úÏÑ§ ?úÏ∞∞ Î∞??òÎ¶¨' });
                if (shift === 'afternoon') tasks.push({ time: '20:00', task: 'ÍµêÏû¨ ?ùÎ∞∞ Î∞úÏÜ° ÎßàÍ∞ê' });
            } else if (role === 'manager_f') {
                if (shift === 'morning') tasks.push({ time: '14:00', task: '?Ä???ÖÎ¨¥ Î∞??åÍ≥Ñ ?ïÎ¶¨' });
                tasks.push({ time: '?ÅÏãú', task: '?©Í≤©???∞Ïù¥???ïÎ¶¨ Î∞?Í∞ïÏÇ¨ ?òÏ†Ñ' });
            } else if (role === 'chief') {
                if (shift === 'afternoon') tasks.push({ time: '14:00', task: 'ÎßàÏ????∏Ï£º ?ÖÏ≤¥ ?åÏä§ ?ÑÏÜ°' });
                tasks.push({ time: '?ÅÏãú', task: '?ÖÏÑú???¨Î¨º???ëÏàò ?Ä??Í¥ÄÎ¶? });
            }

            // Sort by time (simple sort)
            tasks.sort((a, b) => a.time.localeCompare(b.time));

            // Render
            output.innerHTML = `<ul class="space-y-2" > ` +
                tasks.map(t => `
                    <li class="flex items-start text-xs text-stone-700" >
                        <input type="checkbox" class="mt-0.5 mr-2">
                            <span><strong class="text-slate-800">[${t.time}]</strong> ${t.task}</span>
                        </li>
                `).join('') + `</ul > `;
            output.classList.remove('hidden');
        }

        function calculateGoal() {
            const goal = parseInt(document.getElementById('goal-total').value);
            const current = parseInt(document.getElementById('goal-current').value);
            const days = parseInt(document.getElementById('goal-days').value);
            const price = parseInt(document.getElementById('goal-price').value);
            const res = document.getElementById('goal-result');

            if (days <= 0) {
                res.innerHTML = "?®Ï? ?ºÏàòÎ•??ïÏù∏?¥Ï£º?∏Ïöî.";
                res.classList.remove('hidden');
                return;
            }

            const remainingAmount = goal - current;
            const dailyAmount = Math.ceil(remainingAmount / days);
            const dailyCount = Math.ceil(dailyAmount / price);

            let messageClass = "text-blue-800";
            let message = "";

            if (remainingAmount <= 0) {
                message = "?éâ ?¥Î? Î™©ÌëúÎ•??¨ÏÑ±?àÏäµ?àÎã§! Ï¥àÍ≥º ?¨ÏÑ±???ÑÏ†Ñ?òÏÑ∏??";
                messageClass = "text-green-700 font-bold";
            } else {
                message = `
                    <div class="text-xs text-blue-600 mb-1" > Î™©ÌëúÍπåÏ? <strong class="text-red-600" > ${remainingAmount.toLocaleString()}ÎßåÏõê</strong > ?®Ïïò?µÎãà??</div>
                    <div class="text-lg font-bold text-slate-800 mb-1">?§Îäò Î™©Ìëú: ${dailyAmount.toLocaleString()} ÎßåÏõê</div>
                    <div class="bg-white rounded p-1 mt-1 border border-blue-200">
                        ?ëâ ?§Îäò <strong class="text-red-600 text-lg">${dailyCount}Î™?/strong>Îß??±Î°ù?úÌÇ§Î©??©Îãà??
                    </div>
                `;
            }

            res.innerHTML = message;
            res.className = `mt - 3 p - 3 rounded text - center border ${remainingAmount <= 0 ? 'bg-green-50 border-green-200' : 'bg-blue-50 border-blue-200'} `;
            res.classList.remove('hidden');
        }

        function calculateDDay() {
            const name = document.getElementById('event-name').value;
            const dateVal = document.getElementById('event-date').value;
            const res = document.getElementById('dday-result');

            if (!name || !dateVal) {
                res.innerText = "?âÏÇ¨Î™ÖÍ≥º ?†ÏßúÎ•??ÖÎ†•?¥Ï£º?∏Ïöî.";
                res.classList.remove('hidden');
                return;
            }

            const dday = new Date(dateVal);

            // Helper to subtract days
            const subDays = (d, days) => {
                const newDate = new Date(d);
                newDate.setDate(d.getDate() - days);
                return newDate.toISOString().split('T')[0];
            };

            const schedule = [
                { d: 'D-30', date: subDays(dday, 30), task: 'Í∏∞Ìöç???ïÏ†ï Î∞?TF?Ä Î∞úÏ°±', owner: 'Î∂Ä?êÏû•' },
                { d: 'D-21', date: subDays(dday, 21), task: '?àÌéò?¥Ï? Î∞∞ÎÑà Î∞?Î∏îÎ°úÍ∑??çÎ≥¥ ?úÏûë', owner: 'Ï£ºÏûÑ(??' },
                { d: 'D-14', date: subDays(dday, 14), task: 'ÍµêÏû¨ Ï£ºÎ¨∏ Î∞?Î¨∏Ïûê Î∞úÏÜ°(1Ï∞?', owner: '?§Ïû•/?ÄÎ¶???' },
                { d: 'D-7', date: subDays(dday, 7), task: '?úÏÑ§ ?êÍ? Î∞??†Ï≤≠??Ï§ëÍ∞Ñ ÏßëÍ≥Ñ', owner: '?§Ïû•' },
                { d: 'D-1', date: subDays(dday, 1), task: 'ÏµúÏ¢Ö Î¶¨Îßà?∏Îìú Î¨∏Ïûê Î∞?Í∞ïÏùò???∏ÌåÖ', owner: '??ÏßÅÏõê' },
                { d: 'D-Day', date: dateVal, task: `?éâ ${name} ?πÏùº ?¥ÏòÅ`, owner: '?§Ïû• Ï¥ùÍ¥Ñ' }
            ];

            res.innerHTML = `<h4 class="font-bold text-rose-800 mb-2" > ${name} Ï§ÄÎπ??ºÏ†ï</h4 > <ul class="space-y-1 text-xs">` +
                schedule.map(s => `
                    <li class="flex justify-between items-center border-b border-stone-100 pb-1">
                        <div>
                            <span class="font-bold text-rose-600 w-10 inline-block">${s.d}</span>
                            <span class="text-stone-500 text-[10px] mr-1">(${s.date})</span>
                            <span class="text-stone-700">${s.task}</span>
                        </div>
                        <span class="text-[10px] bg-stone-100 px-1.5 py-0.5 rounded text-stone-500">${s.owner}</span>
                    </li>
                    `).join('') + `</ul>`;
            res.classList.remove('hidden');
        }

        function generateMarketingPlan() {
            const season = document.getElementById('mkt-season').value;
            const res = document.getElementById('mkt-result');

            let tasks = [];

            if (season === 'normal') {
                tasks = [
                    { type: 'SNS', task: '?ôÏõê ?ºÏÉÅ(Í∏âÏãù, ?êÏäµ?? ?¨ÏßÑ 3??Ï¥¨ÏòÅ ???∏Ï£º ?ÑÎã¨' },
                    { type: 'Î∞îÏù¥??, task: 'Í≤ΩÏãúÎ™?Í≤ΩÍøà??"ÏßÄ??Í≤ΩÏ∞∞?ôÏõê" ?§Ïõå??Í≤Ä??Î∞??¨Î°† Ï≤¥ÌÅ¨ (Ï£?3??' },
                    { type: 'ÏΩòÌÖêÏ∏?, task: '?©Í≤©???¨Ïõê???∏ÌÑ∞Î∑?1Î™?ÏßÑÌñâ (?©Í≤©?òÍ∏∞ ?åÏä§ ?ïÎ≥¥)' },
                    { type: 'DB', task: 'ÎØ∏Îì±Î°??ÅÎã¥???àÎ? Î¨∏Ïûê Î∞úÏÜ° (Î¨¥Î£å ?πÍ∞ï ÎØ∏ÎÅº ?¨Ï≤ô)' }
                ];
            } else if (season === 'recruitment') {
                tasks = [
                    { type: 'SNS', task: 'Í∞úÍ∞ï D-Day Ïπ¥Ïö¥?∏Îã§??Ïπ¥Îìú?¥Ïä§ ?úÏûë ?îÏ≤≠ (?îÏûê?¥ÎÑà?êÍ≤å)' },
                    { type: 'Î∞îÏù¥??, task: 'Ï£ºÏöî Ïª§Î??àÌã∞ "?òÍ∞ïÎ£??úÍ∞Ñ?? ÏßàÎ¨∏Í∏Ä??Ï™ΩÏ?/?ìÍ? ?ëÏóÖ' },
                    { type: 'Î¨∏Ïûê', task: 'Í∏∞Ï°¥ DB ?Ä??"Ï°∞Í∏∞?±Î°ù ?†Ïù∏ ÎßàÍ∞ê?ÑÎ∞ï" ?ÑÏ≤¥ Î¨∏Ïûê Î∞úÏÜ°' },
                    { type: '?ÑÏû•', task: '?êÎÇ¥ Í≤åÏãú??Î∞?Î∞∞ÎÑà "ÎßàÍ∞ê?ÑÎ∞ï" ?±Ï? Î∂ÄÏ∞? }
                ];
            } else if (season === 'exam') {
                tasks = [
                    { type: 'ÏΩòÌÖêÏ∏?, task: 'Í∞ïÏÇ¨??"?åÏù¥??Ï∞çÍ∏∞" ?èÌèº ?ÅÏÉÅ Ï¥¨ÏòÅ (?∞ÏúºÎ°?1Î∂?Ïª?' },
                    { type: 'SNS', task: '?úÌóò ?ëÏõê Í∞ÑÏãù ?¥Î≤§??Í≥µÏ? ?¨Î¶¨Í∏? },
                    { type: 'Î∞îÏù¥??, task: '?úÌóò ÏßÅÌõÑ "Í∞Ä?µÏïà/?¥ÏÑ§Í∞ïÏùò" ?∞Î¶¨ ?ôÏõê???úÏùº Îπ†Î•¥?§Í≥† ?çÎ≥¥' },
                    { type: 'DB', task: '?úÌóò???ëÏõê Ï∫†Ìéò??Î¨∏Ïûê Î∞úÏÜ°' }
                ];
            }

            res.innerHTML = `<ul class="space-y-2" > ` +
                tasks.map(t => `
                    <li class="flex items-start" >
                        <span class="inline-block px-1.5 py-0.5 rounded bg-purple-100 text-purple-800 font-bold mr-2 text-[10px] w-12 text-center flex-shrink-0">${t.type}</span>
                        <span class="text-stone-700">${t.task}</span>
                    </li >
                    `).join('') + `</ul > `;
            res.classList.remove('hidden');
        }

        // --- Toolkit View (Updated with AI & Feedback) ---
        function renderToolkit(container) {
            container.innerHTML = `
                        <div class="bg-white p-8 rounded-lg shadow-sm border border-stone-200" >
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">?ß† ?§Îßà???ÖÎ¨¥ ?¥Í≤∞ ?åÍ≥†Î¶¨Ï¶ò</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6 mb-8">
                        <!-- Fogg Model Input -->
                        <div class="bg-stone-50 p-6 rounded-lg border border-stone-200 flex flex-col h-full">
                            <h3 class="font-bold text-lg mb-4 text-indigo-700">?¨Í∑∏ ?âÎèô Î™®Îç∏ (?±Î°ù ?†ÎèÑ)</h3>
                            <p class="text-sm text-stone-500 mb-4">?ôÏÉù ?±Î°ù ?†ÎèÑ Î¨∏Ïûê???ÅÎã¥ Î©òÌä∏Í∞Ä ÎßâÌûê ???¨Ïö©?òÏÑ∏??</p>
                            <div class="space-y-3 flex-grow">
                                <div>
                                    <label class="block text-xs font-bold text-stone-600 uppercase">?ÄÍ≤??ÅÌô© (Target)</label>
                                    <input type="text" id="fogg-target" placeholder="?? ?§Î™Ö??Ï∞∏ÏÑù ??ÎØ∏Îì±Î°??ôÏÉù" class="w-full p-2 border border-stone-300 rounded text-sm">
                                </div>
                                <button onclick="solveFoggWithAI()" class="w-full bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-700 transition flex justify-center items-center">
                                    <span id="fogg-loading" class="ai-loading hidden mr-2"></span>
                                    <span>??AI Î¨∏Ïûê ?ùÏÑ±</span>
                                </button>
                            </div>
                            <div id="fogg-result" class="mt-4 text-sm font-medium text-indigo-800 hidden bg-indigo-50 p-4 rounded border border-indigo-100 leading-relaxed whitespace-pre-wrap"></div>
                        </div>

                        <!-- 5 Whys Input -->
                        <div class="bg-stone-50 p-6 rounded-lg border border-stone-200 flex flex-col h-full">
                            <h3 class="font-bold text-lg mb-4 text-teal-700">5 Whys (Í∑ºÎ≥∏ ?êÏù∏ Î∂ÑÏÑù)</h3>
                            <p class="text-sm text-stone-500 mb-4">Î∞òÎ≥µ?òÎäî Î¨∏Ï†ú??ÏßÑÏßú ?êÏù∏Í≥??¥Í≤∞Ï±ÖÏùÑ Î∂ÑÏÑù?©Îãà??</p>
                            <div class="space-y-3 flex-grow">
                                <div>
                                    <label class="block text-xs font-bold text-stone-600 uppercase">Î∞úÏÉù??Î¨∏Ï†ú</label>
                                    <input type="text" id="why-problem" placeholder="?? Îß§Ï£º ?îÏöî??ÏßÄÍ∞ÅÏÉù ??¶ù" class="w-full p-2 border border-stone-300 rounded text-sm">
                                </div>
                                <button onclick="solveWhyWithAI()" class="w-full bg-teal-600 text-white py-2 rounded font-bold hover:bg-teal-700 transition flex justify-center items-center">
                                    <span id="why-loading" class="ai-loading hidden mr-2"></span>
                                    <span>??AI ?¨Ï∏µ Î∂ÑÏÑù</span>
                                </button>
                            </div>
                            <div id="why-result" class="mt-4 text-sm text-teal-800 hidden bg-teal-50 p-4 rounded border border-teal-100 leading-relaxed whitespace-pre-wrap"></div>
                        </div>

                        <!-- Counseling Script Generator -->
                        <div class="bg-rose-50 p-6 rounded-lg border border-rose-200 flex flex-col h-full">
                            <h3 class="font-bold text-lg mb-4 text-rose-700">?õ°Ô∏??ÅÎã¥ Î∞©Ïñ¥ ?§ÌÅ¨Î¶ΩÌä∏</h3>
                            <p class="text-sm text-stone-500 mb-4">?òÎ∂à, Ïª¥Ìîå?àÏù∏ ??ÍπåÎã§Î°úÏö¥ ?ÅÌô©???Ä???ÄÎ≥∏ÏùÑ ?ùÏÑ±?©Îãà??</p>
                            <div class="space-y-3 flex-grow">
                                <div>
                                    <label class="block text-xs font-bold text-stone-600 uppercase">ÎØºÏõê ?¥Ïö©</label>
                                    <input type="text" id="script-target" placeholder="?? ?ÑÏï° ?òÎ∂à ?îÍµ¨?òÎ©∞ Í≥†ÏÑ±" class="w-full p-2 border border-stone-300 rounded text-sm">
                                </div>
                                <button onclick="generateScriptWithAI()" class="w-full bg-rose-600 text-white py-2 rounded font-bold hover:bg-rose-700 transition flex justify-center items-center">
                                    <span id="script-loading" class="ai-loading hidden mr-2"></span>
                                    <span>??AI ?ÄÎ≥??ùÏÑ±</span>
                                </button>
                            </div>
                            <div id="script-result" class="mt-4 text-sm font-medium text-rose-800 hidden bg-rose-50 p-4 rounded border border-rose-100 leading-relaxed whitespace-pre-wrap"></div>
                        </div>

                        <!-- NEW: Staff Feedback Coach -->
                        <div class="bg-amber-50 p-6 rounded-lg border border-amber-200 flex flex-col h-full">
                            <h3 class="font-bold text-lg mb-4 text-amber-700">?íå ÏßÅÏõê ?ºÎìúÎ∞?ÏΩîÏπ≠</h3>
                            <p class="text-sm text-stone-500 mb-4">?§Ïû•?òÏù¥ ÏßÅÏõê?êÍ≤å ÏßÄ?ÅÌïòÍ±∞ÎÇò Ïπ?∞¨??????Î©òÌä∏Î•?ÎßåÎì§?¥Ï§ç?àÎã§.</p>
                            <div class="space-y-3 flex-grow">
                                <div>
                                    <label class="block text-xs font-bold text-stone-600 uppercase">?ÅÌô© Î∞??Ä??/label>
                                    <input type="text" id="feedback-target" placeholder="?? ÍπÄ?ÄÎ¶?3???∞ÏÜç ÏßÄÍ∞? class="w-full p-2 border border-stone-300 rounded text-sm">
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="generateFeedbackWithAI('scold')" class="flex-1 bg-amber-600 text-white py-2 rounded font-bold hover:bg-amber-700 transition text-xs">Î∂Ä?úÎü¨??ÏßÄ??/button>
                                    <button onclick="generateFeedbackWithAI('praise')" class="flex-1 bg-emerald-600 text-white py-2 rounded font-bold hover:bg-emerald-700 transition text-xs">?ïÏã§??Ïπ?∞¨</button>
                                </div>
                                <div id="feedback-loading" class="hidden text-center"><div class="ai-loading"></div></div>
                            </div>
                            <div id="feedback-result" class="mt-4 text-sm font-medium text-amber-900 hidden bg-amber-100 p-4 rounded border border-amber-200 leading-relaxed whitespace-pre-wrap"></div>
                        </div>
                    </div>

                    <!--1 - 3 - 1 Report Generator-- >
                    <div class="bg-slate-50 p-6 rounded-lg border border-slate-200">
                        <h3 class="font-bold text-lg mb-4 text-slate-800">?ìù 1-3-1 Î≥¥Í≥†???ùÏÑ±Í∏?/h3>
                        <p class="text-sm text-stone-500 mb-4">?§Ïû•?êÍ≤å Î∞õÏ? ?†Í≤É??Î≥¥Í≥† ?¥Ïö©???ÖÎ†•?òÎ©¥, ?Ä?úÎãòÍª?Î≥¥Í≥†?????àÎäî ÍπîÎÅî??'1-3-1 ?¨Îß∑'?ºÎ°ú Î≥Ä?òÌï¥Ï§çÎãà??</p>

                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-bold text-stone-600 uppercase">?êÎ¨∏ ?¥Ïö© (Raw Data)</label>
                                <textarea id="report-raw" rows="3" placeholder="?? ?§Îäò ÎπÑÏ????ÅÎã¥ 2Î™ÖÎ∞ñ?????îÏñ¥?? Í∑ºÎç∞ ?ÑÌôî Î¨∏Ïùò??Ï¢Ä ?àÏóàÍ≥?.." class="w-full p-2 border border-stone-300 rounded text-sm"></textarea>
                            </div>
                            <button onclick="generateReportWithAI()" class="w-full bg-slate-700 text-white py-2 rounded font-bold hover:bg-slate-800 transition flex justify-center items-center">
                                <span id="report-loading" class="ai-loading hidden mr-2"></span>
                                <span>??Î≥¥Í≥†???êÎèô ?ùÏÑ±</span>
                            </button>
                        </div>
                        <div id="report-result" class="mt-4 text-sm font-medium text-slate-800 hidden bg-white p-4 rounded border border-slate-200 leading-relaxed whitespace-pre-wrap"></div>
                    </div>
                </div>
                    `;
        }

        async function generateReportWithAI() {
            const raw = document.getElementById('report-raw').value;
            const res = document.getElementById('report-result');
            const loading = document.getElementById('report-loading');

            if (!raw) {
                res.innerText = "Î≥¥Í≥† ?¥Ïö©???ÖÎ†•?¥Ï£º?∏Ïöî.";
                res.classList.remove('hidden');
                return;
            }

            loading.classList.remove('hidden');
            res.classList.add('hidden');

            const prompt = `
                ?êÎ¨∏: ${raw}
                ?îÏ≤≠: ???¥Ïö©??Î∞îÌÉï?ºÎ°ú ?Ä?úÎãòÍª?Î≥¥Í≥†??'1-3-1 Î≥¥Í≥†??Î•??ëÏÑ±?¥Ï£º?∏Ïöî.
                    ?ïÏãù:
                1. Í≤∞Î°†(1Ï§?: ?ÑÏ≤¥ ?îÏïΩ(Í∏çÏ†ï / Î∂Ä???êÎã® ?¨Ìï®)
                2. Í∑ºÍ±∞(3Í∞ÄÏßÄ): ?òÏπò???©Ìä∏ ?ÑÏ£ºÎ°?3Í∞ÄÏßÄ ?¨Ïù∏??
                3. ?úÏïà(1Ï§?: ?•ÌõÑ Í≥ÑÌöç?¥ÎÇò ?πÏù∏ ?îÏ≤≠ ?¨Ìï≠
                ?¥Ï°∞: ?ïÏ§ë?òÍ≥† Î™ÖÌôï??Í≤ΩÏòÅÏß?Î≥¥Í≥† ??
            `;

            const aiResponse = await callGeminiAPI(prompt);

            loading.classList.add('hidden');
            res.innerHTML = aiResponse.replace(/\n/g, '<br>');
            res.classList.remove('hidden');
        }

        async function solveFoggWithAI() {
            const target = document.getElementById('fogg-target').value;
            const res = document.getElementById('fogg-result');
            const loading = document.getElementById('fogg-loading');

            if (!target) {
                res.innerText = "?ÅÌô©???ÖÎ†•?¥Ï£º?∏Ïöî.";
                res.classList.remove('hidden');
                return;
            }

            loading.classList.remove('hidden');
            res.classList.add('hidden');

            const prompt = `
                ?ÅÌô©: ${target}
                ?îÏ≤≠: ?¨Í∑∏ ?âÎèô Î™®Îç∏(Fogg Behavior Model, B = MAP)???ÅÏö©?òÏó¨ ???ôÏÉù?§Ïù¥ Ï¶âÏãú ?±Î°ù?òÎèÑÎ°??†ÎèÑ?òÎäî Î¨∏Ïûê Î©îÏãúÏßÄ(SMS) ?¥Ïö© 3Í∞ÄÏßÄ Î≤ÑÏ†Ñ???ëÏÑ±?¥Ï£º?∏Ïöî.
                1. Motivation Í∞ïÏ°∞??Í≥µÌè¨ / Í∏∞Ìöå)
                2. Ability Í∞ïÏ°∞???†Ïù∏ / ?úÌÉù)
                3. Prompt Í∞ïÏ°∞??ÎßàÍ∞ê?ÑÎ∞ï)
                Í∞?Î¨∏Íµ¨???úÍµ≠Í≤ΩÏ∞∞?ôÏõê ?§Ïû•??Î≥¥ÎÇ¥??Í≤ÉÏ≤ò???ïÏ§ë?òÎ©¥?úÎèÑ Í∞ïÎ†•?¥Ïïº ?©Îãà??
            `;

            const aiResponse = await callGeminiAPI(prompt);

            loading.classList.add('hidden');
            res.innerHTML = aiResponse.replace(/\n/g, '<br>');
            res.classList.remove('hidden');
        }

        async function solveWhyWithAI() {
            const problem = document.getElementById('why-problem').value;
            const res = document.getElementById('why-result');
            const loading = document.getElementById('why-loading');

            if (!problem) {
                res.innerText = "Î¨∏Ï†úÎ•??ÖÎ†•?¥Ï£º?∏Ïöî.";
                res.classList.remove('hidden');
                return;
            }

            loading.classList.remove('hidden');
            res.classList.add('hidden');

            const prompt = `
                Î¨∏Ï†ú: ${problem}
                ?îÏ≤≠: '5 Whys' Í∏∞Î≤ï???¨Ïö©?òÏó¨ ??Î¨∏Ï†ú??Í∑ºÎ≥∏ ?êÏù∏???åÍ≥†?úÎäî 5?®Í≥Ñ ÏßàÎ¨∏Í≥??µÎ? ?úÎÇòÎ¶¨Ïò§Î•??ëÏÑ±?òÍ≥†, ÏµúÏ¢Ö?ÅÏúºÎ°?Í∑ºÎ≥∏?ÅÏù∏ ?¥Í≤∞Ï±?Root Cause Solution)???úÏãú?¥Ï£º?∏Ïöî.?ôÏõê ?¥ÏòÅ??Í¥Ä?êÏóê??Î∂ÑÏÑù?¥Ï£º?∏Ïöî.
            `;

            const aiResponse = await callGeminiAPI(prompt);

            loading.classList.add('hidden');
            res.innerHTML = aiResponse.replace(/\n/g, '<br>');
            res.classList.remove('hidden');
        }

        async function generateScriptWithAI() {
            const target = document.getElementById('script-target').value;
            const res = document.getElementById('script-result');
            const loading = document.getElementById('script-loading');

            if (!target) {
                res.innerText = "?ÅÌô©???ÖÎ†•?¥Ï£º?∏Ïöî.";
                res.classList.remove('hidden');
                return;
            }

            loading.classList.remove('hidden');
            res.classList.add('hidden');

            const prompt = `
                ?ÅÌô©: ${target}
                ??ï†: ?úÍµ≠Í≤ΩÏ∞∞?ôÏõê ?¥ÏòÅ ?§Ïû•(10?ÑÏ∞® Î≤†ÌÖå?? ?ïÏ§ë?òÏ?Îß??®Ìò∏??
                ?îÏ≤≠: ???ÅÌô©?êÏÑú ?ôÏÉù / ?ôÎ?Î™®Î? ?ëÎ??????àÎäî '?Ä???§ÌÅ¨Î¶ΩÌä∏'Î•??ëÏÑ±?¥Ï£º?∏Ïöî.
                    ?®Í≥Ñ:
                1. Í≥µÍ∞ê Î∞?Í≤ΩÏ≤≠(?ÅÎ?Î∞???Í∞Ä?ºÏïâ?àÍ∏∞)
                2. Í∑úÏ†ï ?§Î™Ö(Í∞ùÍ????¨Ïã§ ?ÑÎã¨)
                3. ?Ä???úÏãú(?∞Î¶¨Í∞Ä ?¥Ï§Ñ ???àÎäî ÏµúÏÑ†)
                4. ÎßàÎ¨¥Î¶??¨Î∞ú Î∞©Ï? ?ΩÏÜç)
                ÎßêÌà¨: ÎπÑÏ¶à?àÏä§ Îß§ÎÑàÎ•?Í∞ñÏ∂î?? ?òÎëòÎ¶¨Ï? ?äÎäî ?ÑÎ¨∏?ÅÏù∏ ??
            `;

            const aiResponse = await callGeminiAPI(prompt);

            loading.classList.add('hidden');
            res.innerHTML = aiResponse.replace(/\n/g, '<br>');
            res.classList.remove('hidden');
        }

        async function generateFeedbackWithAI(type) {
            const target = document.getElementById('feedback-target').value;
            const res = document.getElementById('feedback-result');
            const loading = document.getElementById('feedback-loading');

            if (!target) {
                res.innerText = "?ÅÌô©???ÖÎ†•?¥Ï£º?∏Ïöî.";
                res.classList.remove('hidden');
                return;
            }

            loading.classList.remove('hidden');
            res.classList.add('hidden');

            let promptType = type === 'scold' ? 'Î∂Ä?úÎü¨?∞Î©¥?úÎèÑ ?®Ìò∏?òÍ≤å ?âÎèô ÍµêÏ†ï???îÍµ¨?òÎäî ?ºÎìúÎ∞??åÎìú?ÑÏπò ?îÎ≤ï)' : 'Íµ¨Ï≤¥?ÅÏù∏ ?¨Ïã§???§Ïñ¥ ?ôÍ∏∞Î∂Ä?¨Î? Í∑πÎ??îÌïò??Ïπ?∞¨ ?ºÎìúÎ∞?;
            const prompt = `
                ?ÅÌô©: ${target}
                ??ï†: F?±Ìñ•???¥ÏòÅ ?§Ïû•??Î∂Ä??ÏßÅÏõê?êÍ≤å ÎßêÌï®.
                    ?îÏ≤≠: ${promptType} ?§ÌÅ¨Î¶ΩÌä∏Î•??ëÏÑ±?¥Ï£º?∏Ïöî.
                        Î™©Ìëú: Í∞êÏ†ï ?ÅÌïòÏßÄ ?äÍ≤å ?òÎ©¥???âÎèô Î≥Ä?îÎ? ?¥ÎÅå?¥ÎÇ¥Í±∞ÎÇò ?¨Í∏∞Î•??íÏù¥??Í≤?
            `;

            const aiResponse = await callGeminiAPI(prompt);

            loading.classList.add('hidden');
            res.innerHTML = aiResponse.replace(/\n/g, '<br>');
            res.classList.remove('hidden');
        }

        // --- AI Copilot View (New) ---
        function renderAICopilot(container) {
            container.innerHTML = `
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200 h-[600px] flex flex-col" >
                    <div class="flex items-center justify-between border-b pb-4 mb-4">
                        <div class="flex items-center">
                            <div class="bg-indigo-600 text-white p-2 rounded-lg mr-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-slate-800">AI ?¥ÏòÅ Ïª®ÏÑ§?¥Ìä∏</h2>
                                <p class="text-xs text-stone-500">Gemini 3.0 Flash Powered ¬∑ Manual Grounded</p>
                            </div>
                        </div>
                    </div>

                    <div id="chat-messages" class="flex-grow overflow-y-auto space-y-4 mb-4 p-4 bg-stone-50 rounded-lg border border-stone-100">
                        <div class="flex items-start">
                            <div class="bg-indigo-100 text-indigo-800 p-3 rounded-lg rounded-tl-none max-w-[80%] text-sm">
                                ?àÎÖï?òÏÑ∏?? Î∂Ä?êÏû•?? <strong>?úÍµ≠Í≤ΩÏ∞∞?ôÏõê AI ?¥ÏòÅ ?åÌä∏??/strong>?ÖÎãà??<br>
                                Ï°∞ÏßÅ ?¥ÏòÅ Îß§Îâ¥?ºÏóê Í∏∞Î∞ò?òÏó¨ ?ÅÌô©Î≥??ÄÏ≤òÎ≤ï, Î≥¥Í≥† ?ºÏù∏, ÎßàÏ???Î¨∏Íµ¨ ?±ÏùÑ Ï°∞Ïñ∏???úÎ¶Ω?àÎã§.<br>
                                Î¨¥Ïóá???ÑÏ??úÎ¶¥ÍπåÏöî?
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <input type="text" id="chat-input" 
                            class="flex-grow p-3 border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            placeholder="?? '?ôÏÉù???òÎ∂à Í∑úÏ†ï??Î∂àÎßå???àÍ≥† ?åÎ¶¨Î•?ÏßÄÎ¶ÖÎãà?? ?ÑÍ? Ï≤òÎ¶¨?¥Ïïº ?òÎÇò??'"
                            onkeypress="if(event.key === 'Enter') sendChatMessage()">
                        <button onclick="sendChatMessage()" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-indigo-700 transition flex items-center">
                            ?ÑÏÜ°
                        </button>
                    </div>
                </div>
                `;
        }

        async function sendChatMessage() {
            const inputEl = document.getElementById('chat-input');
            const msgContainer = document.getElementById('chat-messages');
            const userMsg = inputEl.value.trim();

            if (!userMsg) return;

            // User Message Bubble
            const userBubble = document.createElement('div');
            userBubble.className = "flex items-center justify-end";
            userBubble.innerHTML = `<div class="bg-slate-800 text-white p-3 rounded-lg rounded-tr-none max-w-[80%] text-sm" > ${userMsg}</div> `;
            msgContainer.appendChild(userBubble);

            inputEl.value = '';
            msgContainer.scrollTop = msgContainer.scrollHeight;

            // AI Loading Bubble
            const loadingBubble = document.createElement('div');
            loadingBubble.className = "flex items-start ai-response-loading";
            loadingBubble.innerHTML = `<div class="bg-white border border-stone-200 p-3 rounded-lg rounded-tl-none" > <div class="ai-loading"></div></div> `;
            msgContainer.appendChild(loadingBubble);
            msgContainer.scrollTop = msgContainer.scrollHeight;

            // API Call
            const aiText = await callGeminiAPI(userMsg);

            // Replace Loading with Response
            msgContainer.removeChild(loadingBubble);
            const aiBubble = document.createElement('div');
            aiBubble.className = "flex items-start";
            aiBubble.innerHTML = `<div class="bg-indigo-50 border border-indigo-100 text-slate-800 p-4 rounded-lg rounded-tl-none max-w-[90%] text-sm leading-relaxed shadow-sm" > ${aiText.replace(/\n/g, '<br>')}</div>`;
            msgContainer.appendChild(aiBubble);
            msgContainer.scrollTop = msgContainer.scrollHeight;
        }

        // Initialize App
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>

</html>
